<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Proton: Surface.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />



</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Proton
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_b4959094aa2649f063000bebf8111065.html">shared</a>      </li>
      <li class="navelem"><a class="el" href="dir_faa022f782c07decbb8698e38f9d7103.html">Renderer</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">Surface.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="Surface_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include &quot;<a class="code" href="PlatformPrecomp_8h.html">PlatformPrecomp.h</a>&quot;</span>
<a name="l00002"></a>00002 <span class="preprocessor">#include &quot;<a class="code" href="Surface_8h.html">Surface.h</a>&quot;</span>
<a name="l00003"></a>00003 <span class="preprocessor">#include &quot;<a class="code" href="bitmap_8h.html">bitmap.h</a>&quot;</span>
<a name="l00004"></a>00004 <span class="preprocessor">#include &quot;<a class="code" href="BaseApp_8h.html">BaseApp.h</a>&quot;</span>
<a name="l00005"></a>00005 <span class="preprocessor">#include &quot;<a class="code" href="RTGLESExt_8h.html">RTGLESExt.h</a>&quot;</span>
<a name="l00006"></a>00006 <span class="preprocessor">#include &quot;<a class="code" href="SoftSurface_8h.html">SoftSurface.h</a>&quot;</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include &lt;cmath&gt;</span>
<a name="l00008"></a>00008 
<a name="l00009"></a>00009 <span class="preprocessor">#define GL_RGBA8 0x8058</span>
<a name="l00010"></a>00010 <span class="preprocessor"></span>
<a name="l00011"></a><a class="code" href="Surface_8cpp.html#ae5d566b86069d941bacc12c20216daad">00011</a> <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="Surface_8cpp.html#ae5d566b86069d941bacc12c20216daad">C_TEXEL_HACK_AMOUNT</a>= (0); <span class="comment">//something I was experimenting around with but didn&#39;t need</span>
<a name="l00012"></a>00012 
<a name="l00013"></a><a class="code" href="Surface_8h.html#ac9bd600d6c9bfe3f542141dd840eece7">00013</a> <a class="code" href="flash_2GLES_2gl_8h.html#a68c4714e43d8e827d80759f9cb864f3c">GLuint</a> <a class="code" href="Surface_8cpp.html#ac9bd600d6c9bfe3f542141dd840eece7">g_lastBound</a> = 0;
<a name="l00014"></a>00014 
<a name="l00015"></a><a class="code" href="classSurface.html#a8fc57f2a15292135c00545c9d224ec68">00015</a> <a class="code" href="classSurface.html#a8fc57f2a15292135c00545c9d224ec68">Surface::Surface</a>()
<a name="l00016"></a>00016 {
<a name="l00017"></a>00017         SetDefaults();
<a name="l00018"></a>00018 }
<a name="l00019"></a>00019 
<a name="l00020"></a><a class="code" href="classSurface.html#a0cc91f134e824b60cfe968848b1b770c">00020</a> <a class="code" href="classSurface.html#a8fc57f2a15292135c00545c9d224ec68">Surface::Surface</a>( <span class="keywordtype">string</span> fName )
<a name="l00021"></a>00021 {
<a name="l00022"></a>00022         SetDefaults();
<a name="l00023"></a>00023         <a class="code" href="classSurface.html#a369d5597b8378d6484809c0acad9174f">LoadFile</a>(fName);
<a name="l00024"></a>00024 }
<a name="l00025"></a>00025 
<a name="l00026"></a><a class="code" href="classSurface.html#ad5e8da65d3badbe0a077be41815ed013">00026</a> <a class="code" href="classSurface.html#a8fc57f2a15292135c00545c9d224ec68">Surface::Surface</a>( <span class="keywordtype">string</span> fName, <a class="code" href="classSurface.html#a6d321b09caff273d52719177b0c408ce" title="Type for the texture that the Surface class uses.">eTextureType</a> <a class="code" href="eglext_8h.html#a890efa53b3d7deeeced6f3a0d6653ed3">type</a> )
<a name="l00027"></a>00027 {
<a name="l00028"></a>00028         SetDefaults();
<a name="l00029"></a>00029         <a class="code" href="classSurface.html#a1c4b9b981a4131f8c94c491adc5d039b" title="Sets the texture type for this Surface.">SetTextureType</a>(type);
<a name="l00030"></a>00030         <a class="code" href="classSurface.html#a369d5597b8378d6484809c0acad9174f">LoadFile</a>(fName);
<a name="l00031"></a>00031 }
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 <span class="keywordtype">void</span> Surface::SetDefaults()
<a name="l00034"></a>00034 {
<a name="l00035"></a>00035         m_bSmoothing = <span class="keyword">true</span>;
<a name="l00036"></a>00036         m_texWidth = 0;
<a name="l00037"></a>00037         m_texHeight = 0;
<a name="l00038"></a>00038         m_memUsed = 0;
<a name="l00039"></a>00039         m_glTextureID = NO_TEXTURE_LOADED;
<a name="l00040"></a>00040         m_texType = <a class="code" href="classSurface.html#a6d321b09caff273d52719177b0c408cea296c041ee91c00e9f0b453242c8375a1" title="Linear filtering, wrap mode is repeat, uses mipmaps.">TYPE_DEFAULT</a>;
<a name="l00041"></a>00041         m_blendingMode = <a class="code" href="classSurface.html#a9157c34025ceac6c10dbbadf6796a802ac680fdcf0c36c6c0d7fa6bf682181b0d">BLENDING_NORMAL</a>;
<a name="l00042"></a>00042         m_mipMapCount = 0;
<a name="l00043"></a>00043         m_frameBuffer = 0;
<a name="l00044"></a>00044         m_originalHeight = 0; <span class="comment">//sometimes useful to know, if case we had to pad the image to be power of 2 for instance</span>
<a name="l00045"></a>00045         m_originalWidth = 0;
<a name="l00046"></a>00046         m_textureCreationMethod = <a class="code" href="classSurface.html#ac90b42370f09683473ee7dbeb0b0c8e0ae4c61725c624c4e5046156ea62f03849">TEXTURE_CREATION_NONE</a>;
<a name="l00047"></a>00047         m_bCreateMipMapsIfNeeded = <span class="keyword">false</span>;
<a name="l00048"></a>00048         m_bAddBasePath = <span class="keyword">true</span>;
<a name="l00049"></a>00049         
<a name="l00050"></a>00050 }
<a name="l00051"></a>00051 
<a name="l00052"></a><a class="code" href="classSurface.html#a89de75c95cb550d432f3ea4ed1429db0">00052</a> <a class="code" href="classSurface.html#a89de75c95cb550d432f3ea4ed1429db0">Surface::~Surface</a>()
<a name="l00053"></a>00053 {
<a name="l00054"></a>00054         <a class="code" href="classSurface.html#ab16aab697d858eaf2290856641bcc04f">Kill</a>();
<a name="l00055"></a>00055 }
<a name="l00056"></a>00056 
<a name="l00057"></a><a class="code" href="classSurface.html#ab16aab697d858eaf2290856641bcc04f">00057</a> <span class="keywordtype">void</span> <a class="code" href="classSurface.html#ab16aab697d858eaf2290856641bcc04f">Surface::Kill</a>()
<a name="l00058"></a>00058 {
<a name="l00059"></a>00059         <span class="keywordflow">if</span> (m_glTextureID != NO_TEXTURE_LOADED)
<a name="l00060"></a>00060         {
<a name="l00061"></a>00061                 <a class="code" href="GLFlashAdaptor_8cpp.html#ae1e3a2b9a9961fc34facdaf0782c51c2">glDeleteTextures</a>( 1, &amp;m_glTextureID );
<a name="l00062"></a>00062                 
<a name="l00063"></a>00063 <span class="preprocessor">#ifdef _DEBUG</span>
<a name="l00064"></a>00064 <span class="preprocessor"></span>                <span class="comment">//LogMsg(&quot;Killing texture %s&quot;, m_textureLoaded.c_str());</span>
<a name="l00065"></a>00065 <span class="preprocessor">#endif</span>
<a name="l00066"></a>00066 <span class="preprocessor"></span>                m_glTextureID = NO_TEXTURE_LOADED;
<a name="l00067"></a>00067                 <a class="code" href="BaseApp_8h.html#a72086b48d24daf0a65dd20189a16bd16">GetBaseApp</a>()-&gt;<a class="code" href="classBaseApp.html#a22b33e7c534cb862cb38a75e01b02013">ModTexUsed</a>(-m_memUsed);
<a name="l00068"></a>00068                 m_memUsed = 0;
<a name="l00069"></a>00069         }
<a name="l00070"></a>00070 }
<a name="l00071"></a>00071 
<a name="l00072"></a>00072 <span class="keywordtype">bool</span> Surface::LoadBMPTexture(<a class="code" href="PlatformSetupAndroid_8h.html#ab8ef12fab634c171394422d0ee8baf94">byte</a> *pMem)
<a name="l00073"></a>00073 {
<a name="l00074"></a>00074         <a class="code" href="structBMPImageHeader.html">BMPImageHeader</a> *pBmpImageInfo = (<a class="code" href="structBMPImageHeader.html">BMPImageHeader</a>*)&amp;pMem[14];
<a name="l00075"></a>00075 
<a name="l00076"></a>00076         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> offsetToImageData;
<a name="l00077"></a>00077         
<a name="l00078"></a>00078         memcpy(&amp;offsetToImageData, &amp;pMem[10], 2);
<a name="l00079"></a>00079         <a class="code" href="PlatformSetupAndroid_8h.html#ab8ef12fab634c171394422d0ee8baf94">byte</a> *pPixelData = &amp;pMem[offsetToImageData];
<a name="l00080"></a>00080         
<a name="l00081"></a>00081         <span class="keywordflow">if</span> (!<a class="code" href="ResourceUtils_8cpp.html#a728f142c9755176629eb140c43985d53">IsPowerOf2</a>(pBmpImageInfo-&gt;<a class="code" href="structBMPImageHeader.html#a567a3513aeb77294139fa725a88f3361">Width</a>) || !<a class="code" href="ResourceUtils_8cpp.html#a728f142c9755176629eb140c43985d53">IsPowerOf2</a>(pBmpImageInfo-&gt;<a class="code" href="structBMPImageHeader.html#a27816f2d7889dea2c08989f8bd5d4644">Height</a>))
<a name="l00082"></a>00082         {
<a name="l00083"></a>00083                 <a class="code" href="BaseApp_8cpp.html#a7217cebc0d5d71425d7b83154d38a4aa">LogError</a>(<span class="stringliteral">&quot;Bitmap dimensions needs to be of a power of 2, use RTPack on it first, this way it can still be used as if it was its original size&quot;</span>);
<a name="l00084"></a>00084                 <a class="code" href="BaseApp_8cpp.html#a7217cebc0d5d71425d7b83154d38a4aa">LogError</a>(<span class="stringliteral">&quot;Or, use SoftSurface which can do this and has a better bmp loader in it.&quot;</span>);
<a name="l00085"></a>00085                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00086"></a>00086         }
<a name="l00087"></a>00087         m_texWidth = pBmpImageInfo-&gt;<a class="code" href="structBMPImageHeader.html#a567a3513aeb77294139fa725a88f3361">Width</a>;
<a name="l00088"></a>00088         m_texHeight = pBmpImageInfo-&gt;<a class="code" href="structBMPImageHeader.html#a27816f2d7889dea2c08989f8bd5d4644">Height</a>;
<a name="l00089"></a>00089 
<a name="l00090"></a>00090         m_originalWidth = m_texWidth;
<a name="l00091"></a>00091         m_originalHeight = m_texHeight;
<a name="l00092"></a>00092 
<a name="l00093"></a>00093         <a class="code" href="flash_2GLES_2gl_8h.html#a5d5233918a454ad3975c620a69ac5f0b">GLenum</a> colorFormat = GL_RGBA;
<a name="l00094"></a>00094         <a class="code" href="flash_2GLES_2gl_8h.html#a5d5233918a454ad3975c620a69ac5f0b">GLenum</a> pixelFormat = GL_UNSIGNED_BYTE;
<a name="l00095"></a>00095         m_mipMapCount = 0;
<a name="l00096"></a>00096         <span class="comment">//we&#39;re going to have to convert it to 5551 or 4444 on our own</span>
<a name="l00097"></a>00097 
<a name="l00098"></a>00098         <a class="code" href="PlatformSetupAndroid_8h.html#ac2a9e79eb120216f855626495b7bd18a">uint16</a> *pFinal = 0;
<a name="l00099"></a>00099         <a class="code" href="PlatformSetupAndroid_8h.html#a33a5e996e7a90acefb8b1c0bea47e365">uint8</a> *pPixelDataToUse = pPixelData;
<a name="l00100"></a>00100         
<a name="l00101"></a>00101         <span class="comment">//note, yes, bmps are stored upside down, but so do our gl textures so we don&#39;t flip the Y</span>
<a name="l00102"></a>00102 
<a name="l00103"></a>00103         <span class="keywordflow">if</span> (pBmpImageInfo-&gt;<a class="code" href="structBMPImageHeader.html#ac749fb4416016b4b2627451b372f2f49">BitCount</a> == 32)
<a name="l00104"></a>00104         {
<a name="l00105"></a>00105                 <span class="comment">//convert BGRA to RGBA.  I think there is actually an undocumented parm to make the iphone except RGBA but whatever</span>
<a name="l00106"></a>00106                 <span class="keywordtype">int</span> pixelCount = m_texWidth*m_texHeight;
<a name="l00107"></a>00107                 <a class="code" href="PlatformSetupAndroid_8h.html#ab8ef12fab634c171394422d0ee8baf94">byte</a> temp;
<a name="l00108"></a>00108                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; pixelCount; i++)
<a name="l00109"></a>00109                 {
<a name="l00110"></a>00110                   temp = *pPixelData;
<a name="l00111"></a>00111                   *pPixelData = pPixelData[2];
<a name="l00112"></a>00112                   pPixelData[2] = temp;
<a name="l00113"></a>00113                   pPixelData += 4;
<a name="l00114"></a>00114                 }
<a name="l00115"></a>00115         } <span class="keywordflow">else</span>
<a name="l00116"></a>00116                 <span class="keywordflow">if</span> (pBmpImageInfo-&gt;<a class="code" href="structBMPImageHeader.html#ac749fb4416016b4b2627451b372f2f49">BitCount</a> == 24)
<a name="l00117"></a>00117                 {
<a name="l00118"></a>00118                         colorFormat = GL_RGB;           
<a name="l00119"></a>00119                         <span class="comment">//convert BGR to RGB. </span>
<a name="l00120"></a>00120                         <span class="keywordtype">int</span> pixelCount = m_texWidth*m_texHeight;
<a name="l00121"></a>00121                         <a class="code" href="PlatformSetupAndroid_8h.html#ab8ef12fab634c171394422d0ee8baf94">byte</a> temp;
<a name="l00122"></a>00122                         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; pixelCount; i++)
<a name="l00123"></a>00123                         {
<a name="l00124"></a>00124                                 temp = *pPixelData;
<a name="l00125"></a>00125                                 *pPixelData = pPixelData[2];
<a name="l00126"></a>00126                                 pPixelData[2] = temp;
<a name="l00127"></a>00127                                 pPixelData += 3;
<a name="l00128"></a>00128                         }
<a name="l00129"></a>00129                 } 
<a name="l00130"></a>00130 
<a name="l00131"></a>00131          <span class="keywordflow">else</span>
<a name="l00132"></a>00132         {
<a name="l00133"></a>00133                 <a class="code" href="BaseApp_8cpp.html#a7217cebc0d5d71425d7b83154d38a4aa">LogError</a>(<span class="stringliteral">&quot;Don&#39;t handle %d bit bmps yet&quot;</span>, pBmpImageInfo-&gt;<a class="code" href="structBMPImageHeader.html#ac749fb4416016b4b2627451b372f2f49">BitCount</a>);
<a name="l00134"></a>00134                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00135"></a>00135         }
<a name="l00136"></a>00136         
<a name="l00137"></a>00137         PrepareGLForNewTexture();       
<a name="l00138"></a>00138         m_bUsesAlpha = (colorFormat == GL_RGBA);
<a name="l00139"></a>00139         <a class="code" href="GLFlashAdaptor_8cpp.html#a1ae5a412e68bc19aa8fd18e8c206c6de">glTexImage2D</a>( GL_TEXTURE_2D, 0, colorFormat, m_texWidth, m_texHeight, 0, colorFormat, pixelFormat, pPixelDataToUse );
<a name="l00140"></a>00140         IncreaseMemCounter(m_texWidth*m_texHeight* (pBmpImageInfo-&gt;<a class="code" href="structBMPImageHeader.html#ac749fb4416016b4b2627451b372f2f49">BitCount</a>/8));
<a name="l00141"></a>00141         SetTextureStates();
<a name="l00142"></a>00142         CHECK_GL_ERROR();
<a name="l00143"></a>00143         SAFE_DELETE_ARRAY(pFinal);
<a name="l00144"></a>00144         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00145"></a>00145 }
<a name="l00146"></a>00146 
<a name="l00147"></a>00147 <span class="keywordtype">void</span> Surface::IncreaseMemCounter(<span class="keywordtype">int</span> mem)
<a name="l00148"></a>00148 {
<a name="l00149"></a>00149         <span class="keywordflow">if</span> (m_texType == <a class="code" href="classSurface.html#a6d321b09caff273d52719177b0c408cea38acdb44b1237953a24daab6e5090a35" title="The texture is owned by somebody else and is responsible for setting the appropriate parameters...">TYPE_NOT_OWNER</a>) <span class="keywordflow">return</span>;
<a name="l00150"></a>00150 
<a name="l00151"></a>00151         assert(!m_memUsed &amp;&amp; <span class="stringliteral">&quot;Forgot to clear this somewhere?&quot;</span>);
<a name="l00152"></a>00152         m_memUsed = mem;
<a name="l00153"></a>00153         <a class="code" href="BaseApp_8h.html#a72086b48d24daf0a65dd20189a16bd16">GetBaseApp</a>()-&gt;<a class="code" href="classBaseApp.html#a22b33e7c534cb862cb38a75e01b02013">ModTexUsed</a>(m_memUsed);
<a name="l00154"></a>00154 }
<a name="l00155"></a>00155 <span class="keywordtype">void</span> Surface::PrepareGLForNewTexture()
<a name="l00156"></a>00156 {
<a name="l00157"></a>00157         
<a name="l00158"></a>00158         <span class="keywordflow">if</span> (m_texType == <a class="code" href="classSurface.html#a6d321b09caff273d52719177b0c408cea38acdb44b1237953a24daab6e5090a35" title="The texture is owned by somebody else and is responsible for setting the appropriate parameters...">TYPE_NOT_OWNER</a>) <span class="keywordflow">return</span>;
<a name="l00159"></a>00159 
<a name="l00160"></a>00160         CHECK_GL_ERROR();
<a name="l00161"></a>00161 
<a name="l00162"></a>00162         <a class="code" href="GLFlashAdaptor_8cpp.html#abb93eee51e23911c99036b363bfa4723">glGenTextures</a>( 1, &amp;m_glTextureID ); 
<a name="l00163"></a>00163         CHECK_GL_ERROR();
<a name="l00164"></a>00164         <a class="code" href="GLFlashAdaptor_8cpp.html#aa03bee8626b16593de545bcf352477ec">glBindTexture</a>( GL_TEXTURE_2D, m_glTextureID);
<a name="l00165"></a>00165         <a class="code" href="Surface_8cpp.html#ac9bd600d6c9bfe3f542141dd840eece7">g_lastBound</a> = m_glTextureID;
<a name="l00166"></a>00166         CHECK_GL_ERROR();
<a name="l00167"></a>00167 
<a name="l00168"></a>00168         
<a name="l00169"></a>00169         <span class="comment">//glTexParameteri( GL_TEXTURE_2D, GL_GENERATE_MIPMAP, GL_TRUE );</span>
<a name="l00170"></a>00170 }
<a name="l00171"></a>00171 
<a name="l00172"></a>00172 <span class="preprocessor">#define GL_COMPRESSED_RGB_PVRTC_4BPPV1_IMG                      0x8C00 //35840</span>
<a name="l00173"></a>00173 <span class="preprocessor"></span><span class="preprocessor">#define GL_COMPRESSED_RGB_PVRTC_2BPPV1_IMG                      0x8C01 //35841</span>
<a name="l00174"></a>00174 <span class="preprocessor"></span><span class="preprocessor">#define GL_COMPRESSED_RGBA_PVRTC_4BPPV1_IMG                     0x8C02 //35842</span>
<a name="l00175"></a>00175 <span class="preprocessor"></span><span class="preprocessor">#define GL_COMPRESSED_RGBA_PVRTC_2BPPV1_IMG                     0x8C03 //35843</span>
<a name="l00176"></a>00176 <span class="preprocessor"></span>
<a name="l00177"></a>00177 <span class="preprocessor">#ifndef GL_UNSIGNED_SHORT_4_4_4_4</span>
<a name="l00178"></a>00178 <span class="preprocessor"></span><span class="preprocessor">        #define GL_UNSIGNED_SHORT_4_4_4_4         0x8033</span>
<a name="l00179"></a>00179 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00180"></a>00180 <span class="preprocessor"></span>
<a name="l00181"></a><a class="code" href="Surface_8cpp.html#ab042789eca5c1fd9c4e26a8b5b6975e8">00181</a> <span class="keywordtype">int</span> <a class="code" href="Surface_8cpp.html#ab042789eca5c1fd9c4e26a8b5b6975e8">GetIntFromMemImplementation</a>(<a class="code" href="PlatformSetupAndroid_8h.html#ab8ef12fab634c171394422d0ee8baf94">byte</a> *pMem)
<a name="l00182"></a>00182 {
<a name="l00183"></a>00183         <span class="keywordtype">int</span> temp;
<a name="l00184"></a>00184         assert(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) == 4);
<a name="l00185"></a>00185         memcpy(&amp;temp, pMem, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
<a name="l00186"></a>00186         <span class="keywordflow">return</span> temp;
<a name="l00187"></a>00187 }
<a name="l00188"></a>00188 
<a name="l00189"></a>00189 <span class="preprocessor">#define GetIntFromMem(var) GetIntFromMemImplementation( (byte*)var)</span>
<a name="l00190"></a>00190 <span class="preprocessor"></span>
<a name="l00191"></a>00191 <span class="keywordtype">void</span> Surface::PreMultiplyAlpha(<a class="code" href="PlatformSetupAndroid_8h.html#ab8ef12fab634c171394422d0ee8baf94">byte</a> *pBytes, <span class="keywordtype">int</span> <a class="code" href="flash_2GLES_2glext_8h.html#a3ce386e55bbeb900c1b23e064b89bd04">width</a>, <span class="keywordtype">int</span> <a class="code" href="flash_2GLES_2glext_8h.html#aedd0ea77029b98ce91e47c19addcb68f">height</a>, <span class="keywordtype">int</span> <a class="code" href="flash_2GLES_2glext_8h.html#a623c5b7577f9ec4174db688b61b73be7">format</a>)
<a name="l00192"></a>00192 {
<a name="l00193"></a>00193         assert(format == GL_UNSIGNED_SHORT_4_4_4_4  || format == GL_UNSIGNED_BYTE &amp;&amp; <span class="stringliteral">&quot;This doesn&#39;t make sense premuliplying something that has no alpha!&quot;</span>);
<a name="l00194"></a>00194    
<a name="l00195"></a>00195         <span class="keywordflow">if</span> (pBytes == 0) 
<a name="l00196"></a>00196         {
<a name="l00197"></a>00197                 <a class="code" href="AndroidUtils_8cpp.html#aaa5c9bf2289dec09f59ef2b7ba6c66ae">LogMsg</a>(<span class="stringliteral">&quot;Can&#39;t premult, it&#39;s null&quot;</span>);
<a name="l00198"></a>00198                 <span class="keywordflow">return</span>;
<a name="l00199"></a>00199         }
<a name="l00200"></a>00200         <span class="keywordflow">if</span> (format == GL_UNSIGNED_SHORT_4_4_4_4)
<a name="l00201"></a>00201         {
<a name="l00202"></a>00202                 <a class="code" href="PlatformSetupAndroid_8h.html#ac2a9e79eb120216f855626495b7bd18a">uint16</a> *pDestImage = (<a class="code" href="PlatformSetupAndroid_8h.html#ac2a9e79eb120216f855626495b7bd18a">uint16</a> *)pBytes;
<a name="l00203"></a>00203 
<a name="l00204"></a>00204                 <span class="keywordtype">int</span> <a class="code" href="flash_2GLES_2glext_8h.html#abe08814c2f72843fde4d8df41440d5a0">r</a>,<a class="code" href="Renderer_2GL_2glext_8h.html#a9cd653b1648845554169fbc3a3f6d37a">g</a>,<a class="code" href="Renderer_2GL_2glext_8h.html#a6eba317e3cf44d6d26c04a5a8f197dcb">b</a>,<a class="code" href="Renderer_2GL_2glext_8h.html#ac8729153468b5dcf13f971b21d84d4e5">a</a>;
<a name="l00205"></a>00205 
<a name="l00206"></a>00206                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="flash_2GLES_2glext_8h.html#a2532a9f8ed3a10a63f5e3c484fbfdb9b">y</a>=0; <a class="code" href="flash_2GLES_2glext_8h.html#a2532a9f8ed3a10a63f5e3c484fbfdb9b">y</a> &lt; <a class="code" href="flash_2GLES_2glext_8h.html#a3ce386e55bbeb900c1b23e064b89bd04">width</a>; <a class="code" href="flash_2GLES_2glext_8h.html#a2532a9f8ed3a10a63f5e3c484fbfdb9b">y</a>++)
<a name="l00207"></a>00207                 {
<a name="l00208"></a>00208                         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="flash_2GLES_2glext_8h.html#a0cdec8e97a75ee9458b23d152bf962d4">x</a>=0; <a class="code" href="flash_2GLES_2glext_8h.html#a0cdec8e97a75ee9458b23d152bf962d4">x</a> &lt; <a class="code" href="flash_2GLES_2glext_8h.html#aedd0ea77029b98ce91e47c19addcb68f">height</a>; <a class="code" href="flash_2GLES_2glext_8h.html#a0cdec8e97a75ee9458b23d152bf962d4">x</a>++)
<a name="l00209"></a>00209                         {
<a name="l00210"></a>00210                                 
<a name="l00211"></a>00211                                 <span class="comment">//get the alpha</span>
<a name="l00212"></a>00212                                 a = (*pDestImage &gt;&gt; 0) &amp; 15;
<a name="l00213"></a>00213                                 
<a name="l00214"></a>00214                                 <span class="comment">/*</span>
<a name="l00215"></a>00215 <span class="comment">                                //without modifying it, we&#39;d do this:</span>
<a name="l00216"></a>00216 <span class="comment">                                r = (((*pDestImage &gt;&gt; 0) &amp; 15);</span>
<a name="l00217"></a>00217 <span class="comment">                                g = ((*pDestImage &gt;&gt; 4) &amp; 15);</span>
<a name="l00218"></a>00218 <span class="comment">                                b = ((*pDestImage &gt;&gt; 8) &amp; 15);</span>
<a name="l00219"></a>00219 <span class="comment">                                */</span>
<a name="l00220"></a>00220         
<a name="l00221"></a>00221                                 r = (((*pDestImage &gt;&gt; 4) &amp; 15)*<a class="code" href="Renderer_2GL_2glext_8h.html#ac8729153468b5dcf13f971b21d84d4e5">a</a>)/16;
<a name="l00222"></a>00222                                 g = (((*pDestImage &gt;&gt; 8) &amp; 15)*<a class="code" href="Renderer_2GL_2glext_8h.html#ac8729153468b5dcf13f971b21d84d4e5">a</a>)/16;
<a name="l00223"></a>00223                                 b = (((*pDestImage &gt;&gt; 12) &amp; 15)*<a class="code" href="Renderer_2GL_2glext_8h.html#ac8729153468b5dcf13f971b21d84d4e5">a</a>)/16;
<a name="l00224"></a>00224 
<a name="l00225"></a>00225                                 <span class="comment">//LogMsg(&quot;a: %d, r %d g %d b %d&quot;, int(a), int(r), int(g), int(b));</span>
<a name="l00226"></a>00226                                 
<a name="l00227"></a>00227                                 <span class="comment">//pack it back in</span>
<a name="l00228"></a>00228                                 
<a name="l00229"></a>00229                                 *pDestImage = a &lt;&lt; 0 | r &lt;&lt; 4 | g &lt;&lt; 8 | b &lt;&lt; 12;
<a name="l00230"></a>00230                                 pDestImage++;
<a name="l00231"></a>00231                         }
<a name="l00232"></a>00232                 }
<a name="l00233"></a>00233 
<a name="l00234"></a>00234         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (format == GL_UNSIGNED_BYTE)
<a name="l00235"></a>00235         {
<a name="l00236"></a>00236  
<a name="l00237"></a>00237                 <a class="code" href="structglColorBytes.html">glColorBytes</a> *pDestImage = (<a class="code" href="structglColorBytes.html">glColorBytes</a>*)pBytes;
<a name="l00238"></a>00238 
<a name="l00239"></a>00239                 <span class="comment">//slower way that supports transparency</span>
<a name="l00240"></a>00240                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="flash_2GLES_2glext_8h.html#a2532a9f8ed3a10a63f5e3c484fbfdb9b">y</a>=0; <a class="code" href="flash_2GLES_2glext_8h.html#a2532a9f8ed3a10a63f5e3c484fbfdb9b">y</a> &lt; <a class="code" href="flash_2GLES_2glext_8h.html#a3ce386e55bbeb900c1b23e064b89bd04">width</a>; <a class="code" href="flash_2GLES_2glext_8h.html#a2532a9f8ed3a10a63f5e3c484fbfdb9b">y</a>++)
<a name="l00241"></a>00241                 {
<a name="l00242"></a>00242                         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="flash_2GLES_2glext_8h.html#a0cdec8e97a75ee9458b23d152bf962d4">x</a>=0; <a class="code" href="flash_2GLES_2glext_8h.html#a0cdec8e97a75ee9458b23d152bf962d4">x</a> &lt; <a class="code" href="flash_2GLES_2glext_8h.html#aedd0ea77029b98ce91e47c19addcb68f">height</a>; <a class="code" href="flash_2GLES_2glext_8h.html#a0cdec8e97a75ee9458b23d152bf962d4">x</a>++)
<a name="l00243"></a>00243                         {
<a name="l00244"></a>00244                                 pDestImage-&gt;<a class="code" href="structglColorBytes.html#a45f84664a9c2094926e1a7f74b519cca">r</a> = (pDestImage-&gt;<a class="code" href="structglColorBytes.html#a45f84664a9c2094926e1a7f74b519cca">r</a>*pDestImage-&gt;<a class="code" href="structglColorBytes.html#a6fbee54bc4cc7f8ecd93dab1cd43ee2f">a</a>)/255;
<a name="l00245"></a>00245                                 pDestImage-&gt;<a class="code" href="structglColorBytes.html#affcd4d6789a25720de600669f307635d">g</a> = (pDestImage-&gt;<a class="code" href="structglColorBytes.html#affcd4d6789a25720de600669f307635d">g</a>*pDestImage-&gt;<a class="code" href="structglColorBytes.html#a6fbee54bc4cc7f8ecd93dab1cd43ee2f">a</a>)/255;
<a name="l00246"></a>00246                                 pDestImage-&gt;<a class="code" href="structglColorBytes.html#a221c697efb3e0a485dd83ae3b633d79f">b</a> = (pDestImage-&gt;<a class="code" href="structglColorBytes.html#a221c697efb3e0a485dd83ae3b633d79f">b</a>*pDestImage-&gt;<a class="code" href="structglColorBytes.html#a6fbee54bc4cc7f8ecd93dab1cd43ee2f">a</a>)/255;
<a name="l00247"></a>00247                                 pDestImage++;
<a name="l00248"></a>00248                         }
<a name="l00249"></a>00249                 }
<a name="l00250"></a>00250         } <span class="keywordflow">else</span>
<a name="l00251"></a>00251         {
<a name="l00252"></a>00252                 <a class="code" href="BaseApp_8cpp.html#a7217cebc0d5d71425d7b83154d38a4aa">LogError</a>(<span class="stringliteral">&quot;Don&#39;t know how to premultiply this alpha&quot;</span>);
<a name="l00253"></a>00253                 assert(0);
<a name="l00254"></a>00254         }
<a name="l00255"></a>00255 
<a name="l00256"></a>00256 }
<a name="l00257"></a>00257 
<a name="l00258"></a>00258 <span class="keywordtype">bool</span> Surface::LoadRTTexture(<a class="code" href="PlatformSetupAndroid_8h.html#ab8ef12fab634c171394422d0ee8baf94">byte</a> *pMem)
<a name="l00259"></a>00259 {
<a name="l00260"></a>00260         <a class="code" href="structrttex__header.html">rttex_header</a> *pTexHeader = (<a class="code" href="structrttex__header.html">rttex_header</a>*)pMem;
<a name="l00261"></a>00261         <a class="code" href="structrttex__mip__header.html">rttex_mip_header</a> *pMipSection;
<a name="l00262"></a>00262 
<a name="l00263"></a>00263         m_texWidth = pTexHeader-&gt;<a class="code" href="structrttex__header.html#a74e34cbb505fda1400eac1e09e9a0846">width</a>;
<a name="l00264"></a>00264         m_texHeight = pTexHeader-&gt;<a class="code" href="structrttex__header.html#a636552f65559f272725666f146d84d73">height</a>;
<a name="l00265"></a>00265         m_bUsesAlpha = pTexHeader-&gt;<a class="code" href="structrttex__header.html#a712f4ab7d302379f45d82ef311cd516e">bUsesAlpha</a> != 0;
<a name="l00266"></a>00266         m_originalWidth = pTexHeader-&gt;<a class="code" href="structrttex__header.html#a4469f5ff0ccdd4bcb71578221d08673c">originalWidth</a>;
<a name="l00267"></a>00267         m_originalHeight = pTexHeader-&gt;<a class="code" href="structrttex__header.html#a5b9e9c7f584a90d9c8c9b4f1a4642151">originalHeight</a>;
<a name="l00268"></a>00268         m_mipMapCount = pTexHeader-&gt;<a class="code" href="structrttex__header.html#a4f6738e388d968fdead00e3f394fd956">mipmapCount</a>;
<a name="l00269"></a>00269         <a class="code" href="PlatformSetupAndroid_8h.html#ab8ef12fab634c171394422d0ee8baf94">byte</a> *pCurPos = pMem + <span class="keyword">sizeof</span>(<a class="code" href="structrttex__header.html">rttex_header</a>);
<a name="l00270"></a>00270 
<a name="l00271"></a>00271         <span class="keywordtype">int</span> memUsed = 0;
<a name="l00272"></a>00272 <span class="preprocessor">#ifdef _DEBUG</span>
<a name="l00273"></a>00273 <span class="preprocessor"></span>        <span class="keywordtype">int</span> rttexHeaderSize = <span class="keyword">sizeof</span>(<a class="code" href="structrttex__header.html">rttex_header</a>);
<a name="l00274"></a>00274         <span class="keywordtype">int</span> rttexMipSectionSize = <span class="keyword">sizeof</span>(<a class="code" href="structrttex__mip__header.html">rttex_mip_header</a>);
<a name="l00275"></a>00275 
<a name="l00276"></a>00276         assert (rttexHeaderSize%4 == 0 &amp;&amp; <span class="stringliteral">&quot;Can&#39;t be right, structure packing changed?&quot;</span>);
<a name="l00277"></a>00277         assert (rttexMipSectionSize%4 == 0 &amp;&amp; <span class="stringliteral">&quot;Can&#39;t be right, structure packing changed?&quot;</span>);
<a name="l00278"></a>00278 <span class="preprocessor">#endif</span>
<a name="l00279"></a>00279 <span class="preprocessor"></span>        <span class="keywordtype">int</span> format = GetIntFromMem(&amp;pTexHeader-&gt;<a class="code" href="structrttex__header.html#ad69b3dd480be860599eccd4fa74f33e3">format</a>);
<a name="l00280"></a>00280 
<a name="l00281"></a>00281         <span class="keywordflow">if</span> (m_bCreateMipMapsIfNeeded)
<a name="l00282"></a>00282         {
<a name="l00283"></a>00283                 <span class="keywordflow">if</span> (m_mipMapCount == 1)
<a name="l00284"></a>00284                 {
<a name="l00285"></a>00285                         m_mipMapCount = 8; <span class="comment">//guess, exact # doesn&#39;t matter, just must be more than 1</span>
<a name="l00286"></a>00286                         <a class="code" href="GLFlashAdaptor_8cpp.html#a51b865e78bb9b11d7260030e3307852c">glTexParameteri</a>( GL_TEXTURE_2D, GL_GENERATE_MIPMAP, GL_TRUE );
<a name="l00287"></a>00287                 } <span class="keywordflow">else</span>
<a name="l00288"></a>00288                 {
<a name="l00289"></a>00289                         <a class="code" href="GLFlashAdaptor_8cpp.html#a51b865e78bb9b11d7260030e3307852c">glTexParameteri</a>( GL_TEXTURE_2D, GL_GENERATE_MIPMAP, GL_FALSE );
<a name="l00290"></a>00290                 }
<a name="l00291"></a>00291         }
<a name="l00292"></a>00292 
<a name="l00293"></a>00293         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> nMipLevel=0; nMipLevel &lt; pTexHeader-&gt;<a class="code" href="structrttex__header.html#a4f6738e388d968fdead00e3f394fd956">mipmapCount</a>; nMipLevel++)
<a name="l00294"></a>00294         {
<a name="l00295"></a>00295                 pMipSection = (<a class="code" href="structrttex__mip__header.html">rttex_mip_header</a>*)pCurPos;
<a name="l00296"></a>00296                 pCurPos += <span class="keyword">sizeof</span>(<a class="code" href="structrttex__mip__header.html">rttex_mip_header</a>);
<a name="l00297"></a>00297                 <a class="code" href="PlatformSetupAndroid_8h.html#ab8ef12fab634c171394422d0ee8baf94">byte</a> *pTextureData =  pCurPos ;
<a name="l00298"></a>00298                 memUsed += pMipSection-&gt;<a class="code" href="structrttex__mip__header.html#a9ccda4cfd50e0d458360474611a9655a">dataSize</a>;
<a name="l00299"></a>00299 
<a name="l00300"></a>00300                 <span class="comment">//actually, let&#39;s move the texture data into something byte aligned.. it shouldn&#39;t need this but if I don&#39;t,</span>
<a name="l00301"></a>00301                 <span class="comment">//crashes in release mode on iPhone 3GS and older when using xcode 4 and targetting OS 3.2+.  It should already be</span>
<a name="l00302"></a>00302                 <span class="comment">//int aligned (at least for mip 0..) so I don&#39;t know why this is required.  -Seth</span>
<a name="l00303"></a>00303 
<a name="l00304"></a>00304                 pTextureData = <span class="keyword">new</span> <a class="code" href="PlatformSetupAndroid_8h.html#ab8ef12fab634c171394422d0ee8baf94">byte</a>[pMipSection-&gt;<a class="code" href="structrttex__mip__header.html#a9ccda4cfd50e0d458360474611a9655a">dataSize</a>];
<a name="l00305"></a>00305                 memcpy(pTextureData, pCurPos,pMipSection-&gt;<a class="code" href="structrttex__mip__header.html#a9ccda4cfd50e0d458360474611a9655a">dataSize</a> );
<a name="l00306"></a>00306                 <span class="comment">//let&#39;s do it manually now</span>
<a name="l00307"></a>00307                 <span class="keywordtype">int</span> width = GetIntFromMem(&amp;pMipSection-&gt;<a class="code" href="structrttex__mip__header.html#a315e372d25ec93533e7ab92f670acd2c">width</a>);
<a name="l00308"></a>00308                 <span class="keywordtype">int</span> height = GetIntFromMem(&amp;pMipSection-&gt;<a class="code" href="structrttex__mip__header.html#a2eb98af8c903efadf0faba06b4336dc2">height</a>);
<a name="l00309"></a>00309         
<a name="l00310"></a>00310                 <span class="keywordflow">if</span> (nMipLevel == 0)
<a name="l00311"></a>00311                 {
<a name="l00312"></a>00312                         PrepareGLForNewTexture(); <span class="comment">//if we&#39;re not the owner, this will be ignored</span>
<a name="l00313"></a>00313                 }
<a name="l00314"></a>00314 
<a name="l00315"></a>00315                 <span class="keywordflow">if</span> (format == RT_FORMAT_EMBEDDED_FILE)
<a name="l00316"></a>00316                 {
<a name="l00317"></a>00317                         <span class="keywordflow">if</span> (*((<a class="code" href="PlatformSetupAndroid_8h.html#ac2a9e79eb120216f855626495b7bd18a">uint16</a>*)pTextureData) != <a class="code" href="PlatformSetup_8h.html#af7149f417a184e09521b947a60873930">C_JPG_HEADER_MARKER</a>)
<a name="l00318"></a>00318                         {
<a name="l00319"></a>00319                                 <span class="comment">//if it&#39;s &quot;embedded&quot;, but not jpg, let&#39;s assume it is raw RGB,.. this way I don&#39;t have to use jpg for all the tiny mipmaps.  </span>
<a name="l00320"></a>00320                                 <span class="comment">//I may want to put the format in rttex_mip_header to allow more flexibility though..</span>
<a name="l00321"></a>00321                                 <span class="keywordtype">int</span> colorType = GL_RGB;
<a name="l00322"></a>00322                                 <span class="keywordtype">int</span> internalColorFormat = colorType;
<a name="l00323"></a>00323 <span class="preprocessor">                                        #ifdef C_GL_MODE</span>
<a name="l00324"></a>00324 <span class="preprocessor"></span>                                                                        <span class="keywordflow">if</span> (internalColorFormat == GL_RGBA) internalColorFormat = GL_RGBA8;
<a name="l00325"></a>00325                                                                         <span class="keywordflow">if</span> (internalColorFormat == GL_RGB) internalColorFormat = GL_RGB8;
<a name="l00326"></a>00326 <span class="preprocessor">                                        #endif</span>
<a name="l00327"></a>00327 <span class="preprocessor"></span>                                
<a name="l00328"></a>00328                                         
<a name="l00329"></a>00329                                         <a class="code" href="GLFlashAdaptor_8cpp.html#a1ae5a412e68bc19aa8fd18e8c206c6de">glTexImage2D</a>( GL_TEXTURE_2D, nMipLevel, internalColorFormat, width, height, 0, colorType, GL_UNSIGNED_BYTE, pTextureData );
<a name="l00330"></a>00330 
<a name="l00331"></a>00331                         } <span class="keywordflow">else</span>
<a name="l00332"></a>00332                         {
<a name="l00333"></a>00333                         
<a name="l00334"></a>00334                                 <a class="code" href="classSoftSurface.html">SoftSurface</a> <a class="code" href="flash_2GLES_2glext_8h.html#ad585a1393cfa368fa9dc3d8ebff640d5">s</a>;
<a name="l00335"></a>00335 
<a name="l00336"></a>00336                                 <span class="keywordflow">if</span> (!s.<a class="code" href="classSoftSurface.html#a07fc28d1e34b71ce3305173f3aa7229f">LoadFileFromMemory</a>(pTextureData, <a class="code" href="classSoftSurface.html#a12b4db07ce87831a0fc6aed5449572b8ae786f21f3e2f8dd6630581b648407797">SoftSurface::COLOR_KEY_NONE</a>, pMipSection-&gt;<a class="code" href="structrttex__mip__header.html#a9ccda4cfd50e0d458360474611a9655a">dataSize</a>))
<a name="l00337"></a>00337                                 {
<a name="l00338"></a>00338                                         <a class="code" href="AndroidUtils_8cpp.html#aaa5c9bf2289dec09f59ef2b7ba6c66ae">LogMsg</a>(<span class="stringliteral">&quot;(Failed to load image inside of rttex)&quot;</span>);
<a name="l00339"></a>00339                                         assert(!<span class="stringliteral">&quot;Failed to load image inside of rttex&quot;</span>);
<a name="l00340"></a>00340                                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00341"></a>00341                                 }
<a name="l00342"></a>00342         
<a name="l00343"></a>00343                                 SAFE_DELETE_ARRAY(pTextureData);
<a name="l00344"></a>00344                                 <span class="keywordtype">bool</span> bResult = <a class="code" href="classSurface.html#a71b5094cdffab8829fec8cf712e60259">InitFromSoftSurface</a>(&amp;s, <span class="keyword">false</span>, nMipLevel);
<a name="l00345"></a>00345 
<a name="l00346"></a>00346                                 <span class="keywordflow">if</span> (!bResult)
<a name="l00347"></a>00347                                 {
<a name="l00348"></a>00348                                         <a class="code" href="AndroidUtils_8cpp.html#aaa5c9bf2289dec09f59ef2b7ba6c66ae">LogMsg</a>(<span class="stringliteral">&quot;Failed to init from surface?&quot;</span>);
<a name="l00349"></a>00349                                         assert(0);
<a name="l00350"></a>00350                                         <span class="keywordflow">return</span> bResult;
<a name="l00351"></a>00351                                 }
<a name="l00352"></a>00352                         }
<a name="l00353"></a>00353 
<a name="l00354"></a>00354                 } <span class="keywordflow">else</span>
<a name="l00355"></a>00355                 {
<a name="l00356"></a>00356                         <span class="keywordflow">if</span> (pTexHeader-&gt;<a class="code" href="structrttex__header.html#ad69b3dd480be860599eccd4fa74f33e3">format</a> &lt; GL_COMPRESSED_RGB_PVRTC_4BPPV1_IMG || pTexHeader-&gt;<a class="code" href="structrttex__header.html#ad69b3dd480be860599eccd4fa74f33e3">format</a> &gt; GL_COMPRESSED_RGBA_PVRTC_2BPPV1_IMG) <span class="comment">//doesn&#39;t look like a compressed texture</span>
<a name="l00357"></a>00357                         {
<a name="l00358"></a>00358                                 <span class="keywordtype">int</span> colorType = GL_RGBA;
<a name="l00359"></a>00359                                 <span class="keywordflow">if</span> (!m_bUsesAlpha)
<a name="l00360"></a>00360                                 {
<a name="l00361"></a>00361                                         colorType = GL_RGB;
<a name="l00362"></a>00362                                 }
<a name="l00363"></a>00363                                 <span class="comment">//LogMsg(&quot;Loading surface: miplevel %d, internal color type:0x%02lX  colortype 0x%02lX, x%d y%d, format type: 0x%02lX&quot;, nMipLevel, colorTypeSource, colorType, pMipSection-&gt;width, pMipSection-&gt;height, pTexHeader-&gt;format );</span>
<a name="l00364"></a>00364                                 <span class="keywordtype">int</span> internalColorFormat = colorType;
<a name="l00365"></a>00365 <span class="preprocessor">#ifdef C_GL_MODE</span>
<a name="l00366"></a>00366 <span class="preprocessor"></span>                                <span class="keywordflow">if</span> (internalColorFormat == GL_RGBA) internalColorFormat = GL_RGBA8;
<a name="l00367"></a>00367                                 <span class="keywordflow">if</span> (internalColorFormat == GL_RGB) internalColorFormat = GL_RGB8;
<a name="l00368"></a>00368 <span class="preprocessor">#endif</span>
<a name="l00369"></a>00369 <span class="preprocessor"></span>
<a name="l00370"></a>00370                                 <span class="keywordflow">if</span> (m_texType == <a class="code" href="classSurface.html#a6d321b09caff273d52719177b0c408ceae840610a4d9d8760213a1182a537a91d" title="Linear filtering, wrap mode is clamp to edge, no mipmaps.">TYPE_GUI</a> &amp;&amp; m_bUsesAlpha)
<a name="l00371"></a>00371                                 {
<a name="l00372"></a>00372                                         <span class="comment">//Go ahead and activate premultiplied alpha processing.  This will allow us to zoom in on textures and not have ugly artifacts</span>
<a name="l00373"></a>00373                                         <span class="comment">//around the edges.</span>
<a name="l00374"></a>00374                                         
<a name="l00375"></a>00375                                         m_blendingMode = <a class="code" href="classSurface.html#a9157c34025ceac6c10dbbadf6796a802a5fc9ca5cdc886234ffbfb91283025523">BLENDING_PREMULTIPLIED_ALPHA</a>;
<a name="l00376"></a>00376                                 }
<a name="l00377"></a>00377 
<a name="l00378"></a>00378                                 <span class="keywordflow">if</span> (m_blendingMode == <a class="code" href="classSurface.html#a9157c34025ceac6c10dbbadf6796a802a5fc9ca5cdc886234ffbfb91283025523">BLENDING_PREMULTIPLIED_ALPHA</a> &amp;&amp; m_bUsesAlpha)
<a name="l00379"></a>00379                                 {
<a name="l00380"></a>00380                                         PreMultiplyAlpha(pTextureData, width, height, format);
<a name="l00381"></a>00381                                 }
<a name="l00382"></a>00382 
<a name="l00383"></a>00383                                 <a class="code" href="GLFlashAdaptor_8cpp.html#a1ae5a412e68bc19aa8fd18e8c206c6de">glTexImage2D</a>( GL_TEXTURE_2D, nMipLevel, internalColorFormat, width, height, 0, colorType, format, pTextureData );
<a name="l00384"></a>00384 <span class="preprocessor">                                #ifdef _DEBUG</span>
<a name="l00385"></a>00385 <span class="preprocessor"></span>                                <span class="comment">//if (nMipLevel == 0) LogMsg(&quot;Surface::LoadRTTexture: Loading surface: %d, %d -  internalFormat: %d, format: %d color type: %d&quot;, width, height, internalColorFormat, format, colorType);</span>
<a name="l00386"></a>00386                         
<a name="l00387"></a>00387 <span class="preprocessor">                                #endif</span>
<a name="l00388"></a>00388 <span class="preprocessor"></span>                        } <span class="keywordflow">else</span>
<a name="l00389"></a>00389                         {
<a name="l00390"></a>00390 
<a name="l00391"></a>00391 <span class="preprocessor">#if defined(C_GL_MODE) || defined(RT_GLES_ADAPTOR_MODE)</span>
<a name="l00392"></a>00392 <span class="preprocessor"></span>
<a name="l00393"></a>00393                                 assert(!<span class="stringliteral">&quot;You cannot use PVR compressed textures in GL mode!&quot;</span>);
<a name="l00394"></a>00394 <span class="preprocessor">#else</span>
<a name="l00395"></a>00395 <span class="preprocessor"></span>
<a name="l00396"></a>00396                                 <a class="code" href="flash_2GLES_2gl_8h.html#a820f4433dbd54466c992fe82408f1403">glCompressedTexImage2D</a>(
<a name="l00397"></a>00397                                         GL_TEXTURE_2D, 
<a name="l00398"></a>00398                                         nMipLevel, 
<a name="l00399"></a>00399                                         pTexHeader-&gt;<a class="code" href="structrttex__header.html#ad69b3dd480be860599eccd4fa74f33e3">format</a>, 
<a name="l00400"></a>00400                                         pMipSection-&gt;<a class="code" href="structrttex__mip__header.html#a315e372d25ec93533e7ab92f670acd2c">width</a>, 
<a name="l00401"></a>00401                                         pMipSection-&gt;<a class="code" href="structrttex__mip__header.html#a2eb98af8c903efadf0faba06b4336dc2">height</a>, 
<a name="l00402"></a>00402                                         0, 
<a name="l00403"></a>00403                                         pMipSection-&gt;<a class="code" href="structrttex__mip__header.html#a9ccda4cfd50e0d458360474611a9655a">dataSize</a>, 
<a name="l00404"></a>00404                                         pTextureData);
<a name="l00405"></a>00405 <span class="preprocessor">#endif</span>
<a name="l00406"></a>00406 <span class="preprocessor"></span>                        }
<a name="l00407"></a>00407 
<a name="l00408"></a>00408                 }
<a name="l00409"></a>00409 
<a name="l00410"></a>00410                 pCurPos += pMipSection-&gt;<a class="code" href="structrttex__mip__header.html#a9ccda4cfd50e0d458360474611a9655a">dataSize</a>;
<a name="l00411"></a>00411 
<a name="l00412"></a>00412                 CHECK_GL_ERROR();
<a name="l00413"></a>00413                 SAFE_DELETE_ARRAY(pTextureData);
<a name="l00414"></a>00414 
<a name="l00415"></a>00415         }
<a name="l00416"></a>00416 
<a name="l00417"></a>00417         IncreaseMemCounter(memUsed);
<a name="l00418"></a>00418         SetTextureStates();
<a name="l00419"></a>00419         <a class="code" href="GLFlashAdaptor_8cpp.html#a51b865e78bb9b11d7260030e3307852c">glTexParameteri</a>( GL_TEXTURE_2D, GL_GENERATE_MIPMAP, GL_FALSE );
<a name="l00420"></a>00420 
<a name="l00421"></a>00421         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00422"></a>00422 }
<a name="l00423"></a>00423 
<a name="l00424"></a><a class="code" href="classSurface.html#a223154cc0d705c0a6a90c319a8457c24">00424</a> <span class="keywordtype">bool</span> <a class="code" href="classSurface.html#a223154cc0d705c0a6a90c319a8457c24">Surface::LoadFileFromMemory</a>( <a class="code" href="PlatformSetupAndroid_8h.html#ab8ef12fab634c171394422d0ee8baf94">byte</a> *pMem, <span class="keywordtype">int</span> inputSize )
<a name="l00425"></a>00425 {
<a name="l00426"></a>00426         <a class="code" href="classSurface.html#ab16aab697d858eaf2290856641bcc04f">Kill</a>();
<a name="l00427"></a>00427         
<a name="l00428"></a>00428         <span class="keywordflow">if</span> (!pMem)
<a name="l00429"></a>00429         {
<a name="l00430"></a>00430                 assert(!<span class="stringliteral">&quot;LoadFileFromMemory sent a null pointer?  AW HELL NAW&quot;</span>);
<a name="l00431"></a>00431                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00432"></a>00432         }
<a name="l00433"></a>00433         
<a name="l00434"></a>00434         <span class="keywordtype">bool</span> bReturn = <span class="keyword">false</span>;
<a name="l00435"></a>00435 
<a name="l00436"></a>00436         <span class="keywordflow">if</span> (m_texWidth == 0)
<a name="l00437"></a>00437         {
<a name="l00438"></a>00438                 <span class="keywordflow">if</span> (m_textureCreationMethod == <a class="code" href="classSurface.html#ac90b42370f09683473ee7dbeb0b0c8e0ae4c61725c624c4e5046156ea62f03849">TEXTURE_CREATION_NONE</a>)
<a name="l00439"></a>00439                 {
<a name="l00440"></a>00440                         m_textureCreationMethod = <a class="code" href="classSurface.html#ac90b42370f09683473ee7dbeb0b0c8e0a49ad7e8ee09c8aec8e00f384e3878a24">TEXTURE_CREATION_MEMORY</a>;
<a name="l00441"></a>00441                 } <span class="keywordflow">else</span>
<a name="l00442"></a>00442                 {
<a name="l00443"></a>00443                         <span class="comment">//load on demand, helps with speed</span>
<a name="l00444"></a>00444                 }
<a name="l00445"></a>00445         
<a name="l00446"></a>00446                 <span class="comment">//unload happens right away though</span>
<a name="l00447"></a>00447                 <a class="code" href="BaseApp_8h.html#a72086b48d24daf0a65dd20189a16bd16">GetBaseApp</a>()-&gt;<a class="code" href="classBaseApp.html#a9809967f0001d2d51a2b3fcf2d2ef14a" title="Signal to notify that it&#39;s time to release surfaces.">m_sig_unloadSurfaces</a>.connect(1, boost::bind(&amp;<a class="code" href="classSurface.html#a02c30648814c9398b6c2cca0faed1989">Surface::OnUnloadSurfaces</a>, <span class="keyword">this</span>));
<a name="l00448"></a>00448         
<a name="l00449"></a>00449 <span class="preprocessor">#ifdef WINAPI</span>
<a name="l00450"></a>00450 <span class="preprocessor"></span>                <a class="code" href="BaseApp_8h.html#a72086b48d24daf0a65dd20189a16bd16">GetBaseApp</a>()-&gt;<a class="code" href="classBaseApp.html#aaee0be683732eb188792eb1d97cf6bdd" title="Game restored focus.">m_sig_enterforeground</a>.connect(1, boost::bind(&amp;Surface::OnEnterForeground, <span class="keyword">this</span>, _1));
<a name="l00451"></a>00451 <span class="preprocessor">#endif</span>
<a name="l00452"></a>00452 <span class="preprocessor"></span>        }
<a name="l00453"></a>00453 
<a name="l00454"></a>00454         <span class="keywordflow">if</span> (*((<a class="code" href="PlatformSetupAndroid_8h.html#ac2a9e79eb120216f855626495b7bd18a">uint16</a>*)pMem) == <a class="code" href="PlatformSetup_8h.html#af7149f417a184e09521b947a60873930">C_JPG_HEADER_MARKER</a>)
<a name="l00455"></a>00455         {
<a name="l00456"></a>00456                 <a class="code" href="classSoftSurface.html">SoftSurface</a> <a class="code" href="flash_2GLES_2glext_8h.html#ad585a1393cfa368fa9dc3d8ebff640d5">s</a>;
<a name="l00457"></a>00457                 <span class="keywordflow">if</span> (!s.<a class="code" href="classSoftSurface.html#a07fc28d1e34b71ce3305173f3aa7229f">LoadFileFromMemory</a>(pMem, <a class="code" href="classSoftSurface.html#a12b4db07ce87831a0fc6aed5449572b8ae786f21f3e2f8dd6630581b648407797">SoftSurface::COLOR_KEY_NONE</a>, inputSize, <span class="keyword">false</span>))
<a name="l00458"></a>00458                 {
<a name="l00459"></a>00459                         <a class="code" href="AndroidUtils_8cpp.html#aaa5c9bf2289dec09f59ef2b7ba6c66ae">LogMsg</a>(<span class="stringliteral">&quot;(Failed to load jpg)&quot;</span>);
<a name="l00460"></a>00460                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00461"></a>00461                 }
<a name="l00462"></a>00462                 bReturn = <a class="code" href="classSurface.html#a71b5094cdffab8829fec8cf712e60259">InitFromSoftSurface</a>(&amp;s);
<a name="l00463"></a>00463                 
<a name="l00464"></a>00464         }<span class="keywordflow">else</span>
<a name="l00465"></a>00465         <span class="keywordflow">if</span> (strncmp((<span class="keywordtype">char</span>*)pMem, <span class="stringliteral">&quot;BM&quot;</span>, 2) == 0)
<a name="l00466"></a>00466         {
<a name="l00467"></a>00467                 <span class="comment">//we&#39;ve got a bitmap on our hands it looks like</span>
<a name="l00468"></a>00468                 bReturn = LoadBMPTexture(pMem);
<a name="l00469"></a>00469         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp((<span class="keywordtype">char</span>*)pMem, C_RTFILE_TEXTURE_HEADER, 6) == 0)
<a name="l00470"></a>00470         {
<a name="l00471"></a>00471                 bReturn = LoadRTTexture(pMem);
<a name="l00472"></a>00472         } <span class="keywordflow">else</span>
<a name="l00473"></a>00473         {
<a name="l00474"></a>00474                 <a class="code" href="BaseApp_8cpp.html#a7217cebc0d5d71425d7b83154d38a4aa">LogError</a>(<span class="stringliteral">&quot;Surface: Unknown file type&quot;</span>);
<a name="l00475"></a>00475                 assert(!<span class="stringliteral">&quot;Unknown file type&quot;</span>);
<a name="l00476"></a>00476                 <span class="keywordflow">return</span> <span class="keyword">false</span>; 
<a name="l00477"></a>00477         }
<a name="l00478"></a>00478 
<a name="l00479"></a>00479         
<a name="l00480"></a>00480         <span class="keywordflow">if</span> (bReturn)
<a name="l00481"></a>00481         {
<a name="l00482"></a>00482                 <a class="code" href="classSurface.html#a8617ddf72cb01037f2c746e837c181e9">SetSmoothing</a>(m_bSmoothing);
<a name="l00483"></a>00483         }
<a name="l00484"></a>00484         <span class="keywordflow">return</span> bReturn;
<a name="l00485"></a>00485 }
<a name="l00486"></a>00486 
<a name="l00487"></a>00487 
<a name="l00488"></a><a class="code" href="classSurface.html#a657e4c9e9bbd5727c205e622f057f6f8">00488</a> <span class="keywordtype">void</span> <a class="code" href="classSurface.html#a657e4c9e9bbd5727c205e622f057f6f8">Surface::Bind</a>()
<a name="l00489"></a>00489 {
<a name="l00490"></a>00490         CHECK_GL_ERROR();
<a name="l00491"></a>00491         <span class="keywordflow">if</span> (m_texType == <a class="code" href="classSurface.html#a6d321b09caff273d52719177b0c408cea38acdb44b1237953a24daab6e5090a35" title="The texture is owned by somebody else and is responsible for setting the appropriate parameters...">TYPE_NOT_OWNER</a>) <span class="keywordflow">return</span>;
<a name="l00492"></a>00492 
<a name="l00493"></a>00493         <span class="keywordflow">if</span> (m_glTextureID == NO_TEXTURE_LOADED &amp;&amp; !m_textureLoaded.empty())
<a name="l00494"></a>00494         {
<a name="l00495"></a>00495                 <a class="code" href="classSurface.html#ad4dccd23c2457063e4251507a140a17e">ReloadImage</a>();
<a name="l00496"></a>00496         }
<a name="l00497"></a>00497 
<a name="l00498"></a>00498         <span class="keywordflow">if</span> (<a class="code" href="Surface_8cpp.html#ac9bd600d6c9bfe3f542141dd840eece7">g_lastBound</a> == m_glTextureID)
<a name="l00499"></a>00499         {
<a name="l00500"></a>00500                 <span class="comment">//believe it or not, I saved 2 FPS on the iphone by doing my own checks</span>
<a name="l00501"></a>00501                 <span class="keywordflow">return</span>;
<a name="l00502"></a>00502         }
<a name="l00503"></a>00503 
<a name="l00504"></a>00504         <a class="code" href="GLFlashAdaptor_8cpp.html#aa03bee8626b16593de545bcf352477ec">glBindTexture</a>( GL_TEXTURE_2D, m_glTextureID);
<a name="l00505"></a>00505         <a class="code" href="Surface_8cpp.html#ac9bd600d6c9bfe3f542141dd840eece7">g_lastBound</a> = m_glTextureID;
<a name="l00506"></a>00506         CHECK_GL_ERROR();
<a name="l00507"></a>00507 
<a name="l00508"></a>00508 }
<a name="l00509"></a>00509 
<a name="l00510"></a><a class="code" href="classSurface.html#a369d5597b8378d6484809c0acad9174f">00510</a> <span class="keywordtype">bool</span> <a class="code" href="classSurface.html#a369d5597b8378d6484809c0acad9174f">Surface::LoadFile</a>( <span class="keywordtype">string</span> fName, <span class="keywordtype">bool</span> bAddBasePath )
<a name="l00511"></a>00511 {
<a name="l00512"></a>00512         <span class="keywordflow">if</span> (fName.empty())
<a name="l00513"></a>00513         {
<a name="l00514"></a>00514                 <a class="code" href="classSurface.html#ab16aab697d858eaf2290856641bcc04f">Kill</a>();
<a name="l00515"></a>00515                 <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">//no error, but I guess they just don&#39;t want anything loaded right now</span>
<a name="l00516"></a>00516         }
<a name="l00517"></a>00517         
<a name="l00518"></a>00518 <span class="preprocessor">#ifdef _DEBUG</span>
<a name="l00519"></a>00519 <span class="preprocessor"></span>        <a class="code" href="AndroidUtils_8cpp.html#aaa5c9bf2289dec09f59ef2b7ba6c66ae">LogMsg</a>(<span class="stringliteral">&quot;Loading texture %s&quot;</span>, fName.c_str());
<a name="l00520"></a>00520 <span class="preprocessor">#endif</span>
<a name="l00521"></a>00521 <span class="preprocessor"></span>
<a name="l00522"></a>00522         m_bAddBasePath = bAddBasePath;
<a name="l00523"></a>00523         
<a name="l00524"></a>00524         <a class="code" href="classFileInstance.html">FileInstance</a> <a class="code" href="Renderer_2GL_2glext_8h.html#aba8ad56949f59242bc167b073dae3715">f</a>(fName, m_bAddBasePath);
<a name="l00525"></a>00525         <span class="keywordflow">if</span> (!f.<a class="code" href="classFileInstance.html#a3de05d8e28111cfd780ea1f100ed4c35">IsLoaded</a>()) 
<a name="l00526"></a>00526         {
<a name="l00527"></a>00527                 <a class="code" href="AndroidUtils_8cpp.html#aaa5c9bf2289dec09f59ef2b7ba6c66ae">LogMsg</a>(<span class="stringliteral">&quot;Couldn&#39;t load surface %s&quot;</span>, fName.c_str());
<a name="l00528"></a>00528                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00529"></a>00529         }
<a name="l00530"></a>00530         
<a name="l00531"></a>00531         m_textureLoaded = fName;
<a name="l00532"></a>00532         m_textureCreationMethod = <a class="code" href="classSurface.html#ac90b42370f09683473ee7dbeb0b0c8e0ae4aca7912acd346b1a2453ac29d8239f">TEXTURE_CREATION_FILE</a>;
<a name="l00533"></a>00533         <span class="keywordflow">return</span> <a class="code" href="classSurface.html#a223154cc0d705c0a6a90c319a8457c24">LoadFileFromMemory</a>(f.<a class="code" href="classFileInstance.html#a09a23fb49e40d5607b29d516b4b899be">GetAsBytes</a>(), f.<a class="code" href="classFileInstance.html#a5360d29f51695d79f17e7845771225d1">GetSize</a>());
<a name="l00534"></a>00534 }
<a name="l00535"></a>00535 
<a name="l00536"></a>00536 <span class="keyword">typedef</span> <span class="keyword">struct</span>
<a name="l00537"></a>00537 {
<a name="l00538"></a>00538         <span class="keywordtype">int</span>         u;
<a name="l00539"></a>00539         <span class="keywordtype">int</span>         <a class="code" href="Renderer_2GL_2glext_8h.html#a4568fc090febc136eed4577a600739ca">v</a>;
<a name="l00540"></a>00540         <span class="keywordtype">int</span>         <a class="code" href="Renderer_2GL_2glext_8h.html#adb12a0d439f32ca388b2c806150cc54d">w</a>;
<a name="l00541"></a>00541         <span class="keywordtype">int</span>         <a class="code" href="Renderer_2GL_2glext_8h.html#afa0fb1b5e976920c0abeff2dca3ed774">h</a>;
<a name="l00542"></a>00542 } TextureCoords;
<a name="l00543"></a>00543 
<a name="l00544"></a>00544 <span class="keyword">struct </span>TexCoords
<a name="l00545"></a>00545 {
<a name="l00546"></a>00546         <span class="keywordtype">float</span> <a class="code" href="flash_2GLES_2glext_8h.html#a0cdec8e97a75ee9458b23d152bf962d4">x</a>, <a class="code" href="flash_2GLES_2glext_8h.html#a2532a9f8ed3a10a63f5e3c484fbfdb9b">y</a>;
<a name="l00547"></a>00547 };
<a name="l00548"></a>00548 
<a name="l00549"></a>00549 <span class="keyword">struct </span>Verts
<a name="l00550"></a>00550 {
<a name="l00551"></a>00551         <span class="keywordtype">float</span> <a class="code" href="flash_2GLES_2glext_8h.html#a0cdec8e97a75ee9458b23d152bf962d4">x</a>,<a class="code" href="flash_2GLES_2glext_8h.html#a2532a9f8ed3a10a63f5e3c484fbfdb9b">y</a>,<a class="code" href="flash_2GLES_2glext_8h.html#afbd8e4152e83f10b9242ae1e7a71cb0b">z</a>;
<a name="l00552"></a>00552 };
<a name="l00553"></a>00553 
<a name="l00554"></a><a class="code" href="classSurface.html#a9299bfaaf2d561b00fd6c8e1c84b3e0d">00554</a> <span class="keywordtype">void</span> <a class="code" href="classSurface.html#a9299bfaaf2d561b00fd6c8e1c84b3e0d">Surface::ApplyBlendingMode</a>(<a class="code" href="PlatformSetupAndroid_8h.html#acbd4acd0d29e2d6c43104827f77d9cd2">uint32</a> rgba)
<a name="l00555"></a>00555 {
<a name="l00556"></a>00556 
<a name="l00557"></a>00557         <span class="keywordflow">if</span> (<a class="code" href="classSurface.html#a58c8f0cd4b3964cb38312761c515c41c">UsesAlpha</a>() || rgba != <a class="code" href="PlatformSetup_8h.html#a81bebba85c7c7942c6c706b355eeab91">PURE_WHITE</a> || m_blendingMode != <a class="code" href="classSurface.html#a9157c34025ceac6c10dbbadf6796a802ac680fdcf0c36c6c0d7fa6bf682181b0d">BLENDING_NORMAL</a>)
<a name="l00558"></a>00558         {
<a name="l00559"></a>00559                 <a class="code" href="GLFlashAdaptor_8cpp.html#a408bccf3c3cf0419446bf36c64a3adc0">glEnable</a>( GL_BLEND );
<a name="l00560"></a>00560 
<a name="l00561"></a>00561                 <span class="keywordflow">switch</span> (m_blendingMode)
<a name="l00562"></a>00562                 {
<a name="l00563"></a>00563                 <span class="keywordflow">case</span> <a class="code" href="classSurface.html#a9157c34025ceac6c10dbbadf6796a802ac680fdcf0c36c6c0d7fa6bf682181b0d">BLENDING_NORMAL</a>:
<a name="l00564"></a>00564                         <a class="code" href="GLFlashAdaptor_8cpp.html#aeed45e81d121fa686b8286a2855d655c">glColor4x</a>(GET_RED(rgba) &lt;&lt; 8, GET_GREEN(rgba) &lt;&lt; 8, GET_BLUE(rgba) &lt;&lt; 8, GET_ALPHA(rgba) &lt;&lt; 8);
<a name="l00565"></a>00565                         <span class="keywordflow">break</span>;
<a name="l00566"></a>00566 
<a name="l00567"></a>00567                 <span class="keywordflow">case</span> <a class="code" href="classSurface.html#a9157c34025ceac6c10dbbadf6796a802a79f03c16170f01810be19e061efe415a">BLENDING_ADDITIVE</a>:
<a name="l00568"></a>00568                         <a class="code" href="GLFlashAdaptor_8cpp.html#a07ff942101a3b2cfc63975f062d4ee7a">glBlendFunc</a>( GL_SRC_ALPHA, GL_ONE);
<a name="l00569"></a>00569                         <a class="code" href="GLFlashAdaptor_8cpp.html#aeed45e81d121fa686b8286a2855d655c">glColor4x</a>(GET_RED(rgba) &lt;&lt; 8, GET_GREEN(rgba) &lt;&lt; 8, GET_BLUE(rgba) &lt;&lt; 8, GET_ALPHA(rgba) &lt;&lt; 8);
<a name="l00570"></a>00570                         <span class="keywordflow">break</span>;
<a name="l00571"></a>00571 
<a name="l00572"></a>00572                 <span class="keywordflow">case</span> <a class="code" href="classSurface.html#a9157c34025ceac6c10dbbadf6796a802a5fc9ca5cdc886234ffbfb91283025523">BLENDING_PREMULTIPLIED_ALPHA</a>: {
<a name="l00573"></a>00573                         <a class="code" href="GLFlashAdaptor_8cpp.html#a07ff942101a3b2cfc63975f062d4ee7a">glBlendFunc</a>( GL_ONE, GL_ONE_MINUS_SRC_ALPHA );
<a name="l00574"></a>00574                         <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="flash_2GLES_2glext_8h.html#ac679905d37690e6431eaf72910a29d36">alpha</a> = GET_ALPHA(rgba);
<a name="l00575"></a>00575                         <a class="code" href="GLFlashAdaptor_8cpp.html#aeed45e81d121fa686b8286a2855d655c">glColor4x</a>( GET_RED(rgba) * alpha, GET_GREEN(rgba) * alpha, GET_BLUE(rgba) * alpha, alpha &lt;&lt; 8);
<a name="l00576"></a>00576                                                                                    }
<a name="l00577"></a>00577                         <span class="keywordflow">break</span>;
<a name="l00578"></a>00578 
<a name="l00579"></a>00579                 <span class="keywordflow">case</span> <a class="code" href="classSurface.html#a9157c34025ceac6c10dbbadf6796a802a883ac61522bbf22d41c7d01011e1b29c">BLENDING_MULTIPLY</a>:
<a name="l00580"></a>00580                         <a class="code" href="GLFlashAdaptor_8cpp.html#a07ff942101a3b2cfc63975f062d4ee7a">glBlendFunc</a>(GL_DST_COLOR, GL_ZERO);
<a name="l00581"></a>00581                         <a class="code" href="GLFlashAdaptor_8cpp.html#aeed45e81d121fa686b8286a2855d655c">glColor4x</a>(GET_RED(rgba) &lt;&lt; 8, GET_GREEN(rgba) &lt;&lt; 8, GET_BLUE(rgba) &lt;&lt; 8, GET_ALPHA(rgba) &lt;&lt; 8);
<a name="l00582"></a>00582                         <span class="keywordflow">break</span>;
<a name="l00583"></a>00583                 <span class="keywordflow">case</span> <a class="code" href="classSurface.html#a9157c34025ceac6c10dbbadf6796a802a8cb38a7c058e286f7fb4b9616f70439c">BLENDING_DARKEN</a>:
<a name="l00584"></a>00584                         <a class="code" href="GLFlashAdaptor_8cpp.html#a07ff942101a3b2cfc63975f062d4ee7a">glBlendFunc</a>(GL_DST_COLOR, GL_ONE_MINUS_SRC_ALPHA);
<a name="l00585"></a>00585                         <a class="code" href="GLFlashAdaptor_8cpp.html#aeed45e81d121fa686b8286a2855d655c">glColor4x</a>(GET_RED(rgba) &lt;&lt; 8, GET_GREEN(rgba) &lt;&lt; 8, GET_BLUE(rgba) &lt;&lt; 8, GET_ALPHA(rgba) &lt;&lt; 8);
<a name="l00586"></a>00586                         <span class="keywordflow">break</span>;
<a name="l00587"></a>00587                 }
<a name="l00588"></a>00588         }
<a name="l00589"></a>00589 }
<a name="l00590"></a><a class="code" href="classSurface.html#a5a935ed6a6c8d170f7f2ccb8f2461a2c">00590</a> <span class="keywordtype">void</span> <a class="code" href="classSurface.html#a5a935ed6a6c8d170f7f2ccb8f2461a2c">Surface::SetupForRender</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> rotationDegrees, <span class="keyword">const</span> CL_Vec2f &amp;vRotatePt, <span class="keyword">const</span> <a class="code" href="PlatformSetupAndroid_8h.html#acbd4acd0d29e2d6c43104827f77d9cd2">uint32</a> rgba)
<a name="l00591"></a>00591 {
<a name="l00592"></a>00592         <a class="code" href="GLESUtils_8cpp.html#aaecd6106d849b5b0fd205753c3ee7c42">SetupOrtho</a>(); <span class="comment">//upside down, makes this easier to do</span>
<a name="l00593"></a>00593         <a class="code" href="BaseApp_8cpp.html#a2575c1138f3c57506bd1b72caa8c80c2">g_globalBatcher</a>.<a class="code" href="classRenderBatcher.html#a591ad1906b8683de45ed8a7c86043151">Flush</a>();
<a name="l00594"></a>00594         <a class="code" href="classSurface.html#a657e4c9e9bbd5727c205e622f057f6f8">Bind</a>();
<a name="l00595"></a>00595         
<a name="l00596"></a>00596         <span class="comment">//LogMsg(&quot;Rendering tex %d at %s at %d&quot;, m_glTextureID, PrintRect(dst).c_str(), GetTick(TIMER_GAME));</span>
<a name="l00597"></a>00597 
<a name="l00598"></a>00598         <span class="keywordflow">if</span> (rotationDegrees != 0)
<a name="l00599"></a>00599         {
<a name="l00600"></a>00600                 <a class="code" href="GLESUtils_8cpp.html#a7bf6e8268b8338f660286927e31b619e">PushRotationMatrix</a>(rotationDegrees, vRotatePt);
<a name="l00601"></a>00601         }
<a name="l00602"></a>00602         <a class="code" href="classSurface.html#a9299bfaaf2d561b00fd6c8e1c84b3e0d">ApplyBlendingMode</a>(rgba);
<a name="l00603"></a>00603 }
<a name="l00604"></a>00604 
<a name="l00605"></a><a class="code" href="classSurface.html#ad3e41ee891c4dc628310e5ec74a71534">00605</a> <span class="keywordtype">void</span> <a class="code" href="classSurface.html#ad3e41ee891c4dc628310e5ec74a71534">Surface::RemoveBlendingMode</a>(<a class="code" href="PlatformSetupAndroid_8h.html#acbd4acd0d29e2d6c43104827f77d9cd2">uint32</a> rgba)
<a name="l00606"></a>00606 {
<a name="l00607"></a>00607 
<a name="l00608"></a>00608         <span class="keywordflow">if</span> (<a class="code" href="classSurface.html#a58c8f0cd4b3964cb38312761c515c41c">UsesAlpha</a>() || rgba != <a class="code" href="PlatformSetup_8h.html#a81bebba85c7c7942c6c706b355eeab91">PURE_WHITE</a> || m_blendingMode != <a class="code" href="classSurface.html#a9157c34025ceac6c10dbbadf6796a802ac680fdcf0c36c6c0d7fa6bf682181b0d">BLENDING_NORMAL</a>)
<a name="l00609"></a>00609         {
<a name="l00610"></a>00610                 <a class="code" href="GLFlashAdaptor_8cpp.html#aeed45e81d121fa686b8286a2855d655c">glColor4x</a>(1 &lt;&lt; 16, 1 &lt;&lt; 16, 1 &lt;&lt; 16, 1 &lt;&lt; 16);
<a name="l00611"></a>00611                 <a class="code" href="GLFlashAdaptor_8cpp.html#a80fb7c3b62fc0b18c40424cf3bc22d13">glDisable</a>( GL_BLEND );
<a name="l00612"></a>00612 
<a name="l00613"></a>00613                 <span class="keywordflow">if</span> (m_blendingMode != <a class="code" href="classSurface.html#a9157c34025ceac6c10dbbadf6796a802ac680fdcf0c36c6c0d7fa6bf682181b0d">BLENDING_NORMAL</a>)
<a name="l00614"></a>00614                 {
<a name="l00615"></a>00615                         <span class="comment">//put it back to how it was</span>
<a name="l00616"></a>00616                         <a class="code" href="GLFlashAdaptor_8cpp.html#a07ff942101a3b2cfc63975f062d4ee7a">glBlendFunc</a>( GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA );
<a name="l00617"></a>00617                 }
<a name="l00618"></a>00618         }
<a name="l00619"></a>00619 
<a name="l00620"></a>00620 }
<a name="l00621"></a><a class="code" href="classSurface.html#af03298a6644c32ae745a6592b04e858c">00621</a> <span class="keywordtype">void</span> <a class="code" href="classSurface.html#af03298a6644c32ae745a6592b04e858c">Surface::EndRender</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> rotationDegrees,  <span class="keyword">const</span> <a class="code" href="PlatformSetupAndroid_8h.html#acbd4acd0d29e2d6c43104827f77d9cd2">uint32</a> rgba)
<a name="l00622"></a>00622 {
<a name="l00623"></a>00623 
<a name="l00624"></a>00624         <a class="code" href="classSurface.html#ad3e41ee891c4dc628310e5ec74a71534">RemoveBlendingMode</a>(rgba);
<a name="l00625"></a>00625 
<a name="l00626"></a>00626         <span class="keywordflow">if</span> (rotationDegrees != 0)
<a name="l00627"></a>00627         {
<a name="l00628"></a>00628                 <a class="code" href="GLESUtils_8cpp.html#a64bda37f95afbf66b289824d7f29add0">PopRotationMatrix</a>();
<a name="l00629"></a>00629         }
<a name="l00630"></a>00630 
<a name="l00631"></a>00631 }
<a name="l00632"></a>00632 
<a name="l00633"></a><a class="code" href="classSurface.html#a950bb7bc588387c0c298379d11fea5e7">00633</a> <span class="keywordtype">void</span> <a class="code" href="classSurface.html#a950bb7bc588387c0c298379d11fea5e7">Surface::BlitEx</a>(<a class="code" href="structrtRectf.html">rtRectf</a> <a class="code" href="Renderer_2GL_2glext_8h.html#a85e59cd56e10d0a7f49ab199f277d486">dst</a>, <a class="code" href="structrtRectf.html">rtRectf</a> <a class="code" href="Renderer_2GL_2glext_8h.html#a2a98ddb6f79ec1048ff9e15cdd2422ba">src</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> rgba, <span class="keywordtype">float</span> rotation, CL_Vec2f vRotatePt)
<a name="l00634"></a>00634 {
<a name="l00635"></a>00635         <span class="keywordflow">if</span> (!<a class="code" href="classSurface.html#a4aca7c1c90309c3b94c743e265788d59">IsLoaded</a>()) <span class="keywordflow">return</span>;
<a name="l00636"></a>00636 
<a name="l00637"></a>00637         <span class="keywordflow">if</span> (dst.<a class="code" href="structrtRectf.html#a3e501be99ba737fa872ba2b2f46cbc22">bottom</a> &lt; 0) <span class="keywordflow">return</span>;
<a name="l00638"></a>00638         <span class="keywordflow">if</span> (dst.<a class="code" href="structrtRectf.html#a9b3d0f8a066c23d58f29bf61d165f97a">top</a> &gt; <a class="code" href="GLESUtils_8cpp.html#a45e5c79ef6e83cc998fd8b6be83f2e1a">GetOrthoRenderSizeYf</a>()) <span class="keywordflow">return</span>;
<a name="l00639"></a>00639 
<a name="l00640"></a>00640         <span class="keywordflow">if</span> ( GET_ALPHA(rgba) == 0)
<a name="l00641"></a>00641         {
<a name="l00642"></a>00642                 <span class="keywordflow">return</span>; 
<a name="l00643"></a>00643         }
<a name="l00644"></a>00644 
<a name="l00645"></a>00645 <span class="keywordflow">if</span> (<a class="code" href="BaseApp_8h.html#a72086b48d24daf0a65dd20189a16bd16">GetBaseApp</a>()-&gt;GetDisableSubPixelBlits())
<a name="l00646"></a>00646 {
<a name="l00647"></a>00647         <span class="comment">//fix issue for cracks when scaling when 2d tile blits</span>
<a name="l00648"></a>00648 
<a name="l00649"></a>00649         dst.<a class="code" href="structrtRectf.html#a567b9e4d9febb9bf7f338f416e94a688">left</a> = ceil(dst.<a class="code" href="structrtRectf.html#a567b9e4d9febb9bf7f338f416e94a688">left</a>)+<a class="code" href="Surface_8cpp.html#ae5d566b86069d941bacc12c20216daad">C_TEXEL_HACK_AMOUNT</a>;
<a name="l00650"></a>00650         dst.<a class="code" href="structrtRectf.html#a9b3d0f8a066c23d58f29bf61d165f97a">top</a> = ceil(dst.<a class="code" href="structrtRectf.html#a9b3d0f8a066c23d58f29bf61d165f97a">top</a>)+<a class="code" href="Surface_8cpp.html#ae5d566b86069d941bacc12c20216daad">C_TEXEL_HACK_AMOUNT</a>;
<a name="l00651"></a>00651         dst.<a class="code" href="structrtRectf.html#a3e501be99ba737fa872ba2b2f46cbc22">bottom</a> = ceil(dst.<a class="code" href="structrtRectf.html#a3e501be99ba737fa872ba2b2f46cbc22">bottom</a>)-<a class="code" href="Surface_8cpp.html#ae5d566b86069d941bacc12c20216daad">C_TEXEL_HACK_AMOUNT</a>;
<a name="l00652"></a>00652         dst.<a class="code" href="structrtRectf.html#a336746497039c6656a3120fc5870df94">right</a> = ceil(dst.<a class="code" href="structrtRectf.html#a336746497039c6656a3120fc5870df94">right</a>)-<a class="code" href="Surface_8cpp.html#ae5d566b86069d941bacc12c20216daad">C_TEXEL_HACK_AMOUNT</a>;;
<a name="l00653"></a>00653 }
<a name="l00654"></a>00654 
<a name="l00655"></a>00655 
<a name="l00656"></a>00656         <a class="code" href="classSurface.html#a5a935ed6a6c8d170f7f2ccb8f2461a2c">SetupForRender</a>(rotation, vRotatePt, rgba);
<a name="l00657"></a>00657 
<a name="l00658"></a>00658         <span class="keywordflow">if</span> (rotation != 0)
<a name="l00659"></a>00659         {
<a name="l00660"></a>00660                 dst.<a class="code" href="structrtRectf.html#a6dac806b02c4893fd57aad989929c2b8">AdjustPosition</a>(-vRotatePt.x, -vRotatePt.y);
<a name="l00661"></a>00661         }
<a name="l00662"></a>00662 
<a name="l00663"></a>00663         <span class="comment">//      0 1</span>
<a name="l00664"></a>00664         <span class="comment">//      3 2</span>
<a name="l00665"></a>00665 
<a name="l00666"></a>00666         <span class="keyword">static</span> <a class="code" href="flash_2GLES_2gl_8h.html#a836cf6377099e88abf24c255b5b0ac52">GLfloat</a>  vertices[3*4];
<a name="l00667"></a>00667 
<a name="l00668"></a>00668         vertices[0*3+0] = dst.<a class="code" href="structrtRectf.html#a567b9e4d9febb9bf7f338f416e94a688">left</a>; vertices[0*3+1] = dst.<a class="code" href="structrtRectf.html#a9b3d0f8a066c23d58f29bf61d165f97a">top</a>;
<a name="l00669"></a>00669         vertices[1*3+0] = dst.<a class="code" href="structrtRectf.html#a336746497039c6656a3120fc5870df94">right</a>; vertices[1*3+1] = dst.<a class="code" href="structrtRectf.html#a9b3d0f8a066c23d58f29bf61d165f97a">top</a>;
<a name="l00670"></a>00670         vertices[2*3+0] = dst.<a class="code" href="structrtRectf.html#a336746497039c6656a3120fc5870df94">right</a>; vertices[2*3+1] = dst.<a class="code" href="structrtRectf.html#a3e501be99ba737fa872ba2b2f46cbc22">bottom</a>;
<a name="l00671"></a>00671         vertices[3*3+0] = dst.<a class="code" href="structrtRectf.html#a567b9e4d9febb9bf7f338f416e94a688">left</a>; vertices[3*3+1] = dst.<a class="code" href="structrtRectf.html#a3e501be99ba737fa872ba2b2f46cbc22">bottom</a>;
<a name="l00672"></a>00672 
<a name="l00673"></a>00673         <span class="comment">//set the Z</span>
<a name="l00674"></a>00674         vertices[0*3+2] = 0;
<a name="l00675"></a>00675         vertices[1*3+2] = 0;
<a name="l00676"></a>00676         vertices[2*3+2] = 0;
<a name="l00677"></a>00677         vertices[3*3+2] = 0;
<a name="l00678"></a>00678 
<a name="l00679"></a>00679 
<a name="l00680"></a>00680         <span class="keyword">static</span> <a class="code" href="flash_2GLES_2gl_8h.html#a836cf6377099e88abf24c255b5b0ac52">GLfloat</a> vTexCoords[8];
<a name="l00681"></a>00681         <span class="comment">//another step to convert the coordinates into ratios</span>
<a name="l00682"></a>00682         <span class="keyword">static</span> <span class="keywordtype">float</span> texW;
<a name="l00683"></a>00683         texW = float(m_originalWidth)/float(m_texWidth);
<a name="l00684"></a>00684         <span class="keyword">static</span> <span class="keywordtype">float</span> texH;
<a name="l00685"></a>00685         texH = float(m_originalHeight)/float(m_texHeight);
<a name="l00686"></a>00686         <span class="keyword">static</span> TexCoords *pTex;
<a name="l00687"></a>00687 
<a name="l00688"></a>00688         pTex = (TexCoords*)vTexCoords;
<a name="l00689"></a>00689 
<a name="l00690"></a>00690         <span class="comment">//vert 0</span>
<a name="l00691"></a>00691         pTex-&gt;x = src.<a class="code" href="structrtRectf.html#a567b9e4d9febb9bf7f338f416e94a688">left</a>/float(m_originalWidth) * texW;
<a name="l00692"></a>00692         pTex-&gt;y =  (1-texH) + texH*( (m_originalHeight-src.<a class="code" href="structrtRectf.html#a9b3d0f8a066c23d58f29bf61d165f97a">top</a>) /float(m_originalHeight));
<a name="l00693"></a>00693         pTex++;
<a name="l00694"></a>00694 
<a name="l00695"></a>00695         <span class="comment">//vert 1</span>
<a name="l00696"></a>00696         pTex-&gt;x = src.<a class="code" href="structrtRectf.html#a336746497039c6656a3120fc5870df94">right</a>/float(m_originalWidth) * texW;
<a name="l00697"></a>00697         pTex-&gt;y = (1-texH) + texH*( (m_originalHeight-src.<a class="code" href="structrtRectf.html#a9b3d0f8a066c23d58f29bf61d165f97a">top</a>) /float(m_originalHeight));
<a name="l00698"></a>00698         pTex++;
<a name="l00699"></a>00699 
<a name="l00700"></a>00700         <span class="comment">//vert 2</span>
<a name="l00701"></a>00701         pTex-&gt;x = src.<a class="code" href="structrtRectf.html#a336746497039c6656a3120fc5870df94">right</a>/float(m_originalWidth) * texW;
<a name="l00702"></a>00702         pTex-&gt;y = 1-(texH*(src.<a class="code" href="structrtRectf.html#a3e501be99ba737fa872ba2b2f46cbc22">bottom</a> /(float(m_originalHeight))));
<a name="l00703"></a>00703         pTex++;
<a name="l00704"></a>00704 
<a name="l00705"></a>00705         <span class="comment">//vert 3</span>
<a name="l00706"></a>00706         pTex-&gt;x = src.<a class="code" href="structrtRectf.html#a567b9e4d9febb9bf7f338f416e94a688">left</a>/float(m_originalWidth) * texW;
<a name="l00707"></a>00707         pTex-&gt;y = 1-(texH*(src.<a class="code" href="structrtRectf.html#a3e501be99ba737fa872ba2b2f46cbc22">bottom</a> /(float(m_originalHeight))));
<a name="l00708"></a>00708         pTex++;
<a name="l00709"></a>00709 
<a name="l00710"></a>00710         <a class="code" href="GLFlashAdaptor_8cpp.html#ae706b283dab261d2212bccd9bf30fc32">glVertexPointer</a>(3, GL_FLOAT, 0, vertices);
<a name="l00711"></a>00711         <a class="code" href="GLFlashAdaptor_8cpp.html#a908d9972fc3b4d93a9e71cce50c91fe6">glTexCoordPointer</a>(2, GL_FLOAT,  0, vTexCoords);
<a name="l00712"></a>00712 
<a name="l00713"></a>00713         <a class="code" href="GLFlashAdaptor_8cpp.html#a0e3de4d267f017c28a03fc4375a4b40e">glDrawArrays</a>(GL_TRIANGLE_FAN, 0, 4);
<a name="l00714"></a>00714         CHECK_GL_ERROR();
<a name="l00715"></a>00715         <a class="code" href="classSurface.html#af03298a6644c32ae745a6592b04e858c">EndRender</a>(rotation, rgba);
<a name="l00716"></a>00716 }
<a name="l00717"></a>00717 
<a name="l00718"></a><a class="code" href="classSurface.html#ae814688180d97d51cfbcc0fca9c88941">00718</a> <span class="keywordtype">void</span> <a class="code" href="classSurface.html#ae814688180d97d51cfbcc0fca9c88941">Surface::BlitScaled</a>( <span class="keywordtype">float</span> <a class="code" href="flash_2GLES_2glext_8h.html#a0cdec8e97a75ee9458b23d152bf962d4">x</a>, <span class="keywordtype">float</span> <a class="code" href="flash_2GLES_2glext_8h.html#a2532a9f8ed3a10a63f5e3c484fbfdb9b">y</a>, CL_Vec2f vScale, <a class="code" href="rtRect_8h.html#a74e9e3c1ad777682769717e601d606a7">eAlignment</a> alignment, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> rgba, <span class="keywordtype">float</span> rotation, <a class="code" href="classRenderBatcher.html">RenderBatcher</a> *pRenderBatcher)
<a name="l00719"></a>00719 {
<a name="l00720"></a>00720         <a class="code" href="classSurface.html#a08c850a2afce817b7ed46b77e45be473">BlitScaledWithRotatePoint</a>(x,y,vScale,alignment,rgba,rotation,CL_Vec2f(x,y), pRenderBatcher);
<a name="l00721"></a>00721 }
<a name="l00722"></a>00722 
<a name="l00723"></a><a class="code" href="classSurface.html#a08c850a2afce817b7ed46b77e45be473">00723</a> <span class="keywordtype">void</span> <a class="code" href="classSurface.html#a08c850a2afce817b7ed46b77e45be473">Surface::BlitScaledWithRotatePoint</a>( <span class="keywordtype">float</span> <a class="code" href="flash_2GLES_2glext_8h.html#a0cdec8e97a75ee9458b23d152bf962d4">x</a>, <span class="keywordtype">float</span> <a class="code" href="flash_2GLES_2glext_8h.html#a2532a9f8ed3a10a63f5e3c484fbfdb9b">y</a>, CL_Vec2f vScale, <a class="code" href="rtRect_8h.html#a74e9e3c1ad777682769717e601d606a7">eAlignment</a> alignment, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> rgba, <span class="keywordtype">float</span> rotation, CL_Vec2f vScreenRotationPt, <a class="code" href="classRenderBatcher.html">RenderBatcher</a> *pRenderBatcher)
<a name="l00724"></a>00724 {
<a name="l00725"></a>00725         
<a name="l00726"></a>00726         assert(vScale.x != 0 &amp;&amp; vScale.y != 0 &amp;&amp; <span class="stringliteral">&quot;Dahell?&quot;</span>);
<a name="l00727"></a>00727 
<a name="l00728"></a>00728         CL_Vec2f vStart = CL_Vec2f(x,y);
<a name="l00729"></a>00729         <a class="code" href="structrtRectf.html">rtRectf</a> <a class="code" href="Renderer_2GL_2glext_8h.html#a2a98ddb6f79ec1048ff9e15cdd2422ba">src</a>(0,0,(<span class="keywordtype">float</span>)m_originalWidth,(<span class="keywordtype">float</span>)m_originalHeight);
<a name="l00730"></a>00730         <a class="code" href="structrtRectf.html">rtRectf</a> <a class="code" href="Renderer_2GL_2glext_8h.html#a85e59cd56e10d0a7f49ab199f277d486">dst</a> = <a class="code" href="Renderer_2GL_2glext_8h.html#a2a98ddb6f79ec1048ff9e15cdd2422ba">src</a>;
<a name="l00731"></a>00731         vStart -= <a class="code" href="MathUtils_8cpp.html#a0075799e856bbdc507cf52fc8802a83f">GetAlignmentOffset</a>(CL_Vec2f(<span class="keywordtype">float</span>(m_originalWidth), <span class="keywordtype">float</span>(m_originalHeight)), <a class="code" href="rtRect_8h.html#a74e9e3c1ad777682769717e601d606a7">eAlignment</a>(alignment));
<a name="l00732"></a>00732         dst.<a class="code" href="structrtRectf.html#a6dac806b02c4893fd57aad989929c2b8">AdjustPosition</a>(vStart.x, vStart.y);
<a name="l00733"></a>00733         dst.<a class="code" href="structrtRectf.html#af4a0200a89d2a90c42f2ad43589169d6">Scale</a>(alignment, vScale);
<a name="l00734"></a>00734 
<a name="l00735"></a>00735         <span class="keywordflow">if</span> (pRenderBatcher)
<a name="l00736"></a>00736         {
<a name="l00737"></a>00737                 <span class="comment">//rotation ignored for now</span>
<a name="l00738"></a>00738                 pRenderBatcher-&gt;<a class="code" href="classRenderBatcher.html#aec5ab5ee7f748838b50fa762f96a4a8c">BlitEx</a>(<span class="keyword">this</span>, dst, src, rgba);
<a name="l00739"></a>00739         } <span class="keywordflow">else</span>
<a name="l00740"></a>00740         {
<a name="l00741"></a>00741                 <a class="code" href="classSurface.html#a950bb7bc588387c0c298379d11fea5e7">BlitEx</a>(dst, src, rgba, rotation, vScreenRotationPt);
<a name="l00742"></a>00742         }
<a name="l00743"></a>00743 }
<a name="l00744"></a>00744 
<a name="l00745"></a>00745 
<a name="l00746"></a><a class="code" href="classSurface.html#ab8c438df4dec89d79660fb907233c493">00746</a> <span class="keywordtype">void</span> <a class="code" href="classSurface.html#ab8c438df4dec89d79660fb907233c493">Surface::Blit</a>( <span class="keywordtype">float</span> <a class="code" href="flash_2GLES_2glext_8h.html#a0cdec8e97a75ee9458b23d152bf962d4">x</a>, <span class="keywordtype">float</span> <a class="code" href="flash_2GLES_2glext_8h.html#a2532a9f8ed3a10a63f5e3c484fbfdb9b">y</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> rgba, <span class="keywordtype">float</span> rotationDegrees, CL_Vec2f vRotatePt)
<a name="l00747"></a>00747 {
<a name="l00748"></a>00748         <span class="keywordflow">if</span> (!<a class="code" href="classSurface.html#a4aca7c1c90309c3b94c743e265788d59">IsLoaded</a>()) <span class="keywordflow">return</span>;
<a name="l00749"></a>00749 
<a name="l00750"></a>00750         <span class="keywordflow">if</span> (<a class="code" href="BaseApp_8h.html#a72086b48d24daf0a65dd20189a16bd16">GetBaseApp</a>()-&gt;GetDisableSubPixelBlits())
<a name="l00751"></a>00751         {
<a name="l00752"></a>00752                 <span class="comment">//fix issue for cracks when scaling when 2d tile blits</span>
<a name="l00753"></a>00753                 x = ceil(x);
<a name="l00754"></a>00754                 y = ceil(y);
<a name="l00755"></a>00755         }
<a name="l00756"></a>00756 
<a name="l00757"></a>00757         <span class="keywordflow">if</span> (rotationDegrees != 0)
<a name="l00758"></a>00758         {
<a name="l00759"></a>00759                 x -= vRotatePt.x;
<a name="l00760"></a>00760                 y -= vRotatePt.y;
<a name="l00761"></a>00761         }
<a name="l00762"></a>00762 
<a name="l00763"></a>00763         <a class="code" href="classSurface.html#a5a935ed6a6c8d170f7f2ccb8f2461a2c">SetupForRender</a>(rotationDegrees, vRotatePt, rgba);
<a name="l00764"></a>00764 
<a name="l00765"></a>00765         <span class="comment">//LogMsg(&quot;Rendering tex %d at %.2f ,%.2f at time %d&quot;, m_glTextureID, x,y, GetTick(TIMER_GAME));</span>
<a name="l00766"></a>00766 
<a name="l00767"></a>00767         <a class="code" href="flash_2GLES_2gl_8h.html#a836cf6377099e88abf24c255b5b0ac52">GLfloat</a> vertices[] = {
<a name="l00768"></a>00768                 <a class="code" href="flash_2GLES_2glext_8h.html#a0cdec8e97a75ee9458b23d152bf962d4">x</a>,                      <a class="code" href="flash_2GLES_2glext_8h.html#a2532a9f8ed3a10a63f5e3c484fbfdb9b">y</a>,                      0.0,
<a name="l00769"></a>00769                 x + m_originalWidth,            <a class="code" href="flash_2GLES_2glext_8h.html#a2532a9f8ed3a10a63f5e3c484fbfdb9b">y</a>,                      0.0,
<a name="l00770"></a>00770                 x + m_originalWidth,            m_originalHeight+<a class="code" href="flash_2GLES_2glext_8h.html#a2532a9f8ed3a10a63f5e3c484fbfdb9b">y</a>,             0.0,
<a name="l00771"></a>00771                 <a class="code" href="flash_2GLES_2glext_8h.html#a0cdec8e97a75ee9458b23d152bf962d4">x</a> ,                     m_originalHeight+<a class="code" href="flash_2GLES_2glext_8h.html#a2532a9f8ed3a10a63f5e3c484fbfdb9b">y</a>,             0.0 };
<a name="l00772"></a>00772 
<a name="l00773"></a>00773                 <span class="comment">//3 2</span>
<a name="l00774"></a>00774                 <span class="comment">//0 1</span>
<a name="l00775"></a>00775                 
<a name="l00776"></a>00776                 <span class="keywordtype">float</span> texW = float(m_originalWidth)/float(m_texWidth);
<a name="l00777"></a>00777                 <span class="keywordtype">float</span> texH = float(m_originalHeight)/float(m_texHeight);
<a name="l00778"></a>00778 
<a name="l00779"></a>00779                 <a class="code" href="flash_2GLES_2gl_8h.html#a836cf6377099e88abf24c255b5b0ac52">GLfloat</a> vTexCoords[] = 
<a name="l00780"></a>00780                 {
<a name="l00781"></a>00781                         0, 1,
<a name="l00782"></a>00782                         texW, 1,
<a name="l00783"></a>00783                         texW, 1-texH,
<a name="l00784"></a>00784                         0, 1-texH
<a name="l00785"></a>00785                 };
<a name="l00786"></a>00786         
<a name="l00787"></a>00787                 <a class="code" href="GLFlashAdaptor_8cpp.html#ae706b283dab261d2212bccd9bf30fc32">glVertexPointer</a>(3, GL_FLOAT, 0, vertices);
<a name="l00788"></a>00788                 <a class="code" href="GLFlashAdaptor_8cpp.html#a908d9972fc3b4d93a9e71cce50c91fe6">glTexCoordPointer</a>(2, GL_FLOAT,  0, vTexCoords);
<a name="l00789"></a>00789                 CHECK_GL_ERROR();
<a name="l00790"></a>00790 
<a name="l00791"></a>00791                 assert((rgba&amp;0xFF)*256 != 0 &amp;&amp; <span class="stringliteral">&quot;Why send something with zero alpha?&quot;</span>);
<a name="l00792"></a>00792         
<a name="l00793"></a>00793                 <a class="code" href="GLFlashAdaptor_8cpp.html#a0e3de4d267f017c28a03fc4375a4b40e">glDrawArrays</a>(GL_TRIANGLE_FAN, 0, 4);
<a name="l00794"></a>00794                 CHECK_GL_ERROR();
<a name="l00795"></a>00795 
<a name="l00796"></a>00796                 <a class="code" href="classSurface.html#af03298a6644c32ae745a6592b04e858c">EndRender</a>(rotationDegrees, rgba);
<a name="l00797"></a>00797 }
<a name="l00798"></a>00798 
<a name="l00799"></a><a class="code" href="classSurface.html#a1c4b9b981a4131f8c94c491adc5d039b">00799</a> <span class="keywordtype">void</span> <a class="code" href="classSurface.html#a1c4b9b981a4131f8c94c491adc5d039b" title="Sets the texture type for this Surface.">Surface::SetTextureType</a>( <a class="code" href="classSurface.html#a6d321b09caff273d52719177b0c408ce" title="Type for the texture that the Surface class uses.">eTextureType</a> <a class="code" href="eglext_8h.html#a890efa53b3d7deeeced6f3a0d6653ed3">type</a> )
<a name="l00800"></a>00800 {
<a name="l00801"></a>00801         assert(!<a class="code" href="classSurface.html#a4aca7c1c90309c3b94c743e265788d59">IsLoaded</a>() &amp;&amp; <span class="stringliteral">&quot;You should change this to able to work on an existing texture&quot;</span>);
<a name="l00802"></a>00802         m_texType = <a class="code" href="eglext_8h.html#a890efa53b3d7deeeced6f3a0d6653ed3">type</a>;
<a name="l00803"></a>00803 }
<a name="l00804"></a>00804 
<a name="l00805"></a><a class="code" href="classSurface.html#a8617ddf72cb01037f2c746e837c181e9">00805</a> <span class="keywordtype">void</span> <a class="code" href="classSurface.html#a8617ddf72cb01037f2c746e837c181e9">Surface::SetSmoothing</a>( <span class="keywordtype">bool</span> bSmoothing )
<a name="l00806"></a>00806 {
<a name="l00807"></a>00807         <span class="keywordflow">if</span> (<a class="code" href="classSurface.html#a4aca7c1c90309c3b94c743e265788d59">IsLoaded</a>())
<a name="l00808"></a>00808         {
<a name="l00809"></a>00809                 <a class="code" href="classSurface.html#a657e4c9e9bbd5727c205e622f057f6f8">Bind</a>();
<a name="l00810"></a>00810                 <span class="keywordflow">if</span> (!bSmoothing)
<a name="l00811"></a>00811                 {
<a name="l00812"></a>00812                         <a class="code" href="GLFlashAdaptor_8cpp.html#a62645f8035cbae532cd6181201188e2e">glTexParameterx</a>( GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_NEAREST );
<a name="l00813"></a>00813                         <a class="code" href="GLFlashAdaptor_8cpp.html#a62645f8035cbae532cd6181201188e2e">glTexParameterx</a>( GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_NEAREST );
<a name="l00814"></a>00814                 } <span class="keywordflow">else</span>
<a name="l00815"></a>00815                 {
<a name="l00816"></a>00816                         <a class="code" href="GLFlashAdaptor_8cpp.html#a62645f8035cbae532cd6181201188e2e">glTexParameterx</a>( GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR );
<a name="l00817"></a>00817                         <a class="code" href="GLFlashAdaptor_8cpp.html#a62645f8035cbae532cd6181201188e2e">glTexParameterx</a>( GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR );
<a name="l00818"></a>00818                 }
<a name="l00819"></a>00819         }
<a name="l00820"></a>00820 
<a name="l00821"></a>00821         m_bSmoothing = bSmoothing; <span class="comment">//remember for later if we have to restore surfaces</span>
<a name="l00822"></a>00822 }
<a name="l00823"></a>00823 
<a name="l00824"></a>00824 <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;
<a name="l00825"></a><a class="code" href="Surface_8cpp.html#a3f473c59c1ec1056a29214db61ab00a7">00825</a> T <a class="code" href="Surface_8cpp.html#a3f473c59c1ec1056a29214db61ab00a7">nextPowerOfTwo</a>(T <a class="code" href="Renderer_2GL_2glext_8h.html#a0788d3762d0c3c76e4c094d8078b4c27">n</a>)
<a name="l00826"></a>00826 {
<a name="l00827"></a>00827         std::size_t k=1;
<a name="l00828"></a>00828         --<a class="code" href="Renderer_2GL_2glext_8h.html#a0788d3762d0c3c76e4c094d8078b4c27">n</a>;
<a name="l00829"></a>00829         <span class="keywordflow">do</span> {
<a name="l00830"></a>00830                 n |= n &gt;&gt; k;
<a name="l00831"></a>00831                 k &lt;&lt;= 1;
<a name="l00832"></a>00832         } <span class="keywordflow">while</span> (n &amp; (n + 1));
<a name="l00833"></a>00833         <span class="keywordflow">return</span> n + 1;
<a name="l00834"></a>00834 }
<a name="l00835"></a>00835 
<a name="l00836"></a>00836 
<a name="l00837"></a>00837 <span class="comment">/*</span><span class="comment"></span>
<a name="l00838"></a>00838 <span class="comment">//! Bind Render Target Texture</span>
<a name="l00839"></a>00839 <span class="comment"></span>void COGLES1Texture::bindRTT()
<a name="l00840"></a>00840 {
<a name="l00841"></a>00841         glViewport(0, 0, getSize().Width, getSize().Height);
<a name="l00842"></a>00842 }
<a name="l00843"></a>00843 
<a name="l00844"></a>00844 <span class="comment"></span>
<a name="l00845"></a>00845 <span class="comment">//! Unbind Render Target Texture</span>
<a name="l00846"></a>00846 <span class="comment"></span>void COGLES1Texture::unbindRTT()
<a name="l00847"></a>00847 {
<a name="l00848"></a>00848         glBindTexture(GL_TEXTURE_2D, getOGLES1TextureName());
<a name="l00849"></a>00849 
<a name="l00850"></a>00850         // Copy Our ViewPort To The Texture
<a name="l00851"></a>00851         glCopyTexSubImage2D(GL_TEXTURE_2D, 0, 0, 0, 0, 0, getSize().Width, getSize().Height);
<a name="l00852"></a>00852 }
<a name="l00853"></a>00853 */
<a name="l00854"></a>00854 
<a name="l00855"></a>00855 
<a name="l00856"></a><a class="code" href="Surface_8cpp.html#a647f61cf175b4b5e42b25fc1cb69aca9">00856</a> <span class="keyword">enum</span> <a class="code" href="Surface_8cpp.html#a647f61cf175b4b5e42b25fc1cb69aca9">eBlitMode</a>
<a name="l00857"></a>00857 {
<a name="l00858"></a><a class="code" href="Surface_8cpp.html#a647f61cf175b4b5e42b25fc1cb69aca9a96e0b23d0b5182ecf83c13a50a46e0f7">00858</a>         <a class="code" href="Surface_8cpp.html#a647f61cf175b4b5e42b25fc1cb69aca9a96e0b23d0b5182ecf83c13a50a46e0f7">BLIT_MODE_NORMAL</a>,
<a name="l00859"></a><a class="code" href="Surface_8cpp.html#a647f61cf175b4b5e42b25fc1cb69aca9acdf312e0b9713d4849163c873fc6705a">00859</a>         <a class="code" href="Surface_8cpp.html#a647f61cf175b4b5e42b25fc1cb69aca9acdf312e0b9713d4849163c873fc6705a">BLIT_MODE_ROTATE_LEFT</a>
<a name="l00860"></a>00860 };
<a name="l00861"></a>00861 
<a name="l00862"></a><a class="code" href="Surface_8cpp.html#a05834ad966fd924c9f5aafc1a242ecd0">00862</a> <span class="keywordtype">void</span> <a class="code" href="Surface_8cpp.html#a05834ad966fd924c9f5aafc1a242ecd0">BlitBmp</a>(<span class="keywordtype">int</span> posX, <span class="keywordtype">int</span> posY, <a class="code" href="PlatformSetupAndroid_8h.html#ab8ef12fab634c171394422d0ee8baf94">byte</a> *pDest, <span class="keywordtype">int</span> <a class="code" href="Renderer_2GL_2glext_8h.html#a77ca91b97fba539ad60562725e8dd838">dstX</a>, <span class="keywordtype">int</span> <a class="code" href="Renderer_2GL_2glext_8h.html#a21939fb92a25aa503f1f212e948ce515">dstY</a>, <span class="keywordtype">int</span> dstPixelType, <a class="code" href="PlatformSetupAndroid_8h.html#ab8ef12fab634c171394422d0ee8baf94">byte</a> *pSrc, <span class="keywordtype">int</span> <a class="code" href="Renderer_2GL_2glext_8h.html#ae3f0313bc06be5a5b7b061636435357d">srcX</a>, <span class="keywordtype">int</span> <a class="code" href="Renderer_2GL_2glext_8h.html#af4b365bb510504af575e0ec6c9edb44c">srcY</a>, <span class="keywordtype">int</span> srcPixelType, <a class="code" href="Surface_8cpp.html#a647f61cf175b4b5e42b25fc1cb69aca9">eBlitMode</a> <a class="code" href="eglext_8h.html#a1e71d9c196e4683cc06c4b54d53f7ef5">mode</a>)
<a name="l00863"></a>00863 {
<a name="l00864"></a>00864         assert(dstPixelType == GL_RGBA &amp;&amp; srcPixelType == GL_RGBA);
<a name="l00865"></a>00865 
<a name="l00866"></a>00866         <span class="keywordtype">int</span> dstBytesPerPix = 4;
<a name="l00867"></a>00867         <span class="keywordtype">int</span> dstPitch = dstX*dstBytesPerPix;
<a name="l00868"></a>00868 
<a name="l00869"></a>00869         <span class="comment">//memset(pDest+dstPitch, 0, dstX* (dstY-10 )*4 );</span>
<a name="l00870"></a>00870 
<a name="l00871"></a>00871         <span class="comment">//return;</span>
<a name="l00872"></a>00872 
<a name="l00873"></a>00873         <a class="code" href="PlatformSetupAndroid_8h.html#ab8ef12fab634c171394422d0ee8baf94">byte</a> *pDstCur = pDest+(  (posY+ (dstY-<a class="code" href="Renderer_2GL_2glext_8h.html#af4b365bb510504af575e0ec6c9edb44c">srcY</a>)   )*dstPitch)+posX;
<a name="l00874"></a>00874 
<a name="l00875"></a>00875         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="flash_2GLES_2glext_8h.html#a2532a9f8ed3a10a63f5e3c484fbfdb9b">y</a>=0; <a class="code" href="flash_2GLES_2glext_8h.html#a2532a9f8ed3a10a63f5e3c484fbfdb9b">y</a> &lt; <a class="code" href="Renderer_2GL_2glext_8h.html#af4b365bb510504af575e0ec6c9edb44c">srcY</a>; <a class="code" href="flash_2GLES_2glext_8h.html#a2532a9f8ed3a10a63f5e3c484fbfdb9b">y</a>++)
<a name="l00876"></a>00876         {
<a name="l00877"></a>00877                 memcpy(pDstCur, pSrc, srcX*dstBytesPerPix);
<a name="l00878"></a>00878                 pSrc += srcX*dstBytesPerPix;
<a name="l00879"></a>00879                 pDstCur += dstPitch;
<a name="l00880"></a>00880         }
<a name="l00881"></a>00881 }
<a name="l00882"></a>00882 
<a name="l00883"></a><a class="code" href="classSurface.html#a6d1cb49fe57336f4f2c9a667f79dafd0">00883</a> <span class="keywordtype">void</span> <a class="code" href="classSurface.html#a6d1cb49fe57336f4f2c9a667f79dafd0">Surface::CopyFromScreen</a>()
<a name="l00884"></a>00884 {
<a name="l00885"></a>00885         <span class="keywordtype">int</span> readX = <a class="code" href="AndroidUtils_8cpp.html#a2f0e58aac06a13b950cef03dcc3e7267">GetPrimaryGLX</a>();
<a name="l00886"></a>00886         <span class="keywordtype">int</span> readY = <a class="code" href="AndroidUtils_8cpp.html#ac274a49195455502331eb617bce938e3">GetPrimaryGLY</a>();
<a name="l00887"></a>00887 
<a name="l00888"></a>00888         <span class="keywordtype">int</span> bytesPerPix = 4;
<a name="l00889"></a>00889 
<a name="l00890"></a>00890         <a class="code" href="PlatformSetupAndroid_8h.html#ab8ef12fab634c171394422d0ee8baf94">byte</a> * pBuff = <span class="keyword">new</span> <a class="code" href="PlatformSetupAndroid_8h.html#ab8ef12fab634c171394422d0ee8baf94">byte</a> [readX*readY*bytesPerPix];
<a name="l00891"></a>00891 
<a name="l00892"></a>00892         <span class="comment">//rotate it before we copy it</span>
<a name="l00893"></a>00893         <span class="keywordtype">int</span> <a class="code" href="Renderer_2GL_2glext_8h.html#af4b365bb510504af575e0ec6c9edb44c">srcY</a> = 0;
<a name="l00894"></a>00894 
<a name="l00895"></a>00895         <a class="code" href="GLFlashAdaptor_8cpp.html#a00f3878abb7f04e17db9ee5a3840fc9f">glReadPixels</a>(0, srcY, readX, readY, GL_RGBA, GL_UNSIGNED_BYTE, pBuff);
<a name="l00896"></a>00896         CHECK_GL_ERROR();
<a name="l00897"></a>00897         <span class="comment">//now copy it to our texture</span>
<a name="l00898"></a>00898         assert(m_glTextureID != NO_TEXTURE_LOADED &amp;&amp; <span class="stringliteral">&quot;Texture can&#39;t be used yet&quot;</span>);
<a name="l00899"></a>00899 
<a name="l00900"></a>00900         <span class="comment">//BlitBmp(0,0, pFinal, m_texWidth, m_texHeight, GL_RGBA, pBuff, readX, readY, GL_RGBA, BLIT_MODE_ROTATE_LEFT);</span>
<a name="l00901"></a>00901 
<a name="l00902"></a>00902         <a class="code" href="classSurface.html#a657e4c9e9bbd5727c205e622f057f6f8">Bind</a>();
<a name="l00903"></a>00903         <span class="comment">//glTexImage2D( GL_TEXTURE_2D, 0, GL_RGBA, m_texWidth, m_texHeight, 0, GL_RGBA, GL_UNSIGNED_BYTE,  pFinal );</span>
<a name="l00904"></a>00904         <a class="code" href="GLFlashAdaptor_8cpp.html#a8a333af9c76c518419c54ed92587c987">glTexSubImage2D</a>(GL_TEXTURE_2D, 0, 0, m_texHeight-readY, readX, readY, GL_RGBA, GL_UNSIGNED_BYTE, pBuff);
<a name="l00905"></a>00905         CHECK_GL_ERROR();
<a name="l00906"></a>00906         <span class="keyword">delete</span> [] pBuff;
<a name="l00907"></a>00907 }
<a name="l00908"></a>00908 
<a name="l00909"></a>00909 
<a name="l00910"></a><a class="code" href="classSurface.html#abb46f5d897ea58de0fbf2f9381eac9bb">00910</a> <span class="keywordtype">void</span> <a class="code" href="classSurface.html#abb46f5d897ea58de0fbf2f9381eac9bb">Surface::FillColor</a>(<a class="code" href="structglColorBytes.html">glColorBytes</a> <a class="code" href="Renderer_2GL_2glext_8h.html#a3ea846f998d64f079b86052b6c4193a8">color</a>)
<a name="l00911"></a>00911 {
<a name="l00912"></a>00912         <span class="keywordtype">int</span> width = <a class="code" href="classSurface.html#ac9f7d001a0953d80de72bf09d9d112af">GetWidth</a>();
<a name="l00913"></a>00913         <span class="keywordtype">int</span> height = <a class="code" href="classSurface.html#a4dce812ee71b425cfdb675ec231d25d9">GetHeight</a>();
<a name="l00914"></a>00914         <span class="keywordtype">int</span> bytesPerPixel = 4;
<a name="l00915"></a>00915 
<a name="l00916"></a>00916         <a class="code" href="PlatformSetupAndroid_8h.html#ab8ef12fab634c171394422d0ee8baf94">byte</a> *pBuf = <span class="keyword">new</span> <a class="code" href="PlatformSetupAndroid_8h.html#ab8ef12fab634c171394422d0ee8baf94">byte</a>[width*height*bytesPerPixel];
<a name="l00917"></a>00917         
<a name="l00918"></a>00918         <a class="code" href="structglColorBytes.html">glColorBytes</a> *pPixel = (<a class="code" href="structglColorBytes.html">glColorBytes</a>*)pBuf;
<a name="l00919"></a>00919         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; width*<a class="code" href="flash_2GLES_2glext_8h.html#aedd0ea77029b98ce91e47c19addcb68f">height</a>; i++)
<a name="l00920"></a>00920         {
<a name="l00921"></a>00921                 *pPixel = <a class="code" href="Renderer_2GL_2glext_8h.html#a3ea846f998d64f079b86052b6c4193a8">color</a>;
<a name="l00922"></a>00922                 pPixel++;
<a name="l00923"></a>00923         }
<a name="l00924"></a>00924 
<a name="l00925"></a>00925         <a class="code" href="classSurface.html#a084423f19b22e8a941757a31cfd20d9a">UpdateSurfaceRect</a>(<a class="code" href="structrtRect.html">rtRect</a>(0,0,width,height), pBuf);
<a name="l00926"></a>00926         <span class="keyword">delete</span> [] pBuf;
<a name="l00927"></a>00927 }
<a name="l00928"></a>00928 
<a name="l00929"></a><a class="code" href="classSurface.html#a084423f19b22e8a941757a31cfd20d9a">00929</a> <span class="keywordtype">void</span> <a class="code" href="classSurface.html#a084423f19b22e8a941757a31cfd20d9a">Surface::UpdateSurfaceRect</a>(<a class="code" href="structrtRect.html">rtRect</a> dstRect, <a class="code" href="PlatformSetupAndroid_8h.html#ab8ef12fab634c171394422d0ee8baf94">byte</a> *pPixelData, <span class="keywordtype">bool</span> bUpsideDownMode)
<a name="l00930"></a>00930 {
<a name="l00931"></a>00931         <a class="code" href="classSurface.html#a657e4c9e9bbd5727c205e622f057f6f8">Bind</a>();
<a name="l00932"></a>00932         <span class="keywordtype">int</span> yStart = dstRect.<a class="code" href="structrtRect.html#a0b0ff87ec53461beae29aeb4d42b9eb9">top</a>;
<a name="l00933"></a>00933         
<a name="l00934"></a>00934         <span class="keywordflow">if</span> (bUpsideDownMode)
<a name="l00935"></a>00935         {
<a name="l00936"></a>00936                 yStart += (m_texHeight-m_originalHeight);
<a name="l00937"></a>00937         } 
<a name="l00938"></a>00938 
<a name="l00939"></a>00939         <a class="code" href="GLFlashAdaptor_8cpp.html#a8a333af9c76c518419c54ed92587c987">glTexSubImage2D</a>(GL_TEXTURE_2D, 0, dstRect.<a class="code" href="structrtRect.html#a7029bbd808da55ddcfbcaf4843c4cf93">left</a>, yStart, dstRect.<a class="code" href="structrtRect.html#a49dc0dd63ad0550be72db1b27bdfcd55">GetWidth</a>(), dstRect.<a class="code" href="structrtRect.html#a08e5d1a005020fd08aa6bcb40f01e04a">GetHeight</a>(), GL_RGBA, GL_UNSIGNED_BYTE, pPixelData);
<a name="l00940"></a>00940         CHECK_GL_ERROR();
<a name="l00941"></a>00941 }
<a name="l00942"></a>00942 
<a name="l00943"></a>00943 <span class="keywordtype">void</span> Surface::SetTextureStates()
<a name="l00944"></a>00944 {
<a name="l00945"></a>00945 
<a name="l00946"></a>00946         <span class="keywordflow">switch</span>(m_texType)
<a name="l00947"></a>00947         {
<a name="l00948"></a>00948         <span class="keywordflow">case</span> <a class="code" href="classSurface.html#a6d321b09caff273d52719177b0c408cea296c041ee91c00e9f0b453242c8375a1" title="Linear filtering, wrap mode is repeat, uses mipmaps.">TYPE_DEFAULT</a>:
<a name="l00949"></a>00949                 <a class="code" href="GLFlashAdaptor_8cpp.html#a62645f8035cbae532cd6181201188e2e">glTexParameterx</a>( GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR );
<a name="l00950"></a>00950                 <a class="code" href="GLFlashAdaptor_8cpp.html#a62645f8035cbae532cd6181201188e2e">glTexParameterx</a>( GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR );
<a name="l00951"></a>00951                 <a class="code" href="GLFlashAdaptor_8cpp.html#a62645f8035cbae532cd6181201188e2e">glTexParameterx</a>( GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_REPEAT );
<a name="l00952"></a>00952                 <a class="code" href="GLFlashAdaptor_8cpp.html#a62645f8035cbae532cd6181201188e2e">glTexParameterx</a>( GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_REPEAT );
<a name="l00953"></a>00953 
<a name="l00954"></a>00954                 <span class="keywordflow">if</span> (m_mipMapCount &gt; 1)
<a name="l00955"></a>00955                 {
<a name="l00956"></a>00956                         <a class="code" href="GLFlashAdaptor_8cpp.html#a51b865e78bb9b11d7260030e3307852c">glTexParameteri</a>( GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR_MIPMAP_NEAREST );
<a name="l00957"></a>00957                         <a class="code" href="GLFlashAdaptor_8cpp.html#a51b865e78bb9b11d7260030e3307852c">glTexParameteri</a>( GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
<a name="l00958"></a>00958                 }
<a name="l00959"></a>00959                 <span class="keywordflow">break</span>;
<a name="l00960"></a>00960 
<a name="l00961"></a>00961         <span class="keywordflow">case</span> <a class="code" href="classSurface.html#a6d321b09caff273d52719177b0c408ceae840610a4d9d8760213a1182a537a91d" title="Linear filtering, wrap mode is clamp to edge, no mipmaps.">TYPE_GUI</a>:
<a name="l00962"></a>00962                 <a class="code" href="GLFlashAdaptor_8cpp.html#a62645f8035cbae532cd6181201188e2e">glTexParameterx</a>( GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR );
<a name="l00963"></a>00963                 <a class="code" href="GLFlashAdaptor_8cpp.html#a62645f8035cbae532cd6181201188e2e">glTexParameterx</a>( GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR );
<a name="l00964"></a>00964                 <a class="code" href="GLFlashAdaptor_8cpp.html#a51b865e78bb9b11d7260030e3307852c">glTexParameteri</a>(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);
<a name="l00965"></a>00965                 <a class="code" href="GLFlashAdaptor_8cpp.html#a51b865e78bb9b11d7260030e3307852c">glTexParameteri</a>(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);
<a name="l00966"></a>00966                 <span class="keywordflow">break</span>;
<a name="l00967"></a>00967 
<a name="l00968"></a>00968 
<a name="l00969"></a>00969         <span class="keywordflow">case</span> <a class="code" href="classSurface.html#a6d321b09caff273d52719177b0c408cea1644a56dfe9cd389f8cc433f9f716533" title="Nearest pixel filtering, wrap mode is clamp to edge, no mipmaps.">TYPE_NO_SMOOTHING</a>:
<a name="l00970"></a>00970                 <a class="code" href="GLFlashAdaptor_8cpp.html#a62645f8035cbae532cd6181201188e2e">glTexParameterx</a>( GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_NEAREST);
<a name="l00971"></a>00971                 <a class="code" href="GLFlashAdaptor_8cpp.html#a62645f8035cbae532cd6181201188e2e">glTexParameterx</a>( GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_NEAREST );
<a name="l00972"></a>00972                 <a class="code" href="GLFlashAdaptor_8cpp.html#a51b865e78bb9b11d7260030e3307852c">glTexParameteri</a>(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);
<a name="l00973"></a>00973                 <a class="code" href="GLFlashAdaptor_8cpp.html#a51b865e78bb9b11d7260030e3307852c">glTexParameteri</a>(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);
<a name="l00974"></a>00974                 <span class="keywordflow">break</span>;
<a name="l00975"></a>00975             
<a name="l00976"></a>00976         <span class="keywordflow">default</span>: ;
<a name="l00977"></a>00977 
<a name="l00978"></a>00978         }
<a name="l00979"></a>00979 }
<a name="l00980"></a>00980 
<a name="l00981"></a>00981 
<a name="l00982"></a>00982 
<a name="l00983"></a><a class="code" href="classSurface.html#a1c8e6910e9f3ae5152ca4f208c621dc1">00983</a> <span class="keywordtype">bool</span> <a class="code" href="classSurface.html#a1c8e6910e9f3ae5152ca4f208c621dc1">Surface::InitBlankSurface</a>( <span class="keywordtype">int</span> <a class="code" href="flash_2GLES_2glext_8h.html#a0cdec8e97a75ee9458b23d152bf962d4">x</a>, <span class="keywordtype">int</span> <a class="code" href="flash_2GLES_2glext_8h.html#a2532a9f8ed3a10a63f5e3c484fbfdb9b">y</a>)
<a name="l00984"></a>00984 {
<a name="l00985"></a>00985         <a class="code" href="classSurface.html#ab16aab697d858eaf2290856641bcc04f">Kill</a>();
<a name="l00986"></a>00986 
<a name="l00987"></a>00987         assert(x &amp;&amp; y);
<a name="l00988"></a>00988         <a class="code" href="flash_2GLES_2gl_8h.html#a5d5233918a454ad3975c620a69ac5f0b">GLenum</a> colorFormat = GL_RGBA;
<a name="l00989"></a>00989         <a class="code" href="flash_2GLES_2gl_8h.html#a5d5233918a454ad3975c620a69ac5f0b">GLenum</a> pixelFormat = GL_UNSIGNED_BYTE;
<a name="l00990"></a>00990         <span class="keywordtype">int</span> bytesPerPixel = 4;
<a name="l00991"></a>00991         m_textureCreationMethod = <a class="code" href="classSurface.html#ac90b42370f09683473ee7dbeb0b0c8e0a4d3dc62fc57fc38cad9f03068f8c0cfd">TEXTURE_CREATION_BLANK</a>;
<a name="l00992"></a>00992                 
<a name="l00993"></a>00993         <span class="keywordflow">if</span> (m_texWidth == 0)
<a name="l00994"></a>00994         {
<a name="l00995"></a>00995                 <span class="comment">//load manually, these kinds of surfaces are probably needed right away</span>
<a name="l00996"></a>00996                 <a class="code" href="BaseApp_8h.html#a72086b48d24daf0a65dd20189a16bd16">GetBaseApp</a>()-&gt;<a class="code" href="classBaseApp.html#a4363b54dd50f8cc4200e4b195f066086" title="Signal to notify that it&#39;s time to reload surfaces.">m_sig_loadSurfaces</a>.connect(1, boost::bind(&amp;<a class="code" href="classSurface.html#a762fcb787c74b0b94c468edeb4fb98e7">Surface::OnLoadSurfaces</a>, <span class="keyword">this</span>));
<a name="l00997"></a>00997 
<a name="l00998"></a>00998                 <span class="comment">//unload happens right away though</span>
<a name="l00999"></a>00999                 <a class="code" href="BaseApp_8h.html#a72086b48d24daf0a65dd20189a16bd16">GetBaseApp</a>()-&gt;<a class="code" href="classBaseApp.html#a9809967f0001d2d51a2b3fcf2d2ef14a" title="Signal to notify that it&#39;s time to release surfaces.">m_sig_unloadSurfaces</a>.connect(1, boost::bind(&amp;<a class="code" href="classSurface.html#a02c30648814c9398b6c2cca0faed1989">Surface::OnUnloadSurfaces</a>, <span class="keyword">this</span>));
<a name="l01000"></a>01000 
<a name="l01001"></a>01001 <span class="preprocessor">#ifdef WINAPI</span>
<a name="l01002"></a>01002 <span class="preprocessor"></span>                <a class="code" href="BaseApp_8h.html#a72086b48d24daf0a65dd20189a16bd16">GetBaseApp</a>()-&gt;<a class="code" href="classBaseApp.html#aaee0be683732eb188792eb1d97cf6bdd" title="Game restored focus.">m_sig_enterforeground</a>.connect(1, boost::bind(&amp;Surface::OnEnterForeground, <span class="keyword">this</span>, _1));
<a name="l01003"></a>01003 <span class="preprocessor">#endif</span>
<a name="l01004"></a>01004 <span class="preprocessor"></span>        }
<a name="l01005"></a>01005 
<a name="l01006"></a>01006 
<a name="l01007"></a>01007         m_originalWidth = <a class="code" href="flash_2GLES_2glext_8h.html#a0cdec8e97a75ee9458b23d152bf962d4">x</a>;
<a name="l01008"></a>01008         m_originalHeight = <a class="code" href="flash_2GLES_2glext_8h.html#a2532a9f8ed3a10a63f5e3c484fbfdb9b">y</a>;
<a name="l01009"></a>01009 
<a name="l01010"></a>01010         m_texWidth =  <a class="code" href="Surface_8cpp.html#a3f473c59c1ec1056a29214db61ab00a7">nextPowerOfTwo</a>(x);
<a name="l01011"></a>01011         m_texHeight =  <a class="code" href="Surface_8cpp.html#a3f473c59c1ec1056a29214db61ab00a7">nextPowerOfTwo</a>(y);
<a name="l01012"></a>01012         
<a name="l01013"></a>01013         <span class="comment">//make a surface filled with &#39;unknown&#39;</span>
<a name="l01014"></a>01014 
<a name="l01015"></a>01015         PrepareGLForNewTexture();       
<a name="l01016"></a>01016         
<a name="l01017"></a>01017         m_bUsesAlpha = (colorFormat == GL_RGBA);
<a name="l01018"></a>01018         
<a name="l01019"></a>01019         <a class="code" href="PlatformSetupAndroid_8h.html#ab8ef12fab634c171394422d0ee8baf94">byte</a> *pPixelData = NULL;
<a name="l01020"></a>01020         
<a name="l01021"></a>01021         <span class="keywordtype">int</span> <a class="code" href="Renderer_2GL_2glext_8h.html#a9ea2ddb297818884b1942bf375e45da4">dataSize</a> = m_texWidth*m_texHeight*bytesPerPixel;
<a name="l01022"></a>01022 
<a name="l01023"></a>01023         <span class="keywordtype">bool</span> bClearFirst = <span class="keyword">true</span>;
<a name="l01024"></a>01024 
<a name="l01025"></a>01025 <span class="keywordflow">if</span> (bClearFirst)
<a name="l01026"></a>01026 {
<a name="l01027"></a>01027         pPixelData = <span class="keyword">new</span> <a class="code" href="PlatformSetupAndroid_8h.html#ab8ef12fab634c171394422d0ee8baf94">byte</a>[<a class="code" href="Renderer_2GL_2glext_8h.html#a9ea2ddb297818884b1942bf375e45da4">dataSize</a>];
<a name="l01028"></a>01028         assert(pPixelData);
<a name="l01029"></a>01029         <span class="keywordflow">if</span> (!pPixelData)
<a name="l01030"></a>01030         {
<a name="l01031"></a>01031                 <a class="code" href="AndroidUtils_8cpp.html#aaa5c9bf2289dec09f59ef2b7ba6c66ae">LogMsg</a>(<span class="stringliteral">&quot;Low mem?&quot;</span>);
<a name="l01032"></a>01032                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01033"></a>01033         }
<a name="l01034"></a>01034         memset(pPixelData, 0, dataSize);
<a name="l01035"></a>01035 }
<a name="l01036"></a>01036 
<a name="l01037"></a>01037         <span class="keywordtype">int</span> internalColorFormat = colorFormat;
<a name="l01038"></a>01038 
<a name="l01039"></a>01039 <span class="comment">/*</span>
<a name="l01040"></a>01040 <span class="comment">#ifdef C_GL_MODE</span>
<a name="l01041"></a>01041 <span class="comment">        if (internalColorFormat == GL_RGBA) internalColorFormat = GL_RGBA8;</span>
<a name="l01042"></a>01042 <span class="comment">        if (internalColorFormat == GL_RGB) internalColorFormat = GL_RGB8;</span>
<a name="l01043"></a>01043 <span class="comment"></span>
<a name="l01044"></a>01044 <span class="comment">#endif</span>
<a name="l01045"></a>01045 <span class="comment"> */</span>
<a name="l01046"></a>01046         
<a name="l01047"></a>01047         <a class="code" href="GLFlashAdaptor_8cpp.html#a1ae5a412e68bc19aa8fd18e8c206c6de">glTexImage2D</a>( GL_TEXTURE_2D, 0, internalColorFormat, m_texWidth, m_texHeight, 0, colorFormat, pixelFormat, pPixelData );
<a name="l01048"></a>01048 
<a name="l01049"></a>01049         SAFE_DELETE_ARRAY(pPixelData);
<a name="l01050"></a>01050         IncreaseMemCounter(dataSize);
<a name="l01051"></a>01051         SetTextureStates();
<a name="l01052"></a>01052         CHECK_GL_ERROR();
<a name="l01053"></a>01053 
<a name="l01054"></a>01054 
<a name="l01055"></a>01055         CHECK_GL_ERROR();
<a name="l01056"></a>01056         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01057"></a>01057 }
<a name="l01058"></a>01058 
<a name="l01059"></a><a class="code" href="classSurface.html#ad4dccd23c2457063e4251507a140a17e">01059</a> <span class="keywordtype">void</span> <a class="code" href="classSurface.html#ad4dccd23c2457063e4251507a140a17e">Surface::ReloadImage</a>()
<a name="l01060"></a>01060 {
<a name="l01061"></a>01061         <a class="code" href="classSurface.html#a369d5597b8378d6484809c0acad9174f">LoadFile</a>(m_textureLoaded, m_bAddBasePath);
<a name="l01062"></a>01062 }
<a name="l01063"></a>01063 
<a name="l01064"></a><a class="code" href="classSurface.html#a762fcb787c74b0b94c468edeb4fb98e7">01064</a> <span class="keywordtype">void</span> <a class="code" href="classSurface.html#a762fcb787c74b0b94c468edeb4fb98e7">Surface::OnLoadSurfaces</a>()
<a name="l01065"></a>01065 {
<a name="l01066"></a>01066         <span class="keywordflow">if</span> (m_glTextureID != NO_TEXTURE_LOADED) <span class="keywordflow">return</span>; <span class="comment">//already loaded I guess</span>
<a name="l01067"></a>01067 
<a name="l01068"></a>01068 
<a name="l01069"></a>01069                 <span class="keywordflow">switch</span> (m_textureCreationMethod)
<a name="l01070"></a>01070                 {
<a name="l01071"></a>01071                 <span class="keywordflow">case</span> <a class="code" href="classSurface.html#ac90b42370f09683473ee7dbeb0b0c8e0ae4aca7912acd346b1a2453ac29d8239f">TEXTURE_CREATION_FILE</a>:
<a name="l01072"></a>01072 
<a name="l01073"></a>01073 <span class="preprocessor">                        #ifdef _DEBUG           </span>
<a name="l01074"></a>01074 <span class="preprocessor"></span>                        <a class="code" href="AndroidUtils_8cpp.html#aaa5c9bf2289dec09f59ef2b7ba6c66ae">LogMsg</a>(<span class="stringliteral">&quot;Reloading texture %s&quot;</span>, m_textureLoaded.c_str());
<a name="l01075"></a>01075 <span class="preprocessor">                        #endif</span>
<a name="l01076"></a>01076 <span class="preprocessor"></span>                        <a class="code" href="classSurface.html#ad4dccd23c2457063e4251507a140a17e">ReloadImage</a>();
<a name="l01077"></a>01077                         <span class="keywordflow">break</span>;
<a name="l01078"></a>01078 
<a name="l01079"></a>01079                 <span class="keywordflow">case</span> <a class="code" href="classSurface.html#ac90b42370f09683473ee7dbeb0b0c8e0a4d3dc62fc57fc38cad9f03068f8c0cfd">TEXTURE_CREATION_BLANK</a>:
<a name="l01080"></a>01080 <span class="preprocessor">#ifdef _DEBUG           </span>
<a name="l01081"></a>01081 <span class="preprocessor"></span>                        <a class="code" href="AndroidUtils_8cpp.html#aaa5c9bf2289dec09f59ef2b7ba6c66ae">LogMsg</a>(<span class="stringliteral">&quot;Recreating surface of %d, %d&quot;</span>, m_originalWidth, m_originalHeight);
<a name="l01082"></a>01082 <span class="preprocessor">#endif</span>
<a name="l01083"></a>01083 <span class="preprocessor"></span>                        <a class="code" href="classSurface.html#a1c8e6910e9f3ae5152ca4f208c621dc1">InitBlankSurface</a>(m_originalWidth, m_originalHeight);
<a name="l01084"></a>01084                         <span class="keywordflow">break</span>;
<a name="l01085"></a>01085                 
<a name="l01086"></a>01086             <span class="keywordflow">default</span>: ;
<a name="l01087"></a>01087                 }
<a name="l01088"></a>01088 }
<a name="l01089"></a>01089 
<a name="l01090"></a><a class="code" href="classSurface.html#a02c30648814c9398b6c2cca0faed1989">01090</a> <span class="keywordtype">void</span> <a class="code" href="classSurface.html#a02c30648814c9398b6c2cca0faed1989">Surface::OnUnloadSurfaces</a>()
<a name="l01091"></a>01091 {
<a name="l01092"></a>01092 
<a name="l01093"></a>01093         <span class="keywordflow">if</span> (m_glTextureID != NO_TEXTURE_LOADED)
<a name="l01094"></a>01094         {
<a name="l01095"></a>01095 <span class="preprocessor">        #ifdef _DEBUG</span>
<a name="l01096"></a>01096 <span class="preprocessor"></span>                <a class="code" href="AndroidUtils_8cpp.html#aaa5c9bf2289dec09f59ef2b7ba6c66ae">LogMsg</a>(<span class="stringliteral">&quot;Unloading %d (%s)&quot;</span>, m_glTextureID, m_textureLoaded.c_str());
<a name="l01097"></a>01097 <span class="preprocessor">        #endif</span>
<a name="l01098"></a>01098 <span class="preprocessor"></span>                <a class="code" href="classSurface.html#ab16aab697d858eaf2290856641bcc04f">Kill</a>();
<a name="l01099"></a>01099         }
<a name="l01100"></a>01100 }
<a name="l01101"></a>01101 
<a name="l01102"></a><a class="code" href="classSurface.html#a71b5094cdffab8829fec8cf712e60259">01102</a> <span class="keywordtype">bool</span> <a class="code" href="classSurface.html#a71b5094cdffab8829fec8cf712e60259">Surface::InitFromSoftSurface</a>( <a class="code" href="classSoftSurface.html">SoftSurface</a> *pSurf, <span class="keywordtype">bool</span> bCreateSurface, <span class="keywordtype">int</span> mipLevel )
<a name="l01103"></a>01103 {
<a name="l01104"></a>01104         <span class="keywordtype">int</span> <a class="code" href="Renderer_2GL_2glext_8h.html#a9ea2ddb297818884b1942bf375e45da4">dataSize</a> = 0;
<a name="l01105"></a>01105         assert(pSurf-&gt;<a class="code" href="classSoftSurface.html#a0bb55f39aa45f47802fb2521552dd49e">GetWidth</a>() &amp;&amp; pSurf-&gt;<a class="code" href="classSoftSurface.html#a4b56febc7ace86df39823334be18fbe8">GetHeight</a>());
<a name="l01106"></a>01106         <a class="code" href="flash_2GLES_2gl_8h.html#a5d5233918a454ad3975c620a69ac5f0b">GLenum</a> colorFormat = GL_RGBA;
<a name="l01107"></a>01107         <a class="code" href="flash_2GLES_2gl_8h.html#a5d5233918a454ad3975c620a69ac5f0b">GLenum</a> pixelFormat = GL_UNSIGNED_BYTE;
<a name="l01108"></a>01108         <span class="keywordtype">int</span> bytesPerPixel = 4;
<a name="l01109"></a>01109 
<a name="l01110"></a>01110         <span class="keywordflow">if</span> (pSurf-&gt;<a class="code" href="classSoftSurface.html#a86a7d25e25495ea0b7a8f6e1c1ca0dde">GetSurfaceType</a>() == <a class="code" href="classSoftSurface.html#a5fa1962080f1212ac4b5e4bb95202c13aca8701db52dacb6d9fc426ad0a4a1851">SoftSurface::SURFACE_RGB</a>) 
<a name="l01111"></a>01111         {
<a name="l01112"></a>01112                 colorFormat = GL_RGB;
<a name="l01113"></a>01113                 bytesPerPixel = 3;
<a name="l01114"></a>01114         }
<a name="l01115"></a>01115 
<a name="l01116"></a>01116         <span class="keywordflow">if</span> (mipLevel == 0)
<a name="l01117"></a>01117         {
<a name="l01118"></a>01118 
<a name="l01119"></a>01119                 m_texWidth =  <a class="code" href="Surface_8cpp.html#a3f473c59c1ec1056a29214db61ab00a7">nextPowerOfTwo</a>(pSurf-&gt;<a class="code" href="classSoftSurface.html#a0bb55f39aa45f47802fb2521552dd49e">GetWidth</a>());
<a name="l01120"></a>01120                 m_texHeight =  <a class="code" href="Surface_8cpp.html#a3f473c59c1ec1056a29214db61ab00a7">nextPowerOfTwo</a>(pSurf-&gt;<a class="code" href="classSoftSurface.html#a4b56febc7ace86df39823334be18fbe8">GetHeight</a>());
<a name="l01121"></a>01121 
<a name="l01122"></a>01122                 <span class="keywordflow">if</span> (m_originalHeight == 0) m_originalHeight = pSurf-&gt;<a class="code" href="classSoftSurface.html#a016df87c0b78a60248b3f02642dffa6a">GetOriginalHeight</a>();
<a name="l01123"></a>01123                 <span class="keywordflow">if</span> (m_originalWidth == 0) m_originalWidth = pSurf-&gt;<a class="code" href="classSoftSurface.html#ae27d98f37dcb40d6ccbf957264b9182c">GetOriginalWidth</a>();
<a name="l01124"></a>01124                 dataSize = m_texWidth*m_texHeight*bytesPerPixel;
<a name="l01125"></a>01125 
<a name="l01126"></a>01126         } <span class="keywordflow">else</span>
<a name="l01127"></a>01127         {
<a name="l01128"></a>01128                 <span class="comment">//it&#39;s a mipmap.  We assume these are power of 2 already</span>
<a name="l01129"></a>01129                 
<a name="l01130"></a>01130                 dataSize = pSurf-&gt;<a class="code" href="classSoftSurface.html#a0bb55f39aa45f47802fb2521552dd49e">GetWidth</a>()*pSurf-&gt;<a class="code" href="classSoftSurface.html#a4b56febc7ace86df39823334be18fbe8">GetHeight</a>()*bytesPerPixel;
<a name="l01131"></a>01131         }
<a name="l01132"></a>01132 
<a name="l01133"></a>01133         <span class="keywordflow">if</span> (bCreateSurface)
<a name="l01134"></a>01134         {
<a name="l01135"></a>01135                 <a class="code" href="classSurface.html#ab16aab697d858eaf2290856641bcc04f">Kill</a>();
<a name="l01136"></a>01136                 PrepareGLForNewTexture();
<a name="l01137"></a>01137                 <span class="keywordflow">if</span> (m_textureLoaded.empty())
<a name="l01138"></a>01138                 {
<a name="l01139"></a>01139                         m_textureCreationMethod = <a class="code" href="classSurface.html#ac90b42370f09683473ee7dbeb0b0c8e0a4d3dc62fc57fc38cad9f03068f8c0cfd">TEXTURE_CREATION_BLANK</a>;
<a name="l01140"></a>01140                 }
<a name="l01141"></a>01141         }
<a name="l01142"></a>01142 
<a name="l01143"></a>01143         m_bUsesAlpha = (colorFormat == GL_RGBA);
<a name="l01144"></a>01144         
<a name="l01145"></a>01145         <span class="keywordtype">int</span> internalColorFormat = colorFormat;
<a name="l01146"></a>01146                 
<a name="l01147"></a>01147         <span class="keywordflow">if</span> ( (m_texHeight == pSurf-&gt;<a class="code" href="classSoftSurface.html#a4b56febc7ace86df39823334be18fbe8">GetHeight</a>() &amp;&amp; m_texWidth == pSurf-&gt;<a class="code" href="classSoftSurface.html#a0bb55f39aa45f47802fb2521552dd49e">GetWidth</a>()) || mipLevel &gt; 0)
<a name="l01148"></a>01148         {
<a name="l01149"></a>01149                 <span class="comment">//great, no size trickery needed</span>
<a name="l01150"></a>01150                 <span class="comment">//pSurf-&gt;FillColor(glColorBytes(255,0,0,255));</span>
<a name="l01151"></a>01151 <span class="preprocessor">#ifdef _DEBUG</span>
<a name="l01152"></a>01152 <span class="preprocessor"></span>                <span class="comment">//write out every texture loaded this way, used it for debugging a problem with mimaps</span>
<a name="l01153"></a>01153 <span class="comment">/*</span>
<a name="l01154"></a>01154 <span class="comment">                static int debugCount = 0;</span>
<a name="l01155"></a>01155 <span class="comment">                debugCount++;</span>
<a name="l01156"></a>01156 <span class="comment">                pSurf-&gt;WriteBMPOut(GetBaseAppPath()+&quot;test_&quot;+toString(debugCount)+&quot;_&quot;+toString(mipLevel)+&quot;.bmp&quot;);</span>
<a name="l01157"></a>01157 <span class="comment">                */</span>
<a name="l01158"></a>01158 
<a name="l01159"></a>01159 <span class="preprocessor">#endif</span>
<a name="l01160"></a>01160 <span class="preprocessor"></span>
<a name="l01161"></a>01161                 assert(colorFormat == GL_RGB);
<a name="l01162"></a>01162                 <a class="code" href="GLFlashAdaptor_8cpp.html#a1ae5a412e68bc19aa8fd18e8c206c6de">glTexImage2D</a>( GL_TEXTURE_2D, mipLevel, internalColorFormat, pSurf-&gt;<a class="code" href="classSoftSurface.html#a0bb55f39aa45f47802fb2521552dd49e">GetWidth</a>(), pSurf-&gt;<a class="code" href="classSoftSurface.html#a4b56febc7ace86df39823334be18fbe8">GetHeight</a>(), 0, colorFormat, pixelFormat, pSurf-&gt;<a class="code" href="classSoftSurface.html#afa8c214a91bbd8ea52bab4b80eb8d9cb">GetPixelData</a>() );
<a name="l01163"></a>01163         
<a name="l01164"></a>01164         } <span class="keywordflow">else</span>
<a name="l01165"></a>01165         {
<a name="l01166"></a>01166                 <a class="code" href="classSoftSurface.html">SoftSurface</a> <a class="code" href="flash_2GLES_2glext_8h.html#ad585a1393cfa368fa9dc3d8ebff640d5">s</a>;
<a name="l01167"></a>01167                 <a class="code" href="classSoftSurface.html#a5fa1962080f1212ac4b5e4bb95202c13">SoftSurface::eSurfaceType</a> tempSurfType = <a class="code" href="classSoftSurface.html#a5fa1962080f1212ac4b5e4bb95202c13aca8701db52dacb6d9fc426ad0a4a1851">SoftSurface::SURFACE_RGB</a>;
<a name="l01168"></a>01168 
<a name="l01169"></a>01169                 <span class="keywordflow">if</span> (colorFormat == GL_RGBA)
<a name="l01170"></a>01170                 {
<a name="l01171"></a>01171                         tempSurfType = <a class="code" href="classSoftSurface.html#a5fa1962080f1212ac4b5e4bb95202c13a1152c522423530934239723139dd7dcb">SoftSurface::SURFACE_RGBA</a>;
<a name="l01172"></a>01172                 }
<a name="l01173"></a>01173 
<a name="l01174"></a>01174                 s.<a class="code" href="classSoftSurface.html#a70c68006632cb0897b989a3bc4ec99be">Init</a>(m_texWidth, m_texHeight, tempSurfType);
<a name="l01175"></a>01175                 <a class="code" href="PlatformSetupAndroid_8h.html#ab8ef12fab634c171394422d0ee8baf94">byte</a> *pPixelData = s.<a class="code" href="classSoftSurface.html#afa8c214a91bbd8ea52bab4b80eb8d9cb">GetPixelData</a>();
<a name="l01176"></a>01176 
<a name="l01177"></a>01177                 assert(pPixelData);
<a name="l01178"></a>01178                 <span class="keywordflow">if</span> (!pPixelData)
<a name="l01179"></a>01179                 {
<a name="l01180"></a>01180                         <a class="code" href="AndroidUtils_8cpp.html#aaa5c9bf2289dec09f59ef2b7ba6c66ae">LogMsg</a>(<span class="stringliteral">&quot;Low mem?&quot;</span>);
<a name="l01181"></a>01181                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01182"></a>01182                 }
<a name="l01183"></a>01183 
<a name="l01184"></a>01184                 memset(pPixelData,0, dataSize);
<a name="l01185"></a>01185         
<a name="l01186"></a>01186 <span class="preprocessor">                #ifdef RT_GLES_ADAPTOR_MODE</span>
<a name="l01187"></a>01187 <span class="preprocessor"></span>                        <span class="comment">//do it the simpler way, for Flash</span>
<a name="l01188"></a>01188                         <span class="keywordtype">int</span> yStart = 0;
<a name="l01189"></a>01189                         <span class="keywordtype">bool</span> bUpsideDownMode = <span class="keyword">true</span>;
<a name="l01190"></a>01190                         <span class="keywordflow">if</span> (bUpsideDownMode)
<a name="l01191"></a>01191                         {
<a name="l01192"></a>01192                                 yStart += (m_texHeight-m_originalHeight);
<a name="l01193"></a>01193                         } 
<a name="l01194"></a>01194                         s.<a class="code" href="classSoftSurface.html#a6b02d441929ee9b1e786c1b8a7d84fa4">Blit</a>(0,yStart, pSurf);
<a name="l01195"></a>01195                         <a class="code" href="GLFlashAdaptor_8cpp.html#a1ae5a412e68bc19aa8fd18e8c206c6de">glTexImage2D</a>( GL_TEXTURE_2D, mipLevel, internalColorFormat, m_texWidth, m_texHeight, 0, colorFormat, pixelFormat, pPixelData );
<a name="l01196"></a>01196 
<a name="l01197"></a>01197 <span class="preprocessor">                #else</span>
<a name="l01198"></a>01198 <span class="preprocessor"></span>                        <span class="comment">//normal way</span>
<a name="l01199"></a>01199                         <a class="code" href="GLFlashAdaptor_8cpp.html#a1ae5a412e68bc19aa8fd18e8c206c6de">glTexImage2D</a>( GL_TEXTURE_2D, mipLevel, internalColorFormat, m_texWidth, m_texHeight, 0, colorFormat, pixelFormat, pPixelData );
<a name="l01200"></a>01200 
<a name="l01201"></a>01201                         <span class="keywordtype">int</span> yStart = 0;
<a name="l01202"></a>01202                         <span class="keywordtype">bool</span> bUpsideDownMode = <span class="keyword">true</span>;
<a name="l01203"></a>01203                         <span class="keywordflow">if</span> (bUpsideDownMode)
<a name="l01204"></a>01204                         {
<a name="l01205"></a>01205                                 yStart += (m_texHeight-m_originalHeight);
<a name="l01206"></a>01206                         } 
<a name="l01207"></a>01207 
<a name="l01208"></a>01208                         assert(pSurf-&gt;<a class="code" href="classSoftSurface.html#a0bb55f39aa45f47802fb2521552dd49e">GetWidth</a>()%4 == 0 &amp;&amp; <span class="stringliteral">&quot;This will probably crash glTexSubImage2D.  Pad your textures to multiples of 4, or use the .rttex format.&quot;</span>);
<a name="l01209"></a>01209                         <span class="comment">//note: We could get around the error above with glPixelStorei(GL_PACK_ALIGNMENT, 1), but I don&#39;t think</span>
<a name="l01210"></a>01210                         <span class="comment">//it&#39;s available on all platforms so not going to bother</span>
<a name="l01211"></a>01211                         
<a name="l01212"></a>01212                         <a class="code" href="GLFlashAdaptor_8cpp.html#a8a333af9c76c518419c54ed92587c987">glTexSubImage2D</a>(GL_TEXTURE_2D, mipLevel, 0, yStart, pSurf-&gt;<a class="code" href="classSoftSurface.html#a0bb55f39aa45f47802fb2521552dd49e">GetWidth</a>(), pSurf-&gt;<a class="code" href="classSoftSurface.html#a4b56febc7ace86df39823334be18fbe8">GetHeight</a>(), internalColorFormat, pixelFormat, pSurf-&gt;<a class="code" href="classSoftSurface.html#afa8c214a91bbd8ea52bab4b80eb8d9cb">GetPixelData</a>());
<a name="l01213"></a>01213 <span class="preprocessor">                #endif</span>
<a name="l01214"></a>01214 <span class="preprocessor"></span>        }
<a name="l01215"></a>01215 
<a name="l01216"></a>01216         <span class="keywordflow">if</span> (bCreateSurface &amp;&amp; mipLevel == 0)
<a name="l01217"></a>01217         {
<a name="l01218"></a>01218                 IncreaseMemCounter(dataSize);
<a name="l01219"></a>01219                 SetTextureStates();
<a name="l01220"></a>01220         }
<a name="l01221"></a>01221 
<a name="l01222"></a>01222         CHECK_GL_ERROR();
<a name="l01223"></a>01223         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01224"></a>01224 }
<a name="l01225"></a>01225 
<a name="l01226"></a>01226 
<a name="l01227"></a><a class="code" href="classSurface.html#a07da381079212a50ef95262663da711b">01227</a> <span class="keywordtype">void</span> <a class="code" href="classSurface.html#a07da381079212a50ef95262663da711b">Surface::BlitRotated</a>( <span class="keywordtype">float</span> <a class="code" href="flash_2GLES_2glext_8h.html#a0cdec8e97a75ee9458b23d152bf962d4">x</a>, <span class="keywordtype">float</span> <a class="code" href="flash_2GLES_2glext_8h.html#a2532a9f8ed3a10a63f5e3c484fbfdb9b">y</a>, CL_Vec2f vScale, <a class="code" href="rtRect_8h.html#a74e9e3c1ad777682769717e601d606a7">eAlignment</a> alignment <span class="comment">/*= ALIGNMENT_CENTER*/</span>,
<a name="l01228"></a>01228                                                   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> rgba <span class="comment">/*= MAKE_RGBA(255,255,255,255)*/</span>, <span class="keywordtype">float</span> rotation<span class="comment">/*=0*/</span>,
<a name="l01229"></a>01229                                                   CL_Vec2f vRotationPtLocalCoords <span class="comment">/*= CL_Vec2f(0,0)*/</span>, <a class="code" href="classRenderBatcher.html">RenderBatcher</a> *pRenderBatcher)
<a name="l01230"></a>01230 {
<a name="l01231"></a>01231         <a class="code" href="classSurface.html#a08c850a2afce817b7ed46b77e45be473">BlitScaledWithRotatePoint</a>(x,y,vScale, alignment, rgba, rotation, CL_Vec2f(x,y)+vRotationPtLocalCoords, pRenderBatcher);
<a name="l01232"></a>01232 }
<a name="l01233"></a>01233 
<a name="l01234"></a>01234 <span class="keywordtype">void</span> Surface::OnEnterForeground(<a class="code" href="classVariantList.html">VariantList</a> *pVList)
<a name="l01235"></a>01235 {
<a name="l01236"></a>01236         <span class="comment">//only called on windows, to restore lost properties after doing a Alt-Enter full screen toggle or changing</span>
<a name="l01237"></a>01237         <span class="comment">//the res.  Surfaces aren&#39;t actually reloaded but they lose some GL settings.. maybe a OnChangeResize signal</span>
<a name="l01238"></a>01238         <span class="comment">//would be better for this.</span>
<a name="l01239"></a>01239 
<a name="l01240"></a>01240         <a class="code" href="classSurface.html#a8617ddf72cb01037f2c746e837c181e9">SetSmoothing</a>(m_bSmoothing);
<a name="l01241"></a>01241 }
<a name="l01242"></a>01242 
<a name="l01243"></a><a class="code" href="Surface_8h.html#a4c87db61abc9c0b9363adbd5f76bb611">01243</a> <span class="keywordtype">string</span> <a class="code" href="Surface_8cpp.html#adc8128cece123405b120ff179c726a7d">PrintGLColor</a>(<a class="code" href="structglColorBytes.html">glColorBytes</a> <a class="code" href="Renderer_2GL_2glext_8h.html#a3ea846f998d64f079b86052b6c4193a8">color</a>)
<a name="l01244"></a>01244 {
<a name="l01245"></a>01245         <span class="keywordtype">char</span> st[128];
<a name="l01246"></a>01246         sprintf(st, <span class="stringliteral">&quot;%d, %d, %d, %d&quot;</span>, color.<a class="code" href="structglColorBytes.html#a45f84664a9c2094926e1a7f74b519cca">r</a>, color.<a class="code" href="structglColorBytes.html#affcd4d6789a25720de600669f307635d">g</a>, color.<a class="code" href="structglColorBytes.html#a221c697efb3e0a485dd83ae3b633d79f">b</a>, color.<a class="code" href="structglColorBytes.html#a6fbee54bc4cc7f8ecd93dab1cd43ee2f">a</a>);
<a name="l01247"></a>01247         <span class="keywordflow">return</span> <a class="code" href="Renderer_2GL_2glext_8h.html#a06b88fc81ad0b30d1512e9609e3d7c82">string</a>(st);
<a name="l01248"></a>01248 }
</pre></div></div><!-- contents -->


<hr class="footer"/><address class="footer"><small>
Generated on Thu May 2 2013 17:17:13 for Proton by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
