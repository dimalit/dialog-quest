<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Proton: IAPManager.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />



</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Proton
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_b4959094aa2649f063000bebf8111065.html">shared</a>      </li>
      <li class="navelem"><a class="el" href="dir_e37d4cc59eda3a46db89ba853c5be16b.html">Manager</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">IAPManager.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="IAPManager_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include &quot;<a class="code" href="PlatformPrecomp_8h.html">PlatformPrecomp.h</a>&quot;</span>
<a name="l00002"></a>00002 <span class="preprocessor">#include &quot;<a class="code" href="IAPManager_8h.html">IAPManager.h</a>&quot;</span>
<a name="l00003"></a>00003 
<a name="l00004"></a>00004 <span class="preprocessor">#ifdef _DEBUG</span>
<a name="l00005"></a>00005 <span class="preprocessor"></span>        <span class="comment">//#define SHOW_DEBUG_IAP_MESSAGES</span>
<a name="l00006"></a>00006 <span class="preprocessor">#endif</span>
<a name="l00007"></a>00007 <span class="preprocessor"></span>
<a name="l00008"></a>00008 <span class="preprocessor">#if defined PLATFORM_WINDOWS || defined PLATFORM_LINUX</span>
<a name="l00009"></a>00009 <span class="preprocessor"></span>        <span class="comment">//you can also define FAKE_SUCCESSFULLY_IAP_REPLY in your project for iOS/android/webos builds, for testing IAP that hasn&#39;t been setup yet</span>
<a name="l00010"></a>00010 <span class="preprocessor">        #define FAKE_IAP_REPLY</span>
<a name="l00011"></a>00011 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00012"></a>00012 <span class="preprocessor"></span>
<a name="l00013"></a>00013 <span class="comment">//set a default for when faking IAP responses</span>
<a name="l00014"></a>00014 <span class="preprocessor">#if defined(FAKE_IAP_REPLY) &amp;&amp; !defined(FAKE_IAP_RESPONSE_SUCCESS) &amp;&amp; !defined(FAKE_IAP_RESPONSE_FAILED) &amp;&amp; !defined(FAKE_IAP_RESPONSE_ALREADY_PURCHASED) &amp;&amp; !defined(FAKE_IAP_RESPONSE_TIME_OUT) </span>
<a name="l00015"></a>00015 <span class="preprocessor"></span><span class="preprocessor">        #define FAKE_IAP_RESPONSE_SUCCESS</span>
<a name="l00016"></a>00016 <span class="preprocessor"></span>        <span class="comment">//#define FAKE_IAP_RESPONSE_FAILED</span>
<a name="l00017"></a>00017         <span class="comment">//#define FAKE_IAP_RESPONSE_ALREADY_PURCHASED</span>
<a name="l00018"></a>00018         <span class="comment">//#define FAKE_IAP_RESPONSE_TIME_OUT</span>
<a name="l00019"></a>00019 <span class="preprocessor">#endif</span>
<a name="l00020"></a>00020 <span class="preprocessor"></span>
<a name="l00021"></a><a class="code" href="classIAPManager.html#a2e8ffa221d6d8a64938f72f298f4cb28">00021</a> <a class="code" href="classIAPManager.html#a2e8ffa221d6d8a64938f72f298f4cb28">IAPManager::IAPManager</a>()
<a name="l00022"></a>00022 {
<a name="l00023"></a>00023         <a class="code" href="classIAPManager.html#af9a4419ea019aab255df7213c76fe79e">m_state</a> = <a class="code" href="classIAPManager.html#a759bce61b8886fee5ec1a54c9c061ca8ad3b42ddab3726e40e4b06af7e1895d9e">STATE_NONE</a>;
<a name="l00024"></a>00024         <a class="code" href="classIAPManager.html#a3c15d8b9220038313d0f5190e1a5f7e9">m_returnState</a> = <a class="code" href="classIAPManager.html#a223842c3fd3d0872d15c8a8bb0b08655a467fa3913ffa1091b3007a8fb36d5a2b" title="No result available.">RETURN_STATE_NONE</a>;
<a name="l00025"></a>00025         <a class="code" href="classIAPManager.html#a1fc386e6234553cbd7306335f4bcb828">m_failureReason</a> = <a class="code" href="classIAPManager.html#a7f7617365e6feed3272cb227542658ababde6ecbb2875de7b2d657d7369fe9659" title="Either there was no failure or the reason is not known.">FAILURE_REASON_NONE</a>;
<a name="l00026"></a>00026         <a class="code" href="classIAPManager.html#a426e020b745012ce92104ddace9219c2">m_timer</a> = 0;
<a name="l00027"></a>00027         <a class="code" href="classIAPManager.html#afdc93a425e0981c05e09fe5a7cdfe1a2">m_bWaitingForReply</a> = <span class="keyword">false</span>;
<a name="l00028"></a>00028         <a class="code" href="classIAPManager.html#a941cb703abffcef39ab3c96c474436ca">m_bGettingItemList</a> = <span class="keyword">false</span>;
<a name="l00029"></a>00029 
<a name="l00030"></a>00030         <span class="comment">//This gives us a way to schedule calls to m_sig_item_unexpected_purchase_result, used with TestDelayedIAP</span>
<a name="l00031"></a>00031         <a class="code" href="classIAPManager.html#a7d5785f5e0b31400d7fcd7f6e70c11ea">m_entity</a>.<a class="code" href="classEntity.html#a3caca7df803637d92b141daca30f4c3b">GetFunction</a>(<span class="stringliteral">&quot;OnUnexpectedPurchase&quot;</span>)-&gt;<a class="code" href="classFunctionObject.html#abfd6ae66d3b358d20aaab70d861e57e7">sig_function</a>.connect(<a class="code" href="classIAPManager.html#ad37a8ab10f39bf5e45be7b1497406395" title="A signal for reporting an unexpected purchase or refund (happens on android only so far...">m_sig_item_unexpected_purchase_result</a>);
<a name="l00032"></a>00032 }
<a name="l00033"></a>00033 
<a name="l00034"></a><a class="code" href="classIAPManager.html#a436e986f6e589dc51519eb9a4376a183">00034</a> <a class="code" href="classIAPManager.html#a436e986f6e589dc51519eb9a4376a183">IAPManager::~IAPManager</a>()
<a name="l00035"></a>00035 {
<a name="l00036"></a>00036 }
<a name="l00037"></a>00037 
<a name="l00038"></a><a class="code" href="classIAPManager.html#a48a8af13ca0f8166ce950d809fb0d181">00038</a> <span class="keywordtype">bool</span> <a class="code" href="classIAPManager.html#a48a8af13ca0f8166ce950d809fb0d181">IAPManager::IsItemPurchased</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp;item)<span class="keyword"> const</span>
<a name="l00039"></a>00039 <span class="keyword"></span>{
<a name="l00040"></a>00040         <span class="keywordflow">return</span> <a class="code" href="classIAPManager.html#a3f219041483f1bb2524a3ddedcfdf545">m_items</a>.find(item) != <a class="code" href="classIAPManager.html#a3f219041483f1bb2524a3ddedcfdf545">m_items</a>.end();
<a name="l00041"></a>00041 }
<a name="l00042"></a>00042 
<a name="l00043"></a><a class="code" href="classIAPManager.html#a1121d0e33426e0844493f65528df57ef">00043</a> <span class="keywordtype">void</span> <a class="code" href="classIAPManager.html#a1121d0e33426e0844493f65528df57ef">IAPManager::HandlePurchaseListReply</a>(<a class="code" href="classMessage.html">Message</a> &amp;<a class="code" href="Renderer_2GL_2glext_8h.html#af593500c283bf1a787a6f947f503a5c2">m</a>)
<a name="l00044"></a>00044 {
<a name="l00045"></a>00045         <span class="comment">//we must have asked for a list of purchased the user has made on android</span>
<a name="l00046"></a>00046         <span class="keywordflow">switch</span> (<a class="code" href="classIAPManager.html#abe3136a2a3e068e9112aadc70970beeb">ItemStateCode</a>((<span class="keywordtype">int</span>)m.<a class="code" href="classMessage.html#a06e5f10fce89602a8c1ac82c92af2809">GetParm1</a>()))
<a name="l00047"></a>00047         {
<a name="l00048"></a>00048         <span class="keywordflow">case</span> <a class="code" href="classIAPManager.html#abe3136a2a3e068e9112aadc70970beebaa945f2a908bb27a45a70718dc64ec49d">END_OF_LIST</a>:
<a name="l00049"></a>00049                 {
<a name="l00050"></a>00050 <span class="preprocessor">#ifdef SHOW_DEBUG_IAP_MESSAGES</span>
<a name="l00051"></a>00051 <span class="preprocessor"></span>                        <a class="code" href="AndroidUtils_8cpp.html#aaa5c9bf2289dec09f59ef2b7ba6c66ae">LogMsg</a>(<span class="stringliteral">&quot;(finished receiving purchase history of managed items)&quot;</span>);
<a name="l00052"></a>00052 <span class="preprocessor">#endif</span>
<a name="l00053"></a>00053 <span class="preprocessor"></span>                
<a name="l00054"></a>00054                         <a class="code" href="classVariantList.html">VariantList</a> vList;
<a name="l00055"></a>00055                         <a class="code" href="classIAPManager.html#a30464b4b0228151d9975b2ac6c9dfe25" title="A signal for reporting that the previous purchases are now known and IsItemPurchased() returns correc...">m_sig_purchased_list_updated</a>(&amp;vList);
<a name="l00056"></a>00056                         
<a name="l00057"></a>00057                         <span class="comment">//we want to buy an item as soon as this is done</span>
<a name="l00058"></a>00058                         <span class="keywordflow">if</span> (!<a class="code" href="classIAPManager.html#a2575c9d567e4fd1198588665a05e2209">m_itemToBuy</a>.empty())
<a name="l00059"></a>00059                         {
<a name="l00060"></a>00060                                 <span class="comment">//now buy the item</span>
<a name="l00061"></a>00061                                 
<a name="l00062"></a>00062                                 <span class="comment">//but wait, do we already own it?</span>
<a name="l00063"></a>00063                                 <span class="keywordflow">if</span> (<a class="code" href="classIAPManager.html#a48a8af13ca0f8166ce950d809fb0d181">IsItemPurchased</a>(<a class="code" href="classIAPManager.html#a2575c9d567e4fd1198588665a05e2209">m_itemToBuy</a>))
<a name="l00064"></a>00064                                 {
<a name="l00065"></a>00065                                         <span class="comment">//just fake a yes to the purchase request now</span>
<a name="l00066"></a>00066                                         <a class="code" href="classIAPManager.html#aa6aaca7ee5d2b4320b189a0379c714f3" title="Changes the state of the purchasing process and sends the m_sig_item_purchase_result signal...">endPurchaseProcessWithResult</a>(<a class="code" href="classIAPManager.html#a223842c3fd3d0872d15c8a8bb0b08655aecb53e78a2db6a02729c0fdb7bb96ccb" title="The item has been purchased already previously.">RETURN_STATE_ALREADY_PURCHASED</a>);
<a name="l00067"></a>00067                                         <a class="code" href="classIAPManager.html#a2575c9d567e4fd1198588665a05e2209">m_itemToBuy</a>.clear();
<a name="l00068"></a>00068                                         <span class="keywordflow">break</span>;
<a name="l00069"></a>00069                                 }
<a name="l00070"></a>00070                                 
<a name="l00071"></a>00071 <span class="preprocessor">#ifdef SHOW_DEBUG_IAP_MESSAGES</span>
<a name="l00072"></a>00072 <span class="preprocessor"></span>                                <a class="code" href="AndroidUtils_8cpp.html#aaa5c9bf2289dec09f59ef2b7ba6c66ae">LogMsg</a>(<span class="stringliteral">&quot;Well, we don&#39;t already own it.  Sending buy request for %s&quot;</span>, <a class="code" href="classIAPManager.html#a2575c9d567e4fd1198588665a05e2209">m_itemToBuy</a>.c_str());
<a name="l00073"></a>00073 <span class="preprocessor">#endif</span>
<a name="l00074"></a>00074 <span class="preprocessor"></span>                                <a class="code" href="classIAPManager.html#a55a48ddbc182cc2ff2c1070ed658e07c">sendPurchaseMessage</a>();
<a name="l00075"></a>00075                         } 
<a name="l00076"></a>00076                         <span class="keywordflow">break</span>;
<a name="l00077"></a>00077                 }
<a name="l00078"></a>00078 
<a name="l00079"></a>00079         <span class="keywordflow">case</span> <a class="code" href="classIAPManager.html#abe3136a2a3e068e9112aadc70970beebafc4c2543a3d8a568de42793c230c45c4">PURCHASED</a>:
<a name="l00080"></a>00080                 {
<a name="l00081"></a>00081 <span class="preprocessor">#ifdef SHOW_DEBUG_IAP_MESSAGES</span>
<a name="l00082"></a>00082 <span class="preprocessor"></span>                        <a class="code" href="AndroidUtils_8cpp.html#aaa5c9bf2289dec09f59ef2b7ba6c66ae">LogMsg</a>(<span class="stringliteral">&quot;Has purchased %s&quot;</span>, m.<a class="code" href="classMessage.html#a44abed0364b1eb3a7f222b320cec9ab3">GetStringParm</a>().c_str());
<a name="l00083"></a>00083 <span class="preprocessor">#endif</span>
<a name="l00084"></a>00084 <span class="preprocessor"></span>
<a name="l00085"></a>00085                         <span class="keywordtype">bool</span> added = <a class="code" href="classIAPManager.html#a3f219041483f1bb2524a3ddedcfdf545">m_items</a>.insert(m.<a class="code" href="classMessage.html#a44abed0364b1eb3a7f222b320cec9ab3">GetStringParm</a>()).second;
<a name="l00086"></a>00086 <span class="preprocessor">#ifdef SHOW_DEBUG_IAP_MESSAGES</span>
<a name="l00087"></a>00087 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (added)
<a name="l00088"></a>00088                         {
<a name="l00089"></a>00089                                 <a class="code" href="AndroidUtils_8cpp.html#aaa5c9bf2289dec09f59ef2b7ba6c66ae">LogMsg</a>(<span class="stringliteral">&quot;Added %s, now has %d purchased items&quot;</span>, m.<a class="code" href="classMessage.html#a44abed0364b1eb3a7f222b320cec9ab3">GetStringParm</a>().c_str(), <a class="code" href="classIAPManager.html#a3f219041483f1bb2524a3ddedcfdf545">m_items</a>.size());
<a name="l00090"></a>00090                         }
<a name="l00091"></a>00091 <span class="preprocessor">#endif</span>
<a name="l00092"></a>00092 <span class="preprocessor"></span>                }
<a name="l00093"></a>00093 
<a name="l00094"></a>00094                 <span class="keywordflow">break</span>;
<a name="l00095"></a>00095 
<a name="l00096"></a>00096         <span class="keywordflow">case</span> <a class="code" href="classIAPManager.html#abe3136a2a3e068e9112aadc70970beeba0332d514241c4a4a355181cba187651a">CANCELED</a>:
<a name="l00097"></a>00097         <span class="keywordflow">case</span> <a class="code" href="classIAPManager.html#abe3136a2a3e068e9112aadc70970beebac6567fb7ae9a7ba2a02a82663d37d267">REFUNDED</a>:
<a name="l00098"></a>00098                 <a class="code" href="AndroidUtils_8cpp.html#aaa5c9bf2289dec09f59ef2b7ba6c66ae">LogMsg</a>(<span class="stringliteral">&quot;Got canceled or refunded (%d) when asking about previous purchases.  That&#39;s weird.&quot;</span>, (<span class="keywordtype">int</span>)m.<a class="code" href="classMessage.html#a06e5f10fce89602a8c1ac82c92af2809">GetParm1</a>());
<a name="l00099"></a>00099                 <span class="keywordflow">break</span>;
<a name="l00100"></a>00100         }
<a name="l00101"></a>00101 }
<a name="l00102"></a>00102 
<a name="l00103"></a>00103 
<a name="l00104"></a><a class="code" href="classIAPManager.html#ad0abe33426cec37a8a33d212b68477e3">00104</a> <span class="keywordtype">void</span> <a class="code" href="classIAPManager.html#ad0abe33426cec37a8a33d212b68477e3">IAPManager::SendUnexpectedPurchaseSignal</a>(<a class="code" href="classIAPManager.html#a223842c3fd3d0872d15c8a8bb0b08655" title="The result of a purchase process.">eReturnState</a> returnState, <span class="keywordtype">string</span> itemID, <span class="keywordtype">string</span> extra)
<a name="l00105"></a>00105 {
<a name="l00106"></a>00106 <span class="preprocessor">        #ifdef SHOW_DEBUG_IAP_MESSAGES</span>
<a name="l00107"></a>00107 <span class="preprocessor"></span>        <a class="code" href="AndroidUtils_8cpp.html#aaa5c9bf2289dec09f59ef2b7ba6c66ae">LogMsg</a>(<span class="stringliteral">&quot;SendUnexpectedPurchaseSignal&gt; Sending message %d about %s&quot;</span>, returnState,  itemID.c_str());
<a name="l00108"></a>00108 <span class="preprocessor">        #endif</span>
<a name="l00109"></a>00109 <span class="preprocessor"></span>
<a name="l00110"></a>00110         <a class="code" href="classVariantList.html">VariantList</a> vList( (<a class="code" href="PlatformSetupAndroid_8h.html#acbd4acd0d29e2d6c43104827f77d9cd2">uint32</a>)returnState, extra, itemID);
<a name="l00111"></a>00111         <a class="code" href="classIAPManager.html#ad37a8ab10f39bf5e45be7b1497406395" title="A signal for reporting an unexpected purchase or refund (happens on android only so far...">m_sig_item_unexpected_purchase_result</a>(&amp;vList);
<a name="l00112"></a>00112 }
<a name="l00113"></a>00113                                                                                           
<a name="l00114"></a><a class="code" href="classIAPManager.html#af113caea83440359c71578323116696f">00114</a> <span class="keywordtype">void</span> <a class="code" href="classIAPManager.html#af113caea83440359c71578323116696f">IAPManager::HandleIAPBuyResult</a>(<a class="code" href="classMessage.html">Message</a> &amp;<a class="code" href="Renderer_2GL_2glext_8h.html#af593500c283bf1a787a6f947f503a5c2">m</a>)
<a name="l00115"></a>00115 {
<a name="l00116"></a>00116         <a class="code" href="classIAPManager.html#abad5a5451b6ea38b596f06514ca976de">m_extraData</a> = m.<a class="code" href="classMessage.html#a44abed0364b1eb3a7f222b320cec9ab3">GetStringParm</a>();
<a name="l00117"></a>00117 
<a name="l00118"></a>00118 <span class="preprocessor">#ifdef SHOW_DEBUG_IAP_MESSAGES</span>
<a name="l00119"></a>00119 <span class="preprocessor"></span>        <a class="code" href="AndroidUtils_8cpp.html#aaa5c9bf2289dec09f59ef2b7ba6c66ae">LogMsg</a>(<span class="stringliteral">&quot;Got MESSAGE_TYPE_IAP_RESULT response: %d - Extra: %s&quot;</span>, (<span class="keywordtype">int</span>)m.<a class="code" href="classMessage.html#a06e5f10fce89602a8c1ac82c92af2809">GetParm1</a>(), <a class="code" href="classIAPManager.html#abad5a5451b6ea38b596f06514ca976de">m_extraData</a>.c_str());
<a name="l00120"></a>00120 <span class="preprocessor">#endif</span>
<a name="l00121"></a>00121 <span class="preprocessor"></span>
<a name="l00122"></a>00122         <a class="code" href="classIAPManager.html#a4eba1e3551452bddcd57d171ae110594">ResponseCode</a> <a class="code" href="Renderer_2GL_2glext_8h.html#a321ff419cd5252e54cf95e64dc6687ee">result</a> = <a class="code" href="classIAPManager.html#a4eba1e3551452bddcd57d171ae110594">ResponseCode</a>((<span class="keywordtype">int</span>)m.<a class="code" href="classMessage.html#a06e5f10fce89602a8c1ac82c92af2809">GetParm1</a>());
<a name="l00123"></a>00123         <span class="keywordflow">switch</span> (result)
<a name="l00124"></a>00124         {
<a name="l00125"></a>00125         <span class="keywordflow">case</span> <a class="code" href="classIAPManager.html#a4eba1e3551452bddcd57d171ae110594a8cc6bd4ec4655f1de929ee18593fa46e">RESULT_OK</a>:
<a name="l00126"></a>00126         <span class="keywordflow">case</span> <a class="code" href="classIAPManager.html#a4eba1e3551452bddcd57d171ae110594a7b17ee13fe761b725f57b168ec617129">RESULT_OK_ALREADY_PURCHASED</a>:
<a name="l00127"></a>00127                 <a class="code" href="classIAPManager.html#aa6aaca7ee5d2b4320b189a0379c714f3" title="Changes the state of the purchasing process and sends the m_sig_item_purchase_result signal...">endPurchaseProcessWithResult</a>(result == <a class="code" href="classIAPManager.html#a4eba1e3551452bddcd57d171ae110594a7b17ee13fe761b725f57b168ec617129">RESULT_OK_ALREADY_PURCHASED</a> ? <a class="code" href="classIAPManager.html#a223842c3fd3d0872d15c8a8bb0b08655aecb53e78a2db6a02729c0fdb7bb96ccb" title="The item has been purchased already previously.">RETURN_STATE_ALREADY_PURCHASED</a> : <a class="code" href="classIAPManager.html#a223842c3fd3d0872d15c8a8bb0b08655ae4c15f8fdf69c467afd692cff6bc2f8d" title="The purchase process has finished successfully.">RETURN_STATE_PURCHASED</a>);
<a name="l00128"></a>00128                 <span class="keywordflow">break</span>;
<a name="l00129"></a>00129 
<a name="l00130"></a>00130         <span class="keywordflow">case</span> <a class="code" href="classIAPManager.html#a4eba1e3551452bddcd57d171ae110594a43573d80579e854b2b383e2fc3150ba4">RESULT_USER_CANCELED</a>:
<a name="l00131"></a>00131                 <a class="code" href="classIAPManager.html#a1fc386e6234553cbd7306335f4bcb828">m_failureReason</a> = <a class="code" href="classIAPManager.html#a7f7617365e6feed3272cb227542658aba0e49d92260fb8f1a4cb92dec60c1cec1" title="The user canceled the purchase.">FAILURE_REASON_USER_CANCELED</a>;
<a name="l00132"></a>00132         <span class="keywordflow">default</span>:
<a name="l00133"></a>00133                 <a class="code" href="classIAPManager.html#aa6aaca7ee5d2b4320b189a0379c714f3" title="Changes the state of the purchasing process and sends the m_sig_item_purchase_result signal...">endPurchaseProcessWithResult</a>(<a class="code" href="classIAPManager.html#a223842c3fd3d0872d15c8a8bb0b08655a92a3da592797e3317e0d444aeff2b3f2" title="The purchase process has failed.">RETURN_STATE_FAILED</a>);
<a name="l00134"></a>00134                 <span class="keywordflow">break</span>;
<a name="l00135"></a>00135         }
<a name="l00136"></a>00136 
<a name="l00137"></a>00137         <a class="code" href="classIAPManager.html#a2575c9d567e4fd1198588665a05e2209">m_itemToBuy</a>.clear();
<a name="l00138"></a>00138 }
<a name="l00139"></a>00139 
<a name="l00140"></a><a class="code" href="classIAPManager.html#a672838a509523fa0b2cde6dfbe256333">00140</a> <span class="keywordtype">void</span> <a class="code" href="classIAPManager.html#a672838a509523fa0b2cde6dfbe256333">IAPManager::HandleItemUpdateState</a>(<a class="code" href="classMessage.html">Message</a> &amp;<a class="code" href="Renderer_2GL_2glext_8h.html#af593500c283bf1a787a6f947f503a5c2">m</a>)
<a name="l00141"></a>00141 {
<a name="l00142"></a>00142         
<a name="l00143"></a>00143 <span class="preprocessor">        #ifdef SHOW_DEBUG_IAP_MESSAGES</span>
<a name="l00144"></a>00144 <span class="preprocessor"></span>        <a class="code" href="AndroidUtils_8cpp.html#aaa5c9bf2289dec09f59ef2b7ba6c66ae">LogMsg</a>(<span class="stringliteral">&quot;New order received/changed: %d, about %s&quot;</span>, (<span class="keywordtype">int</span>)m.<a class="code" href="classMessage.html#a06e5f10fce89602a8c1ac82c92af2809">GetParm1</a>(), m.<a class="code" href="classMessage.html#a44abed0364b1eb3a7f222b320cec9ab3">GetStringParm</a>().c_str());
<a name="l00145"></a>00145 <span class="preprocessor">        #endif</span>
<a name="l00146"></a>00146 <span class="preprocessor"></span>                
<a name="l00147"></a>00147                 <span class="keywordflow">switch</span> (<a class="code" href="classIAPManager.html#abe3136a2a3e068e9112aadc70970beeb">ItemStateCode</a>((<span class="keywordtype">int</span>)m.<a class="code" href="classMessage.html#a06e5f10fce89602a8c1ac82c92af2809">GetParm1</a>()))
<a name="l00148"></a>00148                 {
<a name="l00149"></a>00149                 <span class="keywordflow">case</span> <a class="code" href="classIAPManager.html#abe3136a2a3e068e9112aadc70970beebaa945f2a908bb27a45a70718dc64ec49d">END_OF_LIST</a>:
<a name="l00150"></a>00150                 {
<a name="l00151"></a>00151                         <a class="code" href="AndroidUtils_8cpp.html#aaa5c9bf2289dec09f59ef2b7ba6c66ae">LogMsg</a>(<span class="stringliteral">&quot;END_OF_LIST while getting an item update state?&quot;</span>);
<a name="l00152"></a>00152                         <span class="keywordflow">break</span>;
<a name="l00153"></a>00153                 }
<a name="l00154"></a>00154 
<a name="l00155"></a>00155                 <span class="keywordflow">case</span> <a class="code" href="classIAPManager.html#abe3136a2a3e068e9112aadc70970beebafc4c2543a3d8a568de42793c230c45c4">PURCHASED</a>:
<a name="l00156"></a>00156                 {
<a name="l00157"></a>00157 <span class="preprocessor">                        #ifdef SHOW_DEBUG_IAP_MESSAGES</span>
<a name="l00158"></a>00158 <span class="preprocessor"></span>                                                <a class="code" href="AndroidUtils_8cpp.html#aaa5c9bf2289dec09f59ef2b7ba6c66ae">LogMsg</a>(<span class="stringliteral">&quot;Has purchased %s&quot;</span>, m.<a class="code" href="classMessage.html#a44abed0364b1eb3a7f222b320cec9ab3">GetStringParm</a>().c_str());
<a name="l00159"></a>00159 <span class="preprocessor">                        #endif</span>
<a name="l00160"></a>00160 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (<a class="code" href="classIAPManager.html#af9a4419ea019aab255df7213c76fe79e">m_state</a> == <a class="code" href="classIAPManager.html#a759bce61b8886fee5ec1a54c9c061ca8ac28c71c696512f00741ea8d626f8c021">STATE_WAITING</a>)
<a name="l00161"></a>00161                         {
<a name="l00162"></a>00162                                 <a class="code" href="classIAPManager.html#aa6aaca7ee5d2b4320b189a0379c714f3" title="Changes the state of the purchasing process and sends the m_sig_item_purchase_result signal...">endPurchaseProcessWithResult</a>(<a class="code" href="classIAPManager.html#a223842c3fd3d0872d15c8a8bb0b08655ae4c15f8fdf69c467afd692cff6bc2f8d" title="The purchase process has finished successfully.">RETURN_STATE_PURCHASED</a>);
<a name="l00163"></a>00163                         } <span class="keywordflow">else</span>
<a name="l00164"></a>00164                         {
<a name="l00165"></a>00165 <span class="preprocessor">                                #ifdef SHOW_DEBUG_IAP_MESSAGES</span>
<a name="l00166"></a>00166 <span class="preprocessor"></span>                                        <a class="code" href="AndroidUtils_8cpp.html#aaa5c9bf2289dec09f59ef2b7ba6c66ae">LogMsg</a>(<span class="stringliteral">&quot;Got unplanned item purchase message, must have been delayed and delivered later.  Item: %s&quot;</span>, m.<a class="code" href="classMessage.html#a44abed0364b1eb3a7f222b320cec9ab3">GetStringParm</a>().c_str());
<a name="l00167"></a>00167 <span class="preprocessor">                                #endif</span>
<a name="l00168"></a>00168 <span class="preprocessor"></span>                                
<a name="l00169"></a>00169                                 <a class="code" href="classIAPManager.html#ad0abe33426cec37a8a33d212b68477e3">SendUnexpectedPurchaseSignal</a>(<a class="code" href="classIAPManager.html#a223842c3fd3d0872d15c8a8bb0b08655ae4c15f8fdf69c467afd692cff6bc2f8d" title="The purchase process has finished successfully.">RETURN_STATE_PURCHASED</a>, m.<a class="code" href="classMessage.html#a44abed0364b1eb3a7f222b320cec9ab3">GetStringParm</a>(), <span class="stringliteral">&quot;&quot;</span>);
<a name="l00170"></a>00170                         }
<a name="l00171"></a>00171                         <span class="keywordflow">break</span>;
<a name="l00172"></a>00172                 }
<a name="l00173"></a>00173 
<a name="l00174"></a>00174                 <span class="keywordflow">case</span> <a class="code" href="classIAPManager.html#abe3136a2a3e068e9112aadc70970beeba0332d514241c4a4a355181cba187651a">CANCELED</a>:
<a name="l00175"></a>00175                         <span class="keywordflow">if</span> (<a class="code" href="classIAPManager.html#af9a4419ea019aab255df7213c76fe79e">m_state</a> == <a class="code" href="classIAPManager.html#a759bce61b8886fee5ec1a54c9c061ca8ac28c71c696512f00741ea8d626f8c021">STATE_WAITING</a>)
<a name="l00176"></a>00176                         {
<a name="l00177"></a>00177                                 <a class="code" href="classIAPManager.html#aa6aaca7ee5d2b4320b189a0379c714f3" title="Changes the state of the purchasing process and sends the m_sig_item_purchase_result signal...">endPurchaseProcessWithResult</a>(<a class="code" href="classIAPManager.html#a223842c3fd3d0872d15c8a8bb0b08655a92a3da592797e3317e0d444aeff2b3f2" title="The purchase process has failed.">RETURN_STATE_FAILED</a>);
<a name="l00178"></a>00178                         } <span class="keywordflow">else</span>
<a name="l00179"></a>00179                         {
<a name="l00180"></a>00180                                 <span class="comment">//huh?  This apparently gets sent instead of REFUNDED sometimes</span>
<a name="l00181"></a>00181                                 <span class="comment">//handle as a real refund message that we didn&#39;t expect</span>
<a name="l00182"></a>00182                                 <a class="code" href="classIAPManager.html#ad0abe33426cec37a8a33d212b68477e3">SendUnexpectedPurchaseSignal</a>(<a class="code" href="classIAPManager.html#a223842c3fd3d0872d15c8a8bb0b08655a75a63c7329b94bdf6f7aa3428a4f6bf4" title="The item has been refunded - only applicable to android and if you listen to m_sig_item_unexpected_pu...">RETURN_STATE_REFUNDED</a>, m.<a class="code" href="classMessage.html#a44abed0364b1eb3a7f222b320cec9ab3">GetStringParm</a>(), <span class="stringliteral">&quot;&quot;</span>);
<a name="l00183"></a>00183                         }
<a name="l00184"></a>00184                         <span class="keywordflow">break</span>;
<a name="l00185"></a>00185                 
<a name="l00186"></a>00186                 <span class="keywordflow">case</span> <a class="code" href="classIAPManager.html#abe3136a2a3e068e9112aadc70970beebac6567fb7ae9a7ba2a02a82663d37d267">REFUNDED</a>:
<a name="l00187"></a>00187                         
<a name="l00188"></a>00188                         <a class="code" href="AndroidUtils_8cpp.html#aaa5c9bf2289dec09f59ef2b7ba6c66ae">LogMsg</a>(<span class="stringliteral">&quot;Got item refund message. item: %s&quot;</span>, m.<a class="code" href="classMessage.html#a44abed0364b1eb3a7f222b320cec9ab3">GetStringParm</a>().c_str());
<a name="l00189"></a>00189                         
<a name="l00190"></a>00190                         <span class="comment">//I don&#39;t think we&#39;d normally ever get this while waiting for a purchase to go through (can&#39;t refund what we don&#39;t own yet) but</span>
<a name="l00191"></a>00191                         <span class="comment">//when buying the android.test.refunded item this does happen, so we&#39;ll handle it as a cancel if we&#39;re waiting on a reply</span>
<a name="l00192"></a>00192                         <span class="keywordflow">if</span> (<a class="code" href="classIAPManager.html#af9a4419ea019aab255df7213c76fe79e">m_state</a> == <a class="code" href="classIAPManager.html#a759bce61b8886fee5ec1a54c9c061ca8ac28c71c696512f00741ea8d626f8c021">STATE_WAITING</a>)
<a name="l00193"></a>00193                         {
<a name="l00194"></a>00194                                 <a class="code" href="classIAPManager.html#aa6aaca7ee5d2b4320b189a0379c714f3" title="Changes the state of the purchasing process and sends the m_sig_item_purchase_result signal...">endPurchaseProcessWithResult</a>(<a class="code" href="classIAPManager.html#a223842c3fd3d0872d15c8a8bb0b08655a92a3da592797e3317e0d444aeff2b3f2" title="The purchase process has failed.">RETURN_STATE_FAILED</a>);
<a name="l00195"></a>00195                         } <span class="keywordflow">else</span>
<a name="l00196"></a>00196                         {
<a name="l00197"></a>00197                                 <span class="comment">//handle as a real refund message that we didn&#39;t expect</span>
<a name="l00198"></a>00198                                 <a class="code" href="classIAPManager.html#ad0abe33426cec37a8a33d212b68477e3">SendUnexpectedPurchaseSignal</a>(<a class="code" href="classIAPManager.html#a223842c3fd3d0872d15c8a8bb0b08655a75a63c7329b94bdf6f7aa3428a4f6bf4" title="The item has been refunded - only applicable to android and if you listen to m_sig_item_unexpected_pu...">RETURN_STATE_REFUNDED</a>, m.<a class="code" href="classMessage.html#a44abed0364b1eb3a7f222b320cec9ab3">GetStringParm</a>(), <span class="stringliteral">&quot;&quot;</span>);
<a name="l00199"></a>00199                         }
<a name="l00200"></a>00200 
<a name="l00201"></a>00201                         <span class="keywordflow">break</span>;
<a name="l00202"></a>00202                 }
<a name="l00203"></a>00203 }
<a name="l00204"></a>00204 
<a name="l00205"></a><a class="code" href="classIAPManager.html#a08af673af7968531d282fc0125d028e5">00205</a> <span class="keywordtype">void</span> <a class="code" href="classIAPManager.html#a08af673af7968531d282fc0125d028e5" title="Use this to pass messages for the IAPManager to handle.">IAPManager::OnMessage</a>( <a class="code" href="classMessage.html">Message</a> &amp;<a class="code" href="Renderer_2GL_2glext_8h.html#af593500c283bf1a787a6f947f503a5c2">m</a> )
<a name="l00206"></a>00206 {
<a name="l00207"></a>00207 
<a name="l00208"></a>00208         <span class="keywordflow">switch</span> (m.<a class="code" href="classMessage.html#a90210f98735c1ed9cc0efa200121364a">GetType</a>())
<a name="l00209"></a>00209         {
<a name="l00210"></a>00210         <span class="keywordflow">case</span> <a class="code" href="MessageManager_8h.html#a700ed30d49bfe436323e17539d3a0010a386c1e41dd85c6e32116e56117e777b6">MESSAGE_TYPE_IAP_PURCHASED_LIST_STATE</a>:
<a name="l00211"></a>00211                 <a class="code" href="classIAPManager.html#a1121d0e33426e0844493f65528df57ef">HandlePurchaseListReply</a>(m);
<a name="l00212"></a>00212                 <span class="keywordflow">break</span>;
<a name="l00213"></a>00213         
<a name="l00214"></a>00214         <span class="keywordflow">case</span> <a class="code" href="MessageManager_8h.html#a700ed30d49bfe436323e17539d3a0010acf4b526d6d7762fe800e182038013f1b">MESSAGE_TYPE_IAP_RESULT</a>:
<a name="l00215"></a>00215         {
<a name="l00216"></a>00216                 <a class="code" href="classIAPManager.html#af113caea83440359c71578323116696f">HandleIAPBuyResult</a>(m);
<a name="l00217"></a>00217                 <span class="keywordflow">break</span>;
<a name="l00218"></a>00218         }
<a name="l00219"></a>00219 
<a name="l00220"></a>00220         <span class="keywordflow">case</span> <a class="code" href="MessageManager_8h.html#a700ed30d49bfe436323e17539d3a0010a2e59e52cf8ff0b27ed4597d1c25f9461">MESSAGE_TYPE_IAP_ITEM_STATE</a>:
<a name="l00221"></a>00221         {
<a name="l00222"></a>00222                 <span class="comment">//an item was purchased, or refunded.  Currently called by android only, and can be called at any time the app is initizalized, not</span>
<a name="l00223"></a>00223                 <span class="comment">//just when we are asking to buy something.</span>
<a name="l00224"></a>00224                 <a class="code" href="classIAPManager.html#a672838a509523fa0b2cde6dfbe256333">HandleItemUpdateState</a>(m);
<a name="l00225"></a>00225                 <span class="keywordflow">break</span>;
<a name="l00226"></a>00226         }
<a name="l00227"></a>00227 
<a name="l00228"></a>00228         <span class="keywordflow">default</span>:
<a name="l00229"></a>00229                 <span class="keywordflow">break</span>;
<a name="l00230"></a>00230         }
<a name="l00231"></a>00231 }
<a name="l00232"></a>00232 
<a name="l00233"></a><a class="code" href="classIAPManager.html#a13bdf049e394967ec81a36e25d5a8328">00233</a> <span class="keywordtype">bool</span> <a class="code" href="classIAPManager.html#a13bdf049e394967ec81a36e25d5a8328">IAPManager::Init</a>()
<a name="l00234"></a>00234 {
<a name="l00235"></a>00235         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00236"></a>00236 }
<a name="l00237"></a>00237 
<a name="l00238"></a><a class="code" href="classIAPManager.html#abf116c86999fe14c57ed286a1ee219dc">00238</a> <span class="keywordtype">void</span> <a class="code" href="classIAPManager.html#abf116c86999fe14c57ed286a1ee219dc">IAPManager::Update</a>()
<a name="l00239"></a>00239 {
<a name="l00240"></a>00240 <span class="preprocessor">#if defined (FAKE_IAP_REPLY)</span>
<a name="l00241"></a>00241 <span class="preprocessor"></span>        
<a name="l00242"></a>00242         <span class="keywordflow">if</span> (<a class="code" href="classIAPManager.html#afdc93a425e0981c05e09fe5a7cdfe1a2">m_bWaitingForReply</a>)
<a name="l00243"></a>00243         {
<a name="l00244"></a>00244                 <span class="comment">//don&#39;t support billing on this platform (probably testing in desktop), fake it after 3 seconds for testing purposes</span>
<a name="l00245"></a>00245 
<a name="l00246"></a>00246 <span class="preprocessor">        #ifdef FAKE_IAP_RESPONSE_TIME_OUT</span>
<a name="l00247"></a>00247 <span class="preprocessor"></span>                <span class="comment">//we will never send a reply, as if they suddenly lost connection or whatever</span>
<a name="l00248"></a>00248                 <span class="keywordflow">return</span>;
<a name="l00249"></a>00249 <span class="preprocessor">        #endif</span>
<a name="l00250"></a>00250 <span class="preprocessor"></span>
<a name="l00251"></a>00251                 <span class="keywordflow">if</span> (<a class="code" href="classIAPManager.html#a426e020b745012ce92104ddace9219c2">m_timer</a>+3000 &lt; <a class="code" href="BaseApp_8cpp.html#a8335cabda3b97e427d7e0dfdc71f5591">GetTick</a>(<a class="code" href="MessageManager_8h.html#a6ccdae1e5bdcea24cc3c7a814445e196a1f41a724a7ed2283070514f600166e04">TIMER_SYSTEM</a>))
<a name="l00252"></a>00252                 {
<a name="l00253"></a>00253                         <a class="code" href="AndroidUtils_8cpp.html#aaa5c9bf2289dec09f59ef2b7ba6c66ae">LogMsg</a>(<span class="stringliteral">&quot;Doing fake reply&quot;</span>);
<a name="l00254"></a>00254                         <span class="comment">//fake a successful sale message back to us, so we&#39;ll process the order even while emulating on desktop</span>
<a name="l00255"></a>00255                         <a class="code" href="classIAPManager.html#afdc93a425e0981c05e09fe5a7cdfe1a2">m_bWaitingForReply</a> = <span class="keyword">false</span>;
<a name="l00256"></a>00256 
<a name="l00257"></a>00257                                 <span class="comment">//WebOS &amp; iOS</span>
<a name="l00258"></a>00258                                 <span class="comment">//DEBUG - To test successful or faked purchases under desktop emulation</span>
<a name="l00259"></a>00259 <span class="preprocessor">                                #if defined (FAKE_IAP_RESPONSE_SUCCESS)</span>
<a name="l00260"></a>00260 <span class="preprocessor"></span>                                <a class="code" href="BaseApp_8h.html#a11454091168162d8f3991461725aa24f">GetMessageManager</a>()-&gt;<a class="code" href="classMessageManager.html#a54eb18bb73fa1a7c266d6a52732f1c87">SendGUIStringEx</a>(<a class="code" href="MessageManager_8h.html#a700ed30d49bfe436323e17539d3a0010acf4b526d6d7762fe800e182038013f1b">MESSAGE_TYPE_IAP_RESULT</a>, (<span class="keywordtype">float</span>)<a class="code" href="classIAPManager.html#a4eba1e3551452bddcd57d171ae110594a8cc6bd4ec4655f1de929ee18593fa46e">IAPManager::RESULT_OK</a>, 0.0<a class="code" href="Renderer_2GL_2glext_8h.html#aba8ad56949f59242bc167b073dae3715">f</a>, 0, <span class="stringliteral">&quot;Faked order for testing: OK&quot;</span>);
<a name="l00261"></a>00261 <span class="preprocessor">                                #elif defined (FAKE_IAP_RESPONSE_ALREADY_PURCHASED)</span>
<a name="l00262"></a>00262 <span class="preprocessor"></span>                                <a class="code" href="BaseApp_8h.html#a11454091168162d8f3991461725aa24f">GetMessageManager</a>()-&gt;<a class="code" href="classMessageManager.html#a54eb18bb73fa1a7c266d6a52732f1c87">SendGUIStringEx</a>(<a class="code" href="MessageManager_8h.html#a700ed30d49bfe436323e17539d3a0010acf4b526d6d7762fe800e182038013f1b">MESSAGE_TYPE_IAP_RESULT</a>, (<span class="keywordtype">float</span>)<a class="code" href="classIAPManager.html#a4eba1e3551452bddcd57d171ae110594a7b17ee13fe761b725f57b168ec617129">IAPManager::RESULT_OK_ALREADY_PURCHASED</a>, 0.0<a class="code" href="Renderer_2GL_2glext_8h.html#aba8ad56949f59242bc167b073dae3715">f</a>, 0, <span class="stringliteral">&quot;Faked order for testing: already purchased&quot;</span>);
<a name="l00263"></a>00263 <span class="preprocessor">                                #elif defined (FAKE_IAP_RESPONSE_FAILED)</span>
<a name="l00264"></a>00264 <span class="preprocessor"></span>                                <a class="code" href="BaseApp_8h.html#a11454091168162d8f3991461725aa24f">GetMessageManager</a>()-&gt;<a class="code" href="classMessageManager.html#a54eb18bb73fa1a7c266d6a52732f1c87">SendGUIStringEx</a>(<a class="code" href="MessageManager_8h.html#a700ed30d49bfe436323e17539d3a0010acf4b526d6d7762fe800e182038013f1b">MESSAGE_TYPE_IAP_RESULT</a>, (<span class="keywordtype">float</span>)<a class="code" href="classIAPManager.html#a4eba1e3551452bddcd57d171ae110594a618d92a075e97b07297bc533444a04b0">IAPManager::RESULT_ERROR</a>, 0.0<a class="code" href="Renderer_2GL_2glext_8h.html#aba8ad56949f59242bc167b073dae3715">f</a>, 0, <span class="stringliteral">&quot;Faked order for testing: error&quot;</span>);
<a name="l00265"></a>00265 <span class="preprocessor">                                #else</span>
<a name="l00266"></a>00266 <span class="preprocessor"></span>                                <a class="code" href="BaseApp_8h.html#a11454091168162d8f3991461725aa24f">GetMessageManager</a>()-&gt;<a class="code" href="classMessageManager.html#a54eb18bb73fa1a7c266d6a52732f1c87">SendGUIStringEx</a>(<a class="code" href="MessageManager_8h.html#a700ed30d49bfe436323e17539d3a0010acf4b526d6d7762fe800e182038013f1b">MESSAGE_TYPE_IAP_RESULT</a>, (<span class="keywordtype">float</span>)<a class="code" href="classIAPManager.html#a4eba1e3551452bddcd57d171ae110594a43573d80579e854b2b383e2fc3150ba4">IAPManager::RESULT_USER_CANCELED</a>, 0.0<a class="code" href="Renderer_2GL_2glext_8h.html#aba8ad56949f59242bc167b073dae3715">f</a>, 0, <span class="stringliteral">&quot;Faked order for testing: user canceled&quot;</span>);
<a name="l00267"></a>00267 <span class="preprocessor">                                #endif</span>
<a name="l00268"></a>00268 <span class="preprocessor"></span>                        
<a name="l00269"></a>00269                 }
<a name="l00270"></a>00270         }
<a name="l00271"></a>00271 <span class="preprocessor">#endif</span>
<a name="l00272"></a>00272 <span class="preprocessor"></span>}
<a name="l00273"></a>00273 
<a name="l00274"></a><a class="code" href="classIAPManager.html#abb998adecf95133e0340019abe17ffe8">00274</a> <span class="keywordtype">void</span> <a class="code" href="classIAPManager.html#abb998adecf95133e0340019abe17ffe8" title="Starts a purchasing process for the given itemName.">IAPManager::BuyItem</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp;itemName)
<a name="l00275"></a>00275 {
<a name="l00276"></a>00276         <a class="code" href="classIAPManager.html#aa48490656c38e992ce60468e6fc17f35" title="Resets the state of the IAPManager.">Reset</a>();
<a name="l00277"></a>00277 
<a name="l00278"></a>00278         <a class="code" href="classIAPManager.html#ad3846fd7e2686f1671fe0063e8892caf">m_lastItemID</a> = itemName;
<a name="l00279"></a>00279         <a class="code" href="classIAPManager.html#a2575c9d567e4fd1198588665a05e2209">m_itemToBuy</a> = itemName;
<a name="l00280"></a>00280 
<a name="l00281"></a>00281 <span class="preprocessor">#ifdef SHOW_DEBUG_IAP_MESSAGES</span>
<a name="l00282"></a>00282 <span class="preprocessor"></span>        <a class="code" href="AndroidUtils_8cpp.html#aaa5c9bf2289dec09f59ef2b7ba6c66ae">LogMsg</a>(<span class="stringliteral">&quot;Planning to buy %s&quot;</span>, itemName.c_str());
<a name="l00283"></a>00283 <span class="preprocessor">#endif</span>
<a name="l00284"></a>00284 <span class="preprocessor"></span>
<a name="l00285"></a>00285         <span class="keywordflow">if</span> (<a class="code" href="PlatformEnums_8h.html#a5eec67bdc9a66fa580686bcf211485f0" title="Gets the emulated platform id.">GetEmulatedPlatformID</a>() == <a class="code" href="PlatformEnums_8h.html#aaa43572fa440af9fa31b5ef4155975b2a4c56589fc030bd59718aaf643434c790">PLATFORM_ID_ANDROID</a>)
<a name="l00286"></a>00286         {
<a name="l00287"></a>00287                 <span class="comment">//The Android in-app-billing way</span>
<a name="l00288"></a>00288 
<a name="l00289"></a>00289                 <span class="comment">//we&#39;ll query all purchased items first, because if we try to buy something already purchased, it will give an</span>
<a name="l00290"></a>00290                 <span class="comment">//annoying error to the user and not send us any response.</span>
<a name="l00291"></a>00291                 <span class="comment">//We should probably modify this to only scan once in a while but it seems very quick, so  meh.</span>
<a name="l00292"></a>00292 
<a name="l00293"></a>00293                 <a class="code" href="classIAPManager.html#a3f219041483f1bb2524a3ddedcfdf545">m_items</a>.clear();
<a name="l00294"></a>00294                 <a class="code" href="classIAPManager.html#af9a4419ea019aab255df7213c76fe79e">m_state</a> = <a class="code" href="classIAPManager.html#a759bce61b8886fee5ec1a54c9c061ca8ac28c71c696512f00741ea8d626f8c021">STATE_WAITING</a>;
<a name="l00295"></a>00295                 
<a name="l00296"></a>00296 <span class="preprocessor">                #ifndef FAKE_IAP_REPLY</span>
<a name="l00297"></a>00297 <span class="preprocessor"></span>                        <a class="code" href="structOSMessage.html">OSMessage</a> o;
<a name="l00298"></a>00298                         o.<a class="code" href="structOSMessage.html#a15a064581798f6bc8724440f285eacd7">m_type</a> = <a class="code" href="structOSMessage.html#a9fc98c3cc1a5a51feb7a977b01defadcade5344fa85b091eafd86dbcc0b4b28a3">OSMessage::MESSAGE_IAP_GET_PURCHASED_LIST</a>;
<a name="l00299"></a>00299                         <a class="code" href="BaseApp_8h.html#a72086b48d24daf0a65dd20189a16bd16">GetBaseApp</a>()-&gt;<a class="code" href="classBaseApp.html#a8c4775724ea459bdf155a6920a44d6db">AddOSMessage</a>(o);
<a name="l00300"></a>00300 <span class="preprocessor">                #else</span>
<a name="l00301"></a>00301 <span class="preprocessor"></span>                <span class="comment">//faking it, this way is easier</span>
<a name="l00302"></a>00302                 
<a name="l00303"></a>00303                 <a class="code" href="classIAPManager.html#a55a48ddbc182cc2ff2c1070ed658e07c">sendPurchaseMessage</a>();
<a name="l00304"></a>00304 <span class="preprocessor">                #endif</span>
<a name="l00305"></a>00305 <span class="preprocessor"></span>        } <span class="keywordflow">else</span>
<a name="l00306"></a>00306         {
<a name="l00307"></a>00307                 <span class="comment">//issue buy command the normal way, it&#39;s not like Android where you need to get a list of stuff first</span>
<a name="l00308"></a>00308                 <a class="code" href="classIAPManager.html#a55a48ddbc182cc2ff2c1070ed658e07c">sendPurchaseMessage</a>();
<a name="l00309"></a>00309         }
<a name="l00310"></a>00310         
<a name="l00311"></a>00311 }
<a name="l00312"></a>00312 
<a name="l00313"></a><a class="code" href="classIAPManager.html#aa48490656c38e992ce60468e6fc17f35">00313</a> <span class="keywordtype">void</span> <a class="code" href="classIAPManager.html#aa48490656c38e992ce60468e6fc17f35" title="Resets the state of the IAPManager.">IAPManager::Reset</a>()
<a name="l00314"></a>00314 {
<a name="l00315"></a>00315         <a class="code" href="classIAPManager.html#af9a4419ea019aab255df7213c76fe79e">m_state</a> = <a class="code" href="classIAPManager.html#a759bce61b8886fee5ec1a54c9c061ca8ad3b42ddab3726e40e4b06af7e1895d9e">STATE_NONE</a>;
<a name="l00316"></a>00316         <a class="code" href="classIAPManager.html#a3c15d8b9220038313d0f5190e1a5f7e9">m_returnState</a> = <a class="code" href="classIAPManager.html#a223842c3fd3d0872d15c8a8bb0b08655a467fa3913ffa1091b3007a8fb36d5a2b" title="No result available.">RETURN_STATE_NONE</a>;
<a name="l00317"></a>00317         <a class="code" href="classIAPManager.html#a1fc386e6234553cbd7306335f4bcb828">m_failureReason</a> = <a class="code" href="classIAPManager.html#a7f7617365e6feed3272cb227542658ababde6ecbb2875de7b2d657d7369fe9659" title="Either there was no failure or the reason is not known.">FAILURE_REASON_NONE</a>;
<a name="l00318"></a>00318         <a class="code" href="classIAPManager.html#abad5a5451b6ea38b596f06514ca976de">m_extraData</a>.clear();
<a name="l00319"></a>00319         <a class="code" href="classIAPManager.html#a426e020b745012ce92104ddace9219c2">m_timer</a> = 0;
<a name="l00320"></a>00320 }
<a name="l00321"></a>00321 
<a name="l00322"></a><a class="code" href="classIAPManager.html#a55a48ddbc182cc2ff2c1070ed658e07c">00322</a> <span class="keywordtype">void</span> <a class="code" href="classIAPManager.html#a55a48ddbc182cc2ff2c1070ed658e07c">IAPManager::sendPurchaseMessage</a>()
<a name="l00323"></a>00323 {
<a name="l00324"></a>00324 <span class="preprocessor">        #ifndef FAKE_IAP_REPLY</span>
<a name="l00325"></a>00325 <span class="preprocessor"></span>        <span class="comment">//this is the real thing, send message to native system</span>
<a name="l00326"></a>00326         <a class="code" href="structOSMessage.html">OSMessage</a> o;
<a name="l00327"></a>00327         o.<a class="code" href="structOSMessage.html#a15a064581798f6bc8724440f285eacd7">m_type</a> = <a class="code" href="structOSMessage.html#a9fc98c3cc1a5a51feb7a977b01defadcae713c20e069a136af93e51fb026c49c7">OSMessage::MESSAGE_IAP_PURCHASE</a>;
<a name="l00328"></a>00328         o.<a class="code" href="structOSMessage.html#a30c292046d221c99a48dd1915298bf35">m_string</a> = <a class="code" href="classIAPManager.html#a2575c9d567e4fd1198588665a05e2209">m_itemToBuy</a>;
<a name="l00329"></a>00329         <a class="code" href="BaseApp_8h.html#a72086b48d24daf0a65dd20189a16bd16">GetBaseApp</a>()-&gt;<a class="code" href="classBaseApp.html#a8c4775724ea459bdf155a6920a44d6db">AddOSMessage</a>(o);
<a name="l00330"></a>00330 <span class="preprocessor">        #endif</span>
<a name="l00331"></a>00331 <span class="preprocessor"></span>
<a name="l00332"></a>00332         <a class="code" href="classIAPManager.html#a2575c9d567e4fd1198588665a05e2209">m_itemToBuy</a>.clear();
<a name="l00333"></a>00333         <a class="code" href="classIAPManager.html#a426e020b745012ce92104ddace9219c2">m_timer</a> = <a class="code" href="BaseApp_8cpp.html#a8335cabda3b97e427d7e0dfdc71f5591">GetTick</a>(<a class="code" href="MessageManager_8h.html#a6ccdae1e5bdcea24cc3c7a814445e196a1f41a724a7ed2283070514f600166e04">TIMER_SYSTEM</a>);
<a name="l00334"></a>00334         <a class="code" href="classIAPManager.html#afdc93a425e0981c05e09fe5a7cdfe1a2">m_bWaitingForReply</a> = <span class="keyword">true</span>;
<a name="l00335"></a>00335         <a class="code" href="classIAPManager.html#af9a4419ea019aab255df7213c76fe79e">m_state</a> = <a class="code" href="classIAPManager.html#a759bce61b8886fee5ec1a54c9c061ca8ac28c71c696512f00741ea8d626f8c021">STATE_WAITING</a>;
<a name="l00336"></a>00336 }
<a name="l00337"></a>00337 
<a name="l00338"></a><a class="code" href="classIAPManager.html#aa6aaca7ee5d2b4320b189a0379c714f3">00338</a> <span class="keywordtype">void</span> <a class="code" href="classIAPManager.html#aa6aaca7ee5d2b4320b189a0379c714f3" title="Changes the state of the purchasing process and sends the m_sig_item_purchase_result signal...">IAPManager::endPurchaseProcessWithResult</a>(<a class="code" href="classIAPManager.html#a223842c3fd3d0872d15c8a8bb0b08655" title="The result of a purchase process.">eReturnState</a> returnState)
<a name="l00339"></a>00339 {
<a name="l00340"></a>00340         <a class="code" href="classIAPManager.html#af9a4419ea019aab255df7213c76fe79e">m_state</a> = <a class="code" href="classIAPManager.html#a759bce61b8886fee5ec1a54c9c061ca8ad3b42ddab3726e40e4b06af7e1895d9e">STATE_NONE</a>;
<a name="l00341"></a>00341         <a class="code" href="classIAPManager.html#a3c15d8b9220038313d0f5190e1a5f7e9">m_returnState</a> = returnState;
<a name="l00342"></a>00342         <a class="code" href="classVariantList.html">VariantList</a> vList(<a class="code" href="PlatformSetupAndroid_8h.html#acbd4acd0d29e2d6c43104827f77d9cd2">uint32</a>(<a class="code" href="classIAPManager.html#a3c15d8b9220038313d0f5190e1a5f7e9">m_returnState</a>), <a class="code" href="classIAPManager.html#abad5a5451b6ea38b596f06514ca976de">m_extraData</a>, <a class="code" href="classIAPManager.html#ad3846fd7e2686f1671fe0063e8892caf">m_lastItemID</a>, <a class="code" href="PlatformSetupAndroid_8h.html#acbd4acd0d29e2d6c43104827f77d9cd2">uint32</a>(<a class="code" href="classIAPManager.html#a1fc386e6234553cbd7306335f4bcb828">m_failureReason</a>));
<a name="l00343"></a>00343         <a class="code" href="classIAPManager.html#a41fd4659e2439177a6c27b5c512fc55e" title="A signal for reporting changes in the purchasing process, when waiting for a buy request to happen...">m_sig_item_purchase_result</a>(&amp;vList);
<a name="l00344"></a>00344 }
<a name="l00345"></a>00345 
<a name="l00346"></a><a class="code" href="classIAPManager.html#af4e8e2827e887d19e11301fd68ea9496">00346</a> <span class="keywordtype">void</span> <a class="code" href="classIAPManager.html#af4e8e2827e887d19e11301fd68ea9496" title="Refreshes any previous and outstanding purchases and causes IsItemPurchased() to return valid results...">IAPManager::SyncPurchases</a>()
<a name="l00347"></a>00347 {
<a name="l00348"></a>00348         <a class="code" href="AndroidUtils_8cpp.html#aaa5c9bf2289dec09f59ef2b7ba6c66ae">LogMsg</a>(<span class="stringliteral">&quot;Syncing purchases...&quot;</span>);
<a name="l00349"></a>00349         <a class="code" href="classIAPManager.html#a3f219041483f1bb2524a3ddedcfdf545">m_items</a>.clear();
<a name="l00350"></a>00350 
<a name="l00351"></a>00351         <a class="code" href="structOSMessage.html">OSMessage</a> o;
<a name="l00352"></a>00352         o.<a class="code" href="structOSMessage.html#a15a064581798f6bc8724440f285eacd7">m_type</a> = <a class="code" href="structOSMessage.html#a9fc98c3cc1a5a51feb7a977b01defadcade5344fa85b091eafd86dbcc0b4b28a3">OSMessage::MESSAGE_IAP_GET_PURCHASED_LIST</a>;
<a name="l00353"></a>00353         <a class="code" href="BaseApp_8h.html#a72086b48d24daf0a65dd20189a16bd16">GetBaseApp</a>()-&gt;<a class="code" href="classBaseApp.html#a8c4775724ea459bdf155a6920a44d6db">AddOSMessage</a>(o);
<a name="l00354"></a>00354 }
<a name="l00355"></a>00355 
<a name="l00356"></a><a class="code" href="classIAPManager.html#acac971293f748942a114c1e693be3e0f">00356</a> <span class="keywordtype">void</span> <a class="code" href="classIAPManager.html#acac971293f748942a114c1e693be3e0f" title="For testing only - Mimics behavior of getting a delayed purchase (applicable to android only)...">IAPManager::TestDelayedIAP</a>( <span class="keywordtype">string</span> itemID, <span class="keywordtype">string</span> receipt, <span class="keywordtype">int</span> delayMS, <a class="code" href="classIAPManager.html#a223842c3fd3d0872d15c8a8bb0b08655" title="The result of a purchase process.">eReturnState</a> returnState <span class="comment">/*= RETURN_STATE_PURCHASED */</span> )
<a name="l00357"></a>00357 {
<a name="l00358"></a>00358         <a class="code" href="classVariantList.html">VariantList</a> vList( (<a class="code" href="PlatformSetupAndroid_8h.html#acbd4acd0d29e2d6c43104827f77d9cd2">uint32</a>)returnState, receipt, itemID);
<a name="l00359"></a>00359         <a class="code" href="BaseApp_8h.html#a11454091168162d8f3991461725aa24f">GetMessageManager</a>()-&gt;<a class="code" href="classMessageManager.html#a3a3722ea05eed26244a860bc6c8b81b1">CallEntityFunction</a>(&amp;<a class="code" href="classIAPManager.html#a7d5785f5e0b31400d7fcd7f6e70c11ea">m_entity</a>, delayMS, <span class="stringliteral">&quot;OnUnexpectedPurchase&quot;</span>, &amp;vList, <a class="code" href="MessageManager_8h.html#a6ccdae1e5bdcea24cc3c7a814445e196a1f41a724a7ed2283070514f600166e04">TIMER_SYSTEM</a>);
<a name="l00360"></a>00360 }
</pre></div></div><!-- contents -->


<hr class="footer"/><address class="footer"><small>
Generated on Thu May 2 2013 17:17:09 for Proton by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
